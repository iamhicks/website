<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mind — Demo Mode</title>
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/all.css">
    <style>
        /* ==================== NOTION-INSPIRED THEME ==================== */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --bg-tertiary: #e8e8ed;
            --bg-sidebar: #f5f5f7;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #86868b;
            --accent: #2eaadc;
            --accent-hover: #2596c4;
            --border: rgba(0, 0, 0, 0.1);
            --shadow: rgba(0, 0, 0, 0.08);
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --tag-bg: #e8e8ed;
            --tag-text: #1d1d1f;
            --sidebar-width: 280px;
            --header-height: 50px;
            --bottom-nav-height: 60px;
            --transition: 0.2s ease;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-mono: 'SF Mono', Monaco, monospace;
            --radius: 8px;
            --radius-sm: 6px;
        }

        [data-theme="dark"] {
            --bg-primary: #191919;
            --bg-secondary: #202020;
            --bg-tertiary: #2a2a2a;
            --bg-sidebar: #202020;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-tertiary: #666666;
            --accent: #2eaadc;
            --accent-hover: #2596c4;
            --border: #333333;
            --shadow: rgba(0, 0, 0, 0.3);
            --tag-bg: #2a2a2a;
            --tag-text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* ==================== DEMO BANNER ==================== */
        .demo-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #2eaadc 0%, #1a7a9e 100%);
            color: white;
            padding: 10px 16px;
            z-index: 10000;
            font-size: 13px;
            font-weight: 500;
        }

        .demo-banner-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .demo-reset-timer {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 12px;
        }

        .demo-banner-link {
            color: white;
            text-decoration: none;
            margin-left: auto;
            opacity: 0.9;
        }

        /* ==================== APP LAYOUT ==================== */
        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
            padding-top: 40px;
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform var(--transition);
            z-index: 100;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .sidebar-search {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .sidebar-section {
            margin-bottom: 4px;
        }

        .section-header {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-tertiary);
            letter-spacing: 0.5px;
        }

        .section-header:hover {
            background: var(--bg-tertiary);
        }

        .section-toggle {
            transition: transform var(--transition);
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 4px 0;
        }

        .section-content.collapsed {
            display: none;
        }

        /* ==================== FOLDER TREE ==================== */
        .folder-tree, .bookmark-list {
            list-style: none;
        }

        .folder-item, .bookmark-item {
            position: relative;
        }

        .folder-header, .bookmark-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background var(--transition);
        }

        .folder-header:hover, .bookmark-item:hover {
            background: var(--bg-tertiary);
        }

        .folder-header.active {
            background: var(--accent);
            color: white;
        }

        .folder-toggle {
            font-size: 10px;
            transition: transform var(--transition);
        }

        .folder-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .folder-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .folder-count {
            font-size: 11px;
            color: var(--text-tertiary);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .folder-header.active .folder-count {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* ==================== BOOKMARKS ==================== */
        .bookmark-item {
            padding-left: 24px;
        }

        .bookmark-item i {
            color: var(--accent);
        }

        /* ==================== SIDEBAR ACTIONS ==================== */
        .sidebar-actions {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all var(--transition);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            flex: 1;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-icon {
            padding: 8px;
            aspect-ratio: 1;
        }

        /* ==================== MAIN CONTENT ==================== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-header {
            height: var(--header-height);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-primary);
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .header-title {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ==================== EDITOR CONTAINER ==================== */
        .editor-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--accent);
        }

        .empty-state-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        /* ==================== TABS BAR ==================== */
        .tabs-bar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .tabs-bar.hidden {
            display: none;
        }

        .sidebar-toggle-tab {
            padding: 6px 10px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
        }

        .sidebar-toggle-tab:hover {
            background: var(--bg-tertiary);
        }

        .tabs-container {
            display: flex;
            gap: 4px;
            flex: 1;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            font-size: 13px;
            cursor: pointer;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
        }

        .tab.active {
            background: var(--accent);
            color: white;
        }

        .tab-close {
            opacity: 0.5;
            cursor: pointer;
        }

        .tab-close:hover {
            opacity: 1;
        }

        .new-tab-btn {
            padding: 6px 10px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
        }

        .new-tab-btn:hover {
            background: var(--bg-tertiary);
        }

        /* ==================== EDITOR TOOLBAR ==================== */
        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .editor-toolbar.hidden {
            display: none;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 4px;
            padding-right: 8px;
            border-right: 1px solid var(--border);
        }

        .toolbar-group:last-child {
            border-right: none;
            margin-left: auto;
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all var(--transition);
        }

        .toolbar-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .toolbar-btn.ai-btn {
            width: auto;
            padding: 0 12px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            font-weight: 600;
        }

        .toolbar-btn.ai-btn:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
        }

        /* ==================== EDITOR CONTENT ==================== */
        .editor-content-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
        }

        .editor-content-wrapper.hidden {
            display: none;
        }

        .editor-content {
            width: 100%;
            max-width: 800px;
        }

        .editor-content.full-width {
            max-width: 100%;
        }

        .note-title-input {
            width: 100%;
            font-size: 32px;
            font-weight: 700;
            border: none;
            background: transparent;
            color: var(--text-primary);
            margin-bottom: 16px;
            outline: none;
        }

        .note-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .note-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .note-tags-input {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--tag-bg);
            border-radius: 4px;
            font-size: 12px;
            color: var(--tag-text);
        }

        .tag-input {
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 12px;
            outline: none;
            min-width: 60px;
        }

        .wysiwyg-editor {
            min-height: 400px;
            font-size: 16px;
            line-height: 1.6;
            outline: none;
        }

        .wysiwyg-editor.small-text {
            font-size: 14px;
        }

        .wysiwyg-editor h1 { font-size: 28px; font-weight: 700; margin: 24px 0 16px; }
        .wysiwyg-editor h2 { font-size: 24px; font-weight: 600; margin: 20px 0 12px; }
        .wysiwyg-editor h3 { font-size: 20px; font-weight: 600; margin: 16px 0 8px; }
        .wysiwyg-editor p { margin-bottom: 12px; }
        .wysiwyg-editor ul, .wysiwyg-editor ol { margin: 12px 0; padding-left: 24px; }
        .wysiwyg-editor blockquote {
            border-left: 4px solid var(--accent);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-secondary);
        }
        .wysiwyg-editor code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 14px;
        }
        .wysiwyg-editor pre {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: var(--radius);
            overflow-x: auto;
            margin: 16px 0;
        }
        .wysiwyg-editor pre code {
            background: none;
            padding: 0;
        }

        /* ==================== MODALS ==================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: var(--radius);
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform var(--transition);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--accent);
        }

        /* ==================== UTILITY ==================== */
        .hidden { display: none !important; }

        ::selection {
            background: var(--accent);
            color: white;
        }

        /* ==================== MOBILE NAV ==================== */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            z-index: 99;
        }

        .mobile-nav-items {
            display: flex;
            height: 100%;
        }

        .mobile-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .mobile-nav-item.active {
            color: var(--accent);
        }

        .mobile-nav-icon {
            font-size: 20px;
        }

        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .mobile-nav { display: flex; }
            .editor-content-wrapper { padding-bottom: 80px; }
            .hide-mobile { display: none !important; }
        }

        @media (min-width: 769px) {
            .hide-desktop { display: none !important; }
        }
    </style>
</head>
<body>
    <!-- Demo Banner -->
    <div class="demo-banner">
        <div class="demo-banner-content">
            <i class="ph ph-clock"></i>
            <span>Demo Mode — Resets every hour</span>
            <span class="demo-reset-timer" id="demoResetTimer"></span>
            <a href="/" class="demo-banner-link"><i class="ph ph-arrow-left"></i> Back to Website</a>
        </div>
    </div>

    <!-- App -->
    <div id="app">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon"><i class="ph ph-brain"></i></div>
                    <span>Mind</span>
                </div>
            </div>

            <div class="sidebar-search">
                <input type="text" class="search-input" id="searchInput" placeholder="Search notes...">
            </div>

            <div class="sidebar-content" id="sidebarContent">
                <!-- Content injected by JS -->
            </div>

            <div class="sidebar-actions">
                <button class="btn btn-primary" id="newNoteBtn">
                    <i class="ph ph-plus"></i> New Note
                </button>
                <button class="btn btn-icon" id="settingsBtn">
                    <i class="ph ph-gear"></i>
                </button>
            </div>
        </aside>

        <!-- Main -->
        <main class="main">
            <!-- Tabs Bar -->
            <div class="tabs-bar hidden" id="tabsBar">
                <div class="sidebar-toggle-tab" id="sidebarToggleTab">
                    <i class="ph ph-sidebar"></i>
                </div>
                <div class="tabs-container" id="tabsContainer"></div>
                <div class="new-tab-btn" id="newTabBtn">
                    <i class="ph ph-plus"></i>
                </div>
            </div>

            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <button class="btn btn-icon hide-desktop" id="menuBtn">
                        <i class="ph ph-list"></i>
                    </button>
                    <div class="breadcrumb" id="breadcrumb">
                        <span>All Notes</span>
                    </div>
                </div>
                <div class="header-right">
                    <span class="header-title" id="headerTitle">Select a note</span>
                    <button class="btn btn-icon" id="themeBtn" title="Toggle theme">
                        <i class="ph ph-moon"></i>
                    </button>
                    <button class="btn btn-icon hide-mobile" id="focusBtn" title="Focus mode">
                        <i class="ph ph-corners-out"></i>
                    </button>
                    <button class="btn btn-icon" id="moreBtn" title="More options">
                        <i class="ph ph-dots-three"></i>
                    </button>
                </div>
            </header>

            <!-- Editor -->
            <div class="editor-container" id="editorContainer">
                <!-- Empty State -->
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon"><i class="ph ph-brain"></i></div>
                    <div class="empty-state-title">Welcome to Mind</div>
                    <div class="empty-state-desc">
                        Your private, offline knowledge base.<br>
                        Create your first note to get started.
                    </div>
                    <button class="btn btn-primary" id="emptyNewNoteBtn">
                        <i class="ph ph-plus"></i> Create First Note
                    </button>
                </div>

                <!-- Editor Toolbar -->
                <div class="editor-toolbar hidden" id="editorToolbar">
                    <div class="toolbar-group">
                        <button class="toolbar-btn" data-command="bold" title="Bold"><i class="ph ph-text-b"></i></button>
                        <button class="toolbar-btn" data-command="italic" title="Italic"><i class="ph ph-text-italic"></i></button>
                        <button class="toolbar-btn" data-command="underline" title="Underline"><i class="ph ph-text-underline"></i></button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" data-command="formatBlock" data-value="H1" title="Heading 1">H1</button>
                        <button class="toolbar-btn" data-command="formatBlock" data-value="H2" title="Heading 2">H2</button>
                        <button class="toolbar-btn" data-command="formatBlock" data-value="H3" title="Heading 3">H3</button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" data-command="insertUnorderedList" title="Bullet list"><i class="ph ph-list-bullets"></i></button>
                        <button class="toolbar-btn" data-command="insertOrderedList" title="Numbered list"><i class="ph ph-list-numbers"></i></button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn ai-btn" id="aiAssistBtn">
                            <i class="ph ph-sparkle"></i> AI
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" id="moreOptionsBtn" title="More"><i class="ph ph-dots-three"></i></button>
                    </div>
                </div>

                <!-- Editor Content -->
                <div class="editor-content-wrapper hidden" id="editorContentWrapper">
                    <div class="editor-content" id="editorContent">
                        <input type="text" class="note-title-input" id="noteTitle" placeholder="Note Title">
                        <div class="note-meta">
                            <div class="note-meta-item">
                                <i class="ph ph-calendar-blank"></i>
                                <span id="noteDate">Created today</span>
                            </div>
                            <div class="note-meta-item">
                                <i class="ph ph-tag"></i>
                                <div class="note-tags-input" id="noteTagsInput">
                                    <input type="text" class="tag-input" id="tagInput" placeholder="Add tag...">
                                </div>
                            </div>
                        </div>
                        <div class="wysiwyg-editor" id="wysiwygEditor" contenteditable="true"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Nav -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <div class="mobile-nav-item active" data-view="notes">
                <div class="mobile-nav-icon"><i class="ph ph-notebook"></i></div>
                <span>Notes</span>
            </div>
            <div class="mobile-nav-item" data-view="folders">
                <div class="mobile-nav-icon"><i class="ph ph-folder"></i></div>
                <span>Folders</span>
            </div>
            <div class="mobile-nav-item" data-view="tags">
                <div class="mobile-nav-icon"><i class="ph ph-tag"></i></div>
                <span>Tags</span>
            </div>
            <div class="mobile-nav-item" data-view="search">
                <div class="mobile-nav-icon"><i class="ph ph-magnifying-glass"></i></div>
                <span>Search</span>
            </div>
        </div>
    </nav>

    <!-- New Note Modal -->
    <div class="modal-overlay" id="newNoteModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create New Note</div>
                <button class="modal-close" id="closeNewNoteModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Note Title</label>
                    <input type="text" class="form-input" id="newNoteTitle" placeholder="Enter note title..." autofocus>
                </div>
                <div class="form-group">
                    <label class="form-label">Folder</label>
                    <select class="form-select" id="newNoteFolder"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelNewNote">Cancel</button>
                <button class="btn btn-primary" id="confirmNewNote">Create</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ==================== KNOWLEDGE BASE APP ====================
        class KnowledgeBase {
            constructor() {
                this.data = {
                    folders: [],
                    notes: [],
                    settings: {
                        theme: 'auto',
                        sidebarCollapsed: {},
                        favoriteFolders: [],
                        sidebarWidth: 280
                    }
                };
                this.currentFolder = 'root';
                this.currentNote = null;
                this.openTabs = [];
                this.activeTabId = null;
                this.draggedNote = null;
                this.draggedFolder = null;
                
                this.init();
            }
            
            init() {
                this.loadData();
                this.setupEventListeners();
                this.render();
                this.applyTheme();
                this.setupAutoSave();
            }
            
            loadData() {
                const saved = localStorage.getItem('mind_data');
                if (saved) {
                    this.data = JSON.parse(saved);
                } else {
                    this.createWelcomeData();
                }
            }
            
            saveData() {
                localStorage.setItem('mind_data', JSON.stringify(this.data));
            }
            
            createWelcomeData() {
                // Default folder
                this.data.folders.push({
                    id: 'root',
                    name: 'All Notes',
                    parentId: null,
                    createdAt: Date.now()
                });
                
                // Welcome note
                this.data.notes.push({
                    id: 'note_welcome',
                    title: 'Welcome to Mind',
                    content: '<h1>Welcome to Mind</h1><p>This is your private, offline knowledge base.</p><ul><li>Create notes and organize them in folders</li><li>Use the AI assistant for help</li><li>Import from Notion or Obsidian</li><li>Everything stays on your device</li></ul>',
                    folderId: 'root',
                    tags: ['welcome', 'getting-started'],
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    versions: []
                });
                
                this.saveData();
            }
            
            setupEventListeners() {
                // New note
                document.getElementById('newNoteBtn')?.addEventListener('click', () => this.openNewNoteModal());
                document.getElementById('emptyNewNoteBtn')?.addEventListener('click', () => this.openNewNoteModal());
                document.getElementById('confirmNewNote')?.addEventListener('click', () => this.createNewNote());
                document.getElementById('cancelNewNote')?.addEventListener('click', () => this.closeModal('newNoteModal'));
                document.getElementById('closeNewNoteModal')?.addEventListener('click', () => this.closeModal('newNoteModal'));
                
                // Theme
                document.getElementById('themeBtn')?.addEventListener('click', () => this.toggleTheme());
                
                // Mobile menu
                document.getElementById('menuBtn')?.addEventListener('click', () => this.toggleSidebar());
                document.getElementById('sidebarOverlay')?.addEventListener('click', () => this.closeSidebar());
                document.getElementById('sidebarToggleTab')?.addEventListener('click', () => this.toggleSidebar());
                
                // Tag input
                document.getElementById('tagInput')?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.addTag(e.target.value);
                        e.target.value = '';
                    }
                });
                
                // Search
                document.getElementById('searchInput')?.addEventListener('input', (e) => this.handleSearch(e.target.value));
            }
            
            openNewNoteModal() {
                this.populateFolderSelect();
                document.getElementById('newNoteModal').classList.add('active');
                document.getElementById('newNoteTitle').focus();
            }
            
            closeModal(id) {
                document.getElementById(id).classList.remove('active');
            }
            
            populateFolderSelect() {
                const select = document.getElementById('newNoteFolder');
                select.innerHTML = this.data.folders
                    .filter(f => f.id !== 'root')
                    .map(f => `<option value="${f.id}">${f.name}</option>`)
                    .join('');
                if (select.innerHTML) {
                    select.value = this.currentFolder !== 'root' ? this.currentFolder : select.options[0].value;
                }
            }
            
            createNewNote() {
                const title = document.getElementById('newNoteTitle').value.trim();
                const folderId = document.getElementById('newNoteFolder').value || 'root';
                
                if (!title) return;
                
                const note = {
                    id: 'note_' + Date.now(),
                    title: title,
                    content: '',
                    folderId: folderId,
                    tags: [],
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    versions: []
                };
                
                this.data.notes.push(note);
                this.saveData();
                this.closeModal('newNoteModal');
                document.getElementById('newNoteTitle').value = '';
                
                this.openNote(note.id);
                this.render();
            }
            
            openNote(id) {
                const note = this.data.notes.find(n => n.id === id);
                if (!note) return;
                
                // Add to tabs if not already open
                if (!this.openTabs.includes(id)) {
                    this.openTabs.push(id);
                }
                this.activeTabId = id;
                this.currentNote = note;
                this.currentFolder = note.folderId;
                
                this.renderTabs();
                this.loadNoteIntoEditor(note);
            }
            
            loadNoteIntoEditor(note) {
                // Show editor, hide empty state
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('editorToolbar').classList.remove('hidden');
                document.getElementById('tabsBar').classList.remove('hidden');
                document.getElementById('editorContentWrapper').classList.remove('hidden');
                
                // Load content
                document.getElementById('noteTitle').value = note.title;
                document.getElementById('wysiwygEditor').innerHTML = note.content;
                document.getElementById('headerTitle').textContent = 'Editing';
                
                // Update date
                const date = new Date(note.updatedAt);
                document.getElementById('noteDate').textContent = 
                    'Updated ' + date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Render tags
                this.renderTags();
                
                // Update active states
                this.updateActiveStates();
            }
            
            renderTabs() {
                const container = document.getElementById('tabsContainer');
                container.innerHTML = this.openTabs.map(noteId => {
                    const note = this.data.notes.find(n => n.id === noteId);
                    if (!note) return '';
                    const isActive = noteId === this.activeTabId;
                    return `
                        <div class="tab ${isActive ? 'active' : ''}" data-note-id="${noteId}">
                            <span>${this.escapeHtml(note.title || 'Untitled')}</span>
                            <i class="ph ph-x tab-close" data-note-id="${noteId}"></i>
                        </div>
                    `;
                }).join('');
                
                // Tab click handlers
                container.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        if (e.target.classList.contains('tab-close')) {
                            e.stopPropagation();
                            this.closeTab(tab.dataset.noteId);
                        } else {
                            this.openNote(tab.dataset.noteId);
                        }
                    });
                });
            }
            
            closeTab(noteId) {
                this.openTabs = this.openTabs.filter(id => id !== noteId);
                if (this.activeTabId === noteId) {
                    this.activeTabId = this.openTabs[this.openTabs.length - 1] || null;
                    if (this.activeTabId) {
                        this.openNote(this.activeTabId);
                    } else {
                        this.showEmptyState();
                    }
                }
                this.renderTabs();
            }
            
            showEmptyState() {
                this.currentNote = null;
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('editorToolbar').classList.add('hidden');
                document.getElementById('editorContentWrapper').classList.add('hidden');
                if (this.openTabs.length === 0) {
                    document.getElementById('tabsBar').classList.add('hidden');
                }
            }
            
            renderTags() {
                const container = document.getElementById('noteTagsInput');
                const input = document.getElementById('tagInput');
                
                // Clear existing tags (keep input)
                container.querySelectorAll('.tag').forEach(t => t.remove());
                
                if (this.currentNote) {
                    this.currentNote.tags.forEach(tag => {
                        const tagEl = document.createElement('span');
                        tagEl.className = 'tag';
                        tagEl.innerHTML = `${this.escapeHtml(tag)} <i class="ph ph-x" data-tag="${tag}"></i>`;
                        container.insertBefore(tagEl, input);
                        
                        tagEl.querySelector('i').addEventListener('click', () => this.removeTag(tag));
                    });
                }
            }
            
            addTag(tag) {
                tag = tag.trim();
                if (!tag || !this.currentNote) return;
                if (this.currentNote.tags.includes(tag)) return;
                
                this.currentNote.tags.push(tag);
                this.saveData();
                this.renderTags();
            }
            
            removeTag(tag) {
                if (!this.currentNote) return;
                this.currentNote.tags = this.currentNote.tags.filter(t => t !== tag);
                this.saveData();
                this.renderTags();
            }
            
            render() {
                this.renderSidebar();
                this.updateActiveStates();
            }
            
            renderSidebar() {
                const content = document.getElementById('sidebarContent');
                
                let html = '';
                
                // Favorites section
                if (this.data.settings.favoriteFolders?.length > 0) {
                    html += `
                        <div class="sidebar-section">
                            <div class="section-header" data-section="favorites">
                                <span>Favorites</span>
                                <span class="section-toggle">▼</span>
                            </div>
                            <div class="section-content" id="favoritesSection">
                                <ul class="folder-tree">
                                    ${this.data.settings.favoriteFolders.map(folderId => {
                                        const folder = this.data.folders.find(f => f.id === folderId);
                                        return folder ? `
                                            <li class="folder-item">
                                                <div class="folder-header ${this.currentFolder === folder.id ? 'active' : ''}" data-folder="${folder.id}">
                                                    <i class="ph ph-star"></i>
                                                    <span class="folder-name">${this.escapeHtml(folder.name)}</span>
                                                </div>
                                            </li>
                                        ` : '';
                                    }).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // Folders section
                html += `
                    <div class="sidebar-section">
                        <div class="section-header" data-section="folders">
                            <span>Folders</span>
                            <div class="section-actions">
                                <button class="btn btn-icon" id="addFolderBtn" style="padding: 2px 6px; font-size: 12px;">
                                    <i class="ph ph-plus"></i>
                                </button>
                                <span class="section-toggle">▼</span>
                            </div>
                        </div>
                        <div class="section-content" id="foldersSection">
                            <ul class="folder-tree" id="folderTree"></ul>
                        </div>
                    </div>
                `;
                
                // Tags section
                const allTags = [...new Set(this.data.notes.flatMap(n => n.tags))];
                if (allTags.length > 0) {
                    html += `
                        <div class="sidebar-section">
                            <div class="section-header" data-section="tags">
                                <span>Tags</span>
                                <span class="section-toggle">▼</span>
                            </div>
                            <div class="section-content" id="tagsSection">
                                <div class="tags-cloud" style="padding: 8px 16px; display: flex; flex-wrap: wrap; gap: 6px;">
                                    ${allTags.map(tag => `
                                        <span class="tag" style="cursor: pointer;" data-tag="${tag}">${this.escapeHtml(tag)}</span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = html;
                
                // Render folder tree
                this.renderFolderTree();
                
                // Section toggle handlers
                content.querySelectorAll('.section-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        if (e.target.closest('.section-actions')) return;
                        const section = header.dataset.section;
                        const contentEl = document.getElementById(section + 'Section');
                        const toggle = header.querySelector('.section-toggle');
                        if (contentEl) {
                            contentEl.classList.toggle('collapsed');
                            toggle?.classList.toggle('collapsed');
                        }
                    });
                });
                
                // Add folder button
                document.getElementById('addFolderBtn')?.addEventListener('click', () => this.createFolder());
            }
            
            renderFolderTree() {
                const tree = document.getElementById('folderTree');
                if (!tree) return;
                
                const renderFolder = (parentId, level = 0) => {
                    const folders = this.data.folders.filter(f => f.parentId === parentId && f.id !== 'root');
                    if (folders.length === 0) return '';
                    
                    return folders.map(folder => {
                        const noteCount = this.data.notes.filter(n => n.folderId === folder.id).length;
                        const hasChildren = this.data.folders.some(f => f.parentId === folder.id);
                        const isCollapsed = this.data.settings.sidebarCollapsed?.[folder.id];
                        
                        return `
                            <li class="folder-item">
                                <div class="folder-header ${this.currentFolder === folder.id ? 'active' : ''}" 
                                     data-folder="${folder.id}"
                                     style="padding-left: ${8 + level * 16}px">
                                    ${hasChildren ? `<span class="folder-toggle ${isCollapsed ? 'collapsed' : ''}">▼</span>` : '<span class="folder-toggle" style="visibility: hidden;">▼</span>'}
                                    <i class="ph ph-folder"></i>
                                    <span class="folder-name">${this.escapeHtml(folder.name)}</span>
                                    ${noteCount > 0 ? `<span class="folder-count">${noteCount}</span>` : ''}
                                </div>
                                ${hasChildren && !isCollapsed ? `
                                    <ul class="folder-tree" style="padding-left: 16px;">
                                        ${renderFolder(folder.id, level + 1)}
                                    </ul>
                                ` : ''}
                            </li>
                        `;
                    }).join('');
                };
                
                tree.innerHTML = renderFolder('root');
                
                // Folder click handlers
                tree.querySelectorAll('.folder-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        if (e.target.classList.contains('folder-toggle')) {
                            // Toggle collapse
                            const folderId = header.dataset.folder;
                            if (!this.data.settings.sidebarCollapsed) {
                                this.data.settings.sidebarCollapsed = {};
                            }
                            this.data.settings.sidebarCollapsed[folderId] = !this.data.settings.sidebarCollapsed[folderId];
                            this.saveData();
                            this.renderSidebar();
                        } else {
                            // Select folder
                            this.selectFolder(header.dataset.folder);
                        }
                    });
                });
            }
            
            selectFolder(folderId) {
                this.currentFolder = folderId;
                this.render();
                // On mobile, close sidebar
                if (window.innerWidth <= 768) {
                    this.closeSidebar();
                }
            }
            
            createFolder() {
                const name = prompt('Folder name:');
                if (!name?.trim()) return;
                
                const folder = {
                    id: 'folder_' + Date.now(),
                    name: name.trim(),
                    parentId: this.currentFolder !== 'root' ? this.currentFolder : null,
                    createdAt: Date.now()
                };
                
                this.data.folders.push(folder);
                this.saveData();
                this.render();
            }
            
            updateActiveStates() {
                // Update folder active states
                document.querySelectorAll('.folder-header').forEach(el => {
                    el.classList.toggle('active', el.dataset.folder === this.currentFolder);
                });
            }
            
            toggleSidebar() {
                document.getElementById('sidebar').classList.toggle('open');
                document.getElementById('sidebarOverlay').classList.toggle('active');
            }
            
            closeSidebar() {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebarOverlay').classList.remove('active');
            }
            
            toggleTheme() {
                const themes = ['light', 'dark', 'auto'];
                const current = this.data.settings.theme;
                const next = themes[(themes.indexOf(current) + 1) % themes.length];
                this.data.settings.theme = next;
                this.applyTheme();
                this.saveData();
            }
            
            applyTheme() {
                const theme = this.data.settings.theme;
                if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
            }
            
            handleSearch(query) {
                if (!query.trim()) {
                    this.renderFolderTree();
                    return;
                }
                
                const lowerQuery = query.toLowerCase();
                const matchingNotes = this.data.notes.filter(n => 
                    n.title.toLowerCase().includes(lowerQuery) ||
                    n.content.toLowerCase().includes(lowerQuery) ||
                    n.tags.some(t => t.toLowerCase().includes(lowerQuery))
                );
                
                // Could show search results in a dropdown
                console.log('Search results:', matchingNotes);
            }
            
            setupAutoSave() {
                let timeout;
                const editor = document.getElementById('wysiwygEditor');
                const titleInput = document.getElementById('noteTitle');
                
                const save = () => {
                    if (!this.currentNote) return;
                    
                    // Save version before updating
                    this.saveVersion();
                    
                    this.currentNote.content = editor.innerHTML;
                    this.currentNote.title = titleInput.value;
                    this.currentNote.updatedAt = Date.now();
                    this.saveData();
                    this.renderTabs();
                };
                
                editor?.addEventListener('input', () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(save, 1000);
                });
                
                titleInput?.addEventListener('input', () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(save, 500);
                });
            }
            
            // ==================== VERSION HISTORY ====================
            saveVersion() {
                if (!this.currentNote) return;
                
                if (!this.currentNote.versions) {
                    this.currentNote.versions = [];
                }
                
                // Only save if content changed
                const lastVersion = this.currentNote.versions[this.currentNote.versions.length - 1];
                if (lastVersion && lastVersion.content === this.currentNote.content) {
                    return;
                }
                
                this.currentNote.versions.push({
                    content: this.currentNote.content,
                    title: this.currentNote.title,
                    timestamp: Date.now()
                });
                
                // Keep only last 50 versions
                if (this.currentNote.versions.length > 50) {
                    this.currentNote.versions.shift();
                }
            }
            
            restoreVersion(index) {
                if (!this.currentNote || !this.currentNote.versions[index]) return;
                
                const version = this.currentNote.versions[index];
                this.currentNote.content = version.content;
                this.currentNote.title = version.title;
                this.currentNote.updatedAt = Date.now();
                
                document.getElementById('noteTitle').value = version.title;
                document.getElementById('wysiwygEditor').innerHTML = version.content;
                
                this.saveData();
            }
            
            // ==================== BOOKMARKS ====================
            toggleBookmark() {
                if (!this.currentNote) return;
                this.currentNote.bookmarked = !this.currentNote.bookmarked;
                this.saveData();
                this.render();
                return this.currentNote.bookmarked;
            }
            
            // ==================== CLIP WEBPAGE ====================
            async clipWebpage(url) {
                try {
                    const response = await fetch(`https://r.jina.ai/http://${url.replace(/^https?:\/\//, '')}`);
                    if (!response.ok) throw new Error('Failed to fetch');
                    
                    const text = await response.text();
                    
                    const note = {
                        id: 'note_' + Date.now(),
                        title: 'Clipped: ' + url,
                        content: `<h1>${url}</h1><p><em>Clipped from: <a href="${url}" target="_blank">${url}</a></em></p><hr>${text.replace(/\n/g, '<br>')}`,
                        folderId: this.currentFolder || 'root',
                        tags: ['clipped'],
                        clippedFrom: url,
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        versions: []
                    };
                    
                    this.data.notes.push(note);
                    this.saveData();
                    this.openNote(note.id);
                    this.render();
                    
                    return { success: true, note };
                } catch (err) {
                    return { success: false, error: err.message };
                }
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }
        
        // ==================== INITIALIZE ====================
        const app = new KnowledgeBase();
    </script>
</body>
</html>