<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mind</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* ==================== CSS VARIABLES & RESET ==================== */
        :root {
            /* Notion-inspired Light Theme */
            --bg-primary: #ffffff;
            --bg-secondary: #f7f6f3;
            --bg-tertiary: #f1f1ef;
            --bg-sidebar: #f7f6f3;
            --bg-hover: #efefef;
            --text-primary: #37352f;
            --text-secondary: #6b6b6b;
            --text-tertiary: #9b9b9b;
            --accent: #2eaadc;
            --accent-hover: #0077cc;
            --border: #e3e2e0;
            --border-hover: #d3d1cb;
            --shadow: rgba(15, 15, 15, 0.05);
            --success: #2ecc71;
            --warning: #f4d03f;
            --danger: #eb5757;
            --tag-bg: #f1f1ef;
            --tag-text: #37352f;
            --sidebar-width: 280px;
            --header-height: 50px;
            --bottom-nav-height: 60px;
            --transition: 0.15s ease;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            --radius: 3px;
            --radius-sm: 3px;
        }

        /* Phosphor Icons */
        .ph {
            font-size: 1.1em;
            vertical-align: middle;
            line-height: 1;
        }

        .ph-sm { font-size: 0.875em; }
        .ph-lg { font-size: 1.25em; }
        .ph-xl { font-size: 1.5em; }

        [data-theme="dark"] {
            /* Notion-inspired Dark Theme */
            --bg-primary: #191919;
            --bg-secondary: #202020;
            --bg-tertiary: #2d2d2d;
            --bg-sidebar: #202020;
            --bg-hover: #373737;
            --text-primary: #f5f5f5;
            --text-secondary: #9b9b9b;
            --text-tertiary: #6b6b6b;
            --accent: #2eaadc;
            --accent-hover: #5bc2e7;
            --border: #2d2d2d;
            --border-hover: #3d3d3d;
            --shadow: rgba(0, 0, 0, 0.4);
            --tag-bg: #2d2d2d;
            --tag-text: #f5f5f5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Utility classes */
        .hide-desktop {
            display: none !important;
        }

        /* ==================== APP LAYOUT ==================== */
        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* ==================== SIDEBAR ==================== */
        .sidebar {
            width: var(--sidebar-width);
            min-width: 200px;
            max-width: 500px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform var(--transition), width 0.1s ease;
            z-index: 100;
            position: relative;
        }

        .sidebar.collapsed {
            width: 0 !important;
            min-width: 0;
            border-right: none;
            overflow: hidden;
        }

        .sidebar-resize-handle {
            position: absolute;
            right: -3px;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: col-resize;
            z-index: 101;
            background: transparent;
            transition: background var(--transition);
        }

        .sidebar-resize-handle:hover,
        .sidebar-resize-handle.resizing {
            background: var(--accent);
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            height: var(--header-height);
            flex-shrink: 0;
        }

        .logo {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .sidebar-search {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all var(--transition);
        }

        .search-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(46, 170, 220, 0.2);
        }

        .search-input::placeholder {
            color: var(--text-tertiary);
        }

        /* Notion-style subtle inputs */
        .form-input, .form-select, .form-textarea {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            transition: all var(--transition);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(46, 170, 220, 0.2);
            outline: none;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .sidebar-section {
            margin-bottom: 8px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
            cursor: pointer;
            user-select: none;
        }

        .section-header:hover {
            color: var(--text-secondary);
        }

        .section-toggle {
            transition: transform var(--transition);
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .section-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-action-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 300;
            color: var(--text-tertiary);
            background: transparent;
            border: none;
            padding: 0;
            transition: all var(--transition);
        }

        .section-action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .section-content {
            padding-left: 4px;
        }

        .section-content.collapsed {
            display: none;
        }

        /* ==================== FOLDER TREE ==================== */
        .folder-tree {
            list-style: none;
        }

        .folder-item {
            position: relative;
        }

        .folder-header {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: all var(--transition);
            user-select: none;
            position: relative;
            min-height: 28px;
        }

        .folder-header:hover {
            background: var(--bg-hover);
        }

        .folder-header.active {
            background: rgba(46, 170, 220, 0.1);
            color: var(--accent);
            font-weight: 500;
        }

        .folder-header.drag-over {
            background: var(--accent) !important;
            color: white !important;
        }

        .folder-header[draggable="true"] {
            cursor: grab;
        }

        .folder-header[draggable="true"]:active {
            cursor: grabbing;
        }

        .folder-header:hover .folder-actions {
            opacity: 1;
            visibility: visible;
        }

        .folder-actions {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-left: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, visibility 0.15s ease;
        }

        .folder-action-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
            transition: all var(--transition);
            background: transparent;
            border: none;
            padding: 0;
        }

        .folder-action-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }

        [data-theme="dark"] .folder-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .folder-action-btn i {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .folder-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 4px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 4px 20px var(--shadow);
            min-width: 180px;
            z-index: 1000;
            padding: 4px;
            display: none;
        }

        .folder-dropdown.show {
            display: block;
        }

        .folder-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            color: var(--text-primary);
            transition: background var(--transition);
        }

        .folder-dropdown-item:hover {
            background: var(--bg-secondary);
        }

        .folder-dropdown-item.delete {
            color: var(--danger);
        }

        .folder-dropdown-item.delete:hover {
            background: rgba(255, 59, 48, 0.1);
        }

        .folder-dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        .folder-dropdown-icon {
            width: 16px;
            text-align: center;
            font-size: 14px;
        }

        .folder-header.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .folder-header.drag-over {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .folder-item.drag-over-top {
            border-top: 2px solid var(--accent);
        }

        .folder-item.drag-over-bottom {
            border-bottom: 2px solid var(--accent);
        }

        .folder-header.dragging {
            opacity: 0.5;
        }

        .folder-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: transform var(--transition);
            color: var(--text-secondary);
        }

        .folder-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .folder-icon {
            font-size: 14px;
            color: var(--accent);
        }

        .folder-header.active .folder-icon,
        .folder-header.drag-over .folder-icon {
            color: white;
        }

        .folder-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .folder-count {
            font-size: 11px;
            color: var(--text-tertiary);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .folder-header.active .folder-count,
        .folder-header.drag-over .folder-count {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .folder-children {
            padding-left: 20px;
            list-style: none;
        }

        .folder-children.collapsed {
            display: none;
        }

        .note-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 8px 5px 28px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all var(--transition);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            user-select: none;
        }

        .note-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .note-item.active {
            background: rgba(46, 170, 220, 0.1);
            color: var(--accent);
            font-weight: 500;
        }

        .note-item.dragging {
            opacity: 0.5;
        }

        .note-item[draggable="true"] {
            cursor: grab;
        }

        .note-item[draggable="true"]:active {
            cursor: grabbing;
        }

        .note-item .note-actions {
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
            margin-left: auto;
        }

        .note-item:hover .note-actions {
            opacity: 1;
            visibility: visible;
        }

        .note-action-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 14px;
            background: transparent;
            border: none;
            padding: 0;
        }

        .note-action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .note-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 120px;
            z-index: 100;
            display: none;
        }

        .note-dropdown.show {
            display: block;
        }

        .note-dropdown-item {
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            color: var(--text-primary);
            transition: background var(--transition);
        }

        .note-dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        .note-dropdown-item.delete {
            color: var(--danger);
        }

        /* ==================== BOOKMARKS ==================== */
        .bookmark-list {
            list-style: none;
        }

        .bookmark-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: all var(--transition);
            user-select: none;
        }

        .bookmark-item:hover {
            background: var(--bg-hover);
        }

        .bookmark-item .ph-bookmark {
            color: var(--accent);
        }

        /* ==================== NOTE MENU DROPDOWN ==================== */
        .note-menu-dropdown {
            position: absolute;
            top: 48px;
            right: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            min-width: 220px;
            z-index: 1000;
            display: none;
            padding: 8px 0;
        }

        .editor-container {
            position: relative;
        }

        .note-menu-dropdown.show {
            display: block;
        }

        .note-menu-fonts {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }

        .note-menu-font-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition);
            flex: 1;
        }

        .note-menu-font-option:hover {
            background: var(--bg-tertiary);
        }

        .note-menu-font-option.active {
            background: rgba(46, 170, 220, 0.1);
            color: var(--accent);
            font-weight: 500;
        }

        .note-menu-font-preview {
            font-size: 20px;
            line-height: 1;
        }

        .note-menu-font-preview.serif {
            font-family: Georgia, serif;
        }

        .note-menu-font-preview.mono {
            font-family: 'SF Mono', Monaco, monospace;
        }

        .note-menu-font-label {
            font-size: 11px;
        }

        .note-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            font-size: 13px;
            cursor: pointer;
            color: var(--text-primary);
            transition: background var(--transition);
        }

        .note-menu-item:hover {
            background: var(--bg-tertiary);
        }

        .note-menu-item.delete {
            color: var(--danger);
        }

        .note-menu-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            font-size: 13px;
            cursor: pointer;
            color: var(--text-primary);
            transition: background var(--transition);
        }

        .note-menu-toggle:hover {
            background: var(--bg-tertiary);
        }

        .note-menu-toggle-indicator {
            margin-left: auto;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .note-menu-toggle-indicator.on {
            color: var(--accent);
        }

        .note-menu-icon {
            font-size: 14px;
            width: 20px;
            text-align: center;
        }

        .note-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0;
        }

        /* AI Button highlight in toolbar */
        #aiSuggestBtn {
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-right: 4px;
        }

        #aiSuggestBtn:hover {
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }

        /* ==================== TABS BAR ==================== */
        .tabs-bar {
            display: flex;
            align-items: stretch;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            overflow: hidden;
            height: 40px;
        }

        .tabs-bar.hidden {
            display: none;
        }

        .sidebar-toggle-tab {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border);
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all var(--transition);
            flex-shrink: 0;
        }

        .sidebar-toggle-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tabs-container {
            display: flex;
            gap: 0;
            overflow-x: auto;
            scrollbar-width: none;
            align-items: stretch;
        }

        .tabs-container::-webkit-scrollbar {
            display: none;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
            background: transparent;
            border: none;
            border-right: 1px solid var(--border);
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            max-width: 200px;
            min-width: 120px;
            transition: all var(--transition);
            position: relative;
        }

        .tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 500;
        }

        .tab-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-close {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0;
            transition: all var(--transition);
        }

        .tab:hover .tab-close {
            opacity: 0.6;
        }

        .tab-close:hover {
            background: var(--bg-hover);
            opacity: 1 !important;
        }

        .tabs-new-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 12px;
            background: transparent;
            border: none;
            border-right: 1px solid var(--border);
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition);
            flex-shrink: 0;
        }

        .tabs-new-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tabs-spacer {
            flex: 1;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        /* ==================== VERSION HISTORY ==================== */
        .version-history-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
        }

        .version-history-panel.open {
            right: 0;
        }

        .version-history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .version-history-title {
            font-size: 16px;
            font-weight: 600;
        }

        .version-history-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-secondary);
            transition: all var(--transition);
        }

        .version-history-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .version-history-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .version-item {
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition);
            margin-bottom: 8px;
        }

        .version-item:hover {
            background: var(--bg-tertiary);
        }

        .version-item.active {
            background: rgba(46, 170, 220, 0.1);
            color: var(--accent);
        }

        .version-time {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .version-author {
            font-size: 12px;
            opacity: 0.7;
        }

        .version-history-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .version-preview {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-tertiary);
            max-height: 200px;
            overflow-y: auto;
        }

        .version-preview-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .version-preview-content {
            font-size: 13px;
            line-height: 1.5;
            color: var(--text-primary);
            white-space: pre-wrap;
        }

        /* Editor font options */
        #wysiwygEditor.font-serif {
            font-family: Georgia, 'Times New Roman', serif;
        }

        #wysiwygEditor.font-mono {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }

        #wysiwygEditor.small-text {
            font-size: 14px;
        }

        .editor-content.full-width {
            max-width: 100% !important;
        }

        /* Drop zones for folder drag/drop */
        .root-drop-zone {
            border: 2px dashed var(--border-color);
        }

        .root-drop-zone:hover {
            border-color: var(--accent);
        }

        .folder-reorder-zone {
            border: 2px dashed transparent;
        }

        .folder-reorder-zone:hover {
            border-color: var(--border-color);
        }

        .note-icon {
            font-size: 12px;
            flex-shrink: 0;
        }

        .note-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ==================== TAGS SECTION ==================== */
        .tags-search {
            padding: 8px;
        }

        .tags-search-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 12px;
            outline: none;
        }

        .tags-search-input:focus {
            border-color: var(--accent);
        }

        .tags-alphabetical {
            max-height: 300px;
            overflow-y: auto;
        }

        .tags-letter-group {
            margin-bottom: 4px;
        }

        .tags-letter-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            border-radius: var(--radius-sm);
        }

        .tags-letter-header:hover {
            background: var(--bg-tertiary);
        }

        .tags-letter-toggle {
            font-size: 10px;
            transition: transform var(--transition);
        }

        .tags-letter-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .tags-letter-content {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 4px 8px;
        }

        .tags-letter-content.collapsed {
            display: none;
        }

        .tag-item-small {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            background: var(--tag-bg);
            color: var(--tag-text);
            border-radius: 10px;
            font-size: 11px;
            cursor: pointer;
            transition: all var(--transition);
            user-select: none;
        }

        .tag-item-small:hover {
            background: var(--accent);
            color: white;
        }

        .tag-item-small.active {
            background: var(--accent);
            color: white;
        }

        .tags-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 4px 8px;
        }

        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--tag-bg);
            color: var(--tag-text);
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition);
            user-select: none;
        }

        .tag-item:hover {
            background: var(--accent);
            color: white;
        }

        .tag-item.active {
            background: var(--accent);
            color: white;
        }

        .tag-count {
            font-size: 10px;
            opacity: 0.7;
        }

        /* ==================== SIDEBAR ACTIONS ==================== */
        .sidebar-actions {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            outline: none;
            user-select: none;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            font-size: 14px;
            background: transparent;
        }

        .btn-flex {
            flex: 1;
        }

        /* ==================== MAIN CONTENT ==================== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            min-width: 0;
        }

        .main-header {
            height: var(--header-height);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-primary);
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-title {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .breadcrumb-item {
            cursor: pointer;
        }

        .breadcrumb-item:hover {
            color: var(--accent);
        }

        .breadcrumb-separator {
            opacity: 0.5;
        }

        /* ==================== EDITOR ==================== */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 0 4px;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .toolbar-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .toolbar-btn.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .toolbar-separator {
            width: 1px;
            height: 20px;
            background: var(--border);
            margin: 0 4px;
        }

        .editor-content-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 40px 20px;
        }

        /* Selection Toolbar */
        .selection-toolbar {
            position: absolute;
            display: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 6px 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            gap: 2px;
            align-items: center;
        }

        .selection-toolbar.visible {
            display: flex;
        }

        .selection-toolbar-btn {
            padding: 6px 10px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
            min-width: 32px;
            height: 32px;
        }

        .selection-toolbar-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .selection-toolbar-btn.ai {
            color: #fbbf24;
            font-weight: 500;
            padding: 6px 12px;
            gap: 6px;
        }

        .selection-toolbar-btn.ai:hover {
            background: #fbbf24;
            color: #191919;
        }

        .selection-toolbar-divider {
            width: 1px;
            height: 20px;
            background: var(--border);
            margin: 0 4px;
        }

        .editor-content {
            max-width: 800px;
            margin: 0 auto;
            min-height: 100%;
            position: relative;
        }

        .note-title-input {
            width: 100%;
            font-size: 40px;
            font-weight: 600;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding: 0;
            font-family: var(--font-sans);
            line-height: 1.2;
            letter-spacing: -0.5px;
        }

        .note-title-input::placeholder {
            color: var(--text-tertiary);
        }

        .note-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .note-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .note-tags-input {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            position: relative;
        }

        .note-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            background: var(--tag-bg);
            color: var(--tag-text);
            border-radius: 12px;
            font-size: 12px;
        }

        .note-tag-remove {
            cursor: pointer;
            opacity: 0.6;
        }

        .note-tag-remove:hover {
            opacity: 1;
        }

        .tag-input {
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 12px;
            padding: 3px 0;
            min-width: 80px;
        }

        .tag-input::placeholder {
            color: var(--text-tertiary);
        }

        .tag-autocomplete {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--accent);
            border-radius: var(--radius-sm);
            box-shadow: 0 4px 12px var(--shadow);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10000;
            margin-top: 4px;
            min-width: 120px;
            width: auto;
            white-space: nowrap;
        }

        .tag-autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .task-checkbox {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--text-tertiary);
            border-radius: 3px;
            background: transparent;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }

        .task-checkbox:checked {
            background: var(--accent);
            border-color: var(--accent);
        }

        .task-checkbox:checked::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 1px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .tag-autocomplete-item:hover,
        .tag-autocomplete-item.active {
            background: var(--bg-hover);
        }

        .tag-autocomplete-item i {
            color: var(--text-tertiary);
            font-size: 14px;
        }

        /* WYSIWYG Editor */
        .wysiwyg-editor {
            font-size: 16px;
            line-height: 1.7;
            color: var(--text-primary);
            outline: none;
            min-height: 400px;
            letter-spacing: -0.1px;
        }

        .wysiwyg-editor:empty:before {
            content: 'Type something...';
            color: var(--text-tertiary);
        }

        .wysiwyg-editor h1 {
            font-size: 30px;
            font-weight: 600;
            margin: 32px 0 16px;
            line-height: 1.3;
            letter-spacing: -0.5px;
        }

        .wysiwyg-editor h2 {
            font-size: 24px;
            font-weight: 600;
            margin: 28px 0 14px;
            line-height: 1.3;
            letter-spacing: -0.3px;
        }

        .wysiwyg-editor h3 {
            font-size: 20px;
            font-weight: 600;
            margin: 24px 0 12px;
            line-height: 1.3;
        }

        .wysiwyg-editor p {
            margin: 0 0 16px;
        }

        .wysiwyg-editor ul, .wysiwyg-editor ol {
            margin: 0 0 16px 24px;
            padding-left: 8px;
        }

        .wysiwyg-editor li {
            margin: 6px 0;
        }

        .wysiwyg-editor blockquote {
            border-left: 3px solid var(--border-hover);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-secondary);
        }

        .wysiwyg-editor a {
            color: var(--accent);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color var(--transition);
        }

        .wysiwyg-editor a:hover {
            border-bottom-color: var(--accent);
        }

        .wysiwyg-editor code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.9em;
            color: var(--text-primary);
        }

        .wysiwyg-editor pre {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: var(--radius);
            overflow-x: auto;
            margin: 16px 0;
        }

        .wysiwyg-editor pre code {
            background: none;
            padding: 0;
        }

        .wysiwyg-editor code {
            font-family: var(--font-mono);
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .wysiwyg-editor pre {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: var(--radius);
            overflow-x: auto;
            margin: 16px 0;
        }

        .wysiwyg-editor pre code {
            background: none;
            padding: 0;
        }

        .wysiwyg-editor a {
            color: var(--accent);
            text-decoration: none;
        }

        .wysiwyg-editor a:hover {
            text-decoration: underline;
        }

        .wysiwyg-editor img {
            max-width: 100%;
            border-radius: var(--radius);
            margin: 16px 0;
        }

        .wysiwyg-editor hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 24px 0;
        }

        .wysiwyg-editor table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }

        .wysiwyg-editor th, .wysiwyg-editor td {
            border: 1px solid var(--border);
            padding: 8px 12px;
            text-align: left;
        }

        .wysiwyg-editor th {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        .wysiwyg-editor .internal-link {
            color: var(--accent);
            background: rgba(0, 122, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
        }

        [data-theme="dark"] .wysiwyg-editor .internal-link {
            background: rgba(10, 132, 255, 0.2);
        }

        /* ==================== BACKLINKS PANEL ==================== */
        .backlinks-panel {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 16px 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .backlinks-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
            margin-bottom: 12px;
        }

        .backlinks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .backlink-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            transition: all var(--transition);
        }

        .backlink-item:hover {
            background: var(--bg-tertiary);
        }

        .backlink-icon {
            color: var(--text-tertiary);
        }

        /* ==================== EMPTY STATE ==================== */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            background: var(--bg-secondary);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin-bottom: 24px;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state-desc {
            font-size: 15px;
            max-width: 400px;
            margin-bottom: 24px;
        }

        /* ==================== MODALS ==================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: var(--radius);
            box-shadow: 0 20px 60px var(--shadow);
            width: 90%;
            max-width: 480px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform var(--transition);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 24px 24px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all var(--transition);
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
            font-size: 15px;
            line-height: 1.6;
        }

        .modal-footer {
            padding: 0 20px 20px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all var(--transition);
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        /* ==================== SEARCH RESULTS ==================== */
        .search-results {
            position: absolute;
            top: 100%;
            left: 16px;
            right: 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 10px 40px var(--shadow);
            max-height: 400px;
            overflow-y: auto;
            z-index: 200;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background var(--transition);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--bg-secondary);
        }

        .search-result-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .search-result-preview {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-meta {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        /* ==================== CONTEXT MENU ==================== */
        .context-menu {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 10px 40px var(--shadow);
            padding: 6px 0;
            min-width: 160px;
            z-index: 1000;
            display: none;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 8px 16px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background var(--transition);
        }

        .context-menu-item:hover {
            background: var(--bg-secondary);
        }

        .context-menu-item.danger {
            color: var(--danger);
        }

        .context-menu-separator {
            height: 1px;
            background: var(--border);
            margin: 6px 0;
        }

        /* ==================== MOBILE BOTTOM NAV ==================== */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            z-index: 100;
        }

        .mobile-nav-items {
            display: flex;
            height: 100%;
        }

        .mobile-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all var(--transition);
        }

        .mobile-nav-item.active {
            color: var(--accent);
        }

        .mobile-nav-icon {
            font-size: 20px;
        }

        .mobile-nav-label {
            font-size: 10px;
            font-weight: 500;
        }

        /* ==================== DISTRACTION FREE MODE ==================== */
        .distraction-free .sidebar,
        .distraction-free .main-header,
        .distraction-free .editor-toolbar,
        .distraction-free .backlinks-panel,
        .distraction-free .mobile-nav {
            display: none !important;
        }

        .distraction-free .main {
            position: fixed;
            inset: 0;
            z-index: 1000;
        }

        .distraction-free .editor-content-wrapper {
            padding: 60px 40px;
        }

        .distraction-free .editor-content {
            max-width: 720px;
        }

        .exit-distraction-free {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .distraction-free .exit-distraction-free {
            opacity: 1;
            pointer-events: auto;
        }

        .exit-distraction-free:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* ==================== TOAST NOTIFICATIONS ==================== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 10px 40px var(--shadow);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast-icon {
            font-size: 18px;
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error .toast-icon {
            color: var(--danger);
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        /* ==================== RESPONSIVE DESIGN ==================== */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100%;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: var(--bottom-nav-height);
                transform: translateX(-100%);
                width: 85%;
                max-width: 320px;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 99;
                opacity: 0;
                visibility: hidden;
                transition: all var(--transition);
            }

            .sidebar-overlay.active {
                opacity: 1;
                visibility: visible;
            }

            .mobile-nav {
                display: block;
            }

            .main {
                padding-bottom: var(--bottom-nav-height);
            }

            .editor-content-wrapper {
                padding: 20px 16px;
            }

            .note-title-input {
                font-size: 24px;
            }

            .wysiwyg-editor {
                font-size: 15px;
            }

            .wysiwyg-editor h1 {
                font-size: 22px;
            }

            .wysiwyg-editor h2 {
                font-size: 20px;
            }

            .wysiwyg-editor h3 {
                font-size: 18px;
            }

            .hide-mobile {
                display: none !important;
            }

            .hide-desktop {
                display: inline-flex !important;
            }
        }

        /* ==================== SCROLLBAR STYLING ==================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* ==================== SELECTION ==================== */
        ::selection {
            background: var(--accent);
            color: white;
        }

        /* ==================== UTILITY CLASSES ==================== */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Sidebar Overlay (Mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-resize-handle" id="sidebarResizeHandle"></div>
            
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon"><i class="ph ph-brain"></i></div>
                    <span>Mind</span>
                </div>
            </div>

            <div class="sidebar-search">
                <input type="text" class="search-input" id="searchInput" placeholder="Search notes...">
                <div class="search-results" id="searchResults"></div>
            </div>

            <div class="sidebar-content">
                <!-- Clipped Pages Section -->
                <div class="sidebar-section" id="clippedSectionContainer" style="display: none;">
                    <div class="section-header" data-section="clipped">
                        <span>Clipped Pages</span>
                        <span class="section-toggle"></span>
                    </div>
                    <div class="section-content" id="clippedSection">
                        <ul class="bookmark-list" id="clippedList"></ul>
                    </div>
                </div>

                <!-- Favorites Section -->
                <div class="sidebar-section" id="favoritesSectionContainer" style="display: none;">
                    <div class="section-header" data-section="favorites">
                        <span>Favorites</span>
                        <span class="section-toggle"></span>
                    </div>
                    <div class="section-content" id="favoritesSection">
                        <ul class="folder-tree" id="favoritesTree"></ul>
                    </div>
                </div>

                <!-- Folders Section -->
                <div class="sidebar-section">
                    <div class="section-header" data-section="folders">
                        <span>Folders</span>
                        <div class="section-actions">
                            <button class="section-action-btn add-folder" id="addFolderBtn" title="Add new folder">+</button>
                            <span class="section-toggle"></span>
                        </div>
                    </div>
                    <div class="section-content" id="foldersSection">
                        <ul class="folder-tree" id="folderTree"></ul>
                    </div>
                </div>

                <!-- Tags Section -->
                <div class="sidebar-section">
                    <div class="section-header" data-section="tags">
                        <span>Tags</span>
                        <span class="section-toggle"></span>
                    </div>
                    <div class="section-content" id="tagsSection">
                        <div class="tags-search">
                            <input type="text" class="tags-search-input" id="tagsSearch" placeholder="Search tags...">
                        </div>
                        <div class="tags-alphabetical" id="tagsAlphabetical"></div>
                    </div>
                </div>
            </div>

            <div class="sidebar-actions">
                <button class="btn btn-secondary btn-icon" id="settingsBtn" title="Settings">
                    <i class="ph ph-gear"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main" id="main">
            <header class="main-header">
                <div class="header-left">
                    <button class="btn btn-icon hide-desktop" id="menuBtn" title="Menu" style="color: var(--text-secondary);"><i class="ph ph-list"></i></button>
                    <div class="breadcrumb" id="breadcrumb">
                        <span class="breadcrumb-item" data-folder="root">All Notes</span>
                    </div>
                </div>
                <div class="header-right">
                    <span class="header-title" id="headerTitle"></span>
                    <button class="btn btn-icon" id="themeBtn" title="Toggle Theme" style="color: var(--text-secondary);"><i class="ph ph-moon"></i></button>
                </div>
            </header>

            <!-- AI Suggest Modal -->
            <div class="modal-overlay" id="aiSuggestModal">
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <div class="modal-title"><i class="ph ph-sparkle"></i> AI Suggest Edits</div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">What would you like help with?</label>
                            <select class="form-select" id="aiSuggestType">
                                <option value="improve">Improve writing</option>
                                <option value="summarize">Summarize content</option>
                                <option value="expand">Expand on key points</option>
                                <option value="fix">Fix grammar & spelling</option>
                                <option value="simplify">Simplify language</option>
                                <option value="custom">Custom request...</option>
                            </select>
                        </div>
                        <div class="form-group" id="aiCustomRequestGroup" style="display: none;">
                            <label class="form-label">Your request</label>
                            <textarea class="form-textarea" id="aiCustomRequest" rows="3" placeholder="e.g., Make this more professional, Add bullet points, Convert to meeting notes style..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Current content preview</label>
                            <div id="aiContentPreview" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); font-size: 13px; max-height: 150px; overflow-y: auto; color: var(--text-secondary);"></div>
                        </div>
                        <div class="form-group" id="aiResultGroup" style="display: none;">
                            <label class="form-label">Suggested edits</label>
                            <div id="aiResult" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); font-size: 13px; max-height: 200px; overflow-y: auto; white-space: pre-wrap;"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="closeAiSuggest">Cancel</button>
                        <button class="btn btn-primary" id="generateAiSuggest">Generate Suggestions</button>
                        <button class="btn btn-primary" id="applyAiSuggest" style="display: none;">Apply Changes</button>
                    </div>
                </div>
            </div>

            <!-- Clip Web Page Modal -->
            <div class="modal-overlay" id="clipWebpageModal">
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <div class="modal-title"><i class="ph ph-globe"></i> Clip Web Page</div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Enter URL to clip</label>
                            <input type="url" class="form-input" id="clipUrlInput" placeholder="https://example.com/article">
                        </div>
                        <div class="form-group" id="clipStatus" style="display: none;">
                            <div id="clipStatusText" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); font-size: 13px; color: var(--text-secondary);"></div>
                        </div>
                        <div class="form-group" style="font-size: 12px; color: var(--text-tertiary);">
                            <p><strong>Note:</strong> Due to browser security (CORS), clipping may not work for all websites. For best results, copy and paste content directly.</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="closeClipModal">Cancel</button>
                        <button class="btn btn-primary" id="clipWebpageAction">Clip Page</button>
                    </div>
                </div>
            </div>

            <!-- Import Wizard Modal -->
            <div class="modal-overlay" id="importWizardModal">
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <div class="modal-title"><i class="ph ph-upload-simple"></i> Import from Notion/Obsidian</div>
                        <button class="modal-close" id="closeImportWizard">&times;</button>
                    </div>
                    <div class="modal-body" id="importWizardBody">
                        <!-- Step 1: Choose Source -->
                        <div id="importStep1">
                            <div class="form-group">
                                <label class="form-label" style="font-size: 16px; margin-bottom: 16px;">Where are you importing from?</label>
                                <div style="display: flex; gap: 20px; margin-top: 16px;">
                                    <div class="import-source-option" data-source="notion" style="flex: 1; padding: 32px 24px; border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; text-align: center; transition: all 0.2s;">
                                        <div style="font-size: 40px; margin-bottom: 12px; color: var(--accent);"><i class="ph ph-file-text"></i></div>
                                        <div style="font-weight: 600; font-size: 18px; margin-bottom: 6px;">Notion</div>
                                        <div style="font-size: 14px; color: var(--text-secondary);">Export as Markdown</div>
                                    </div>
                                    <div class="import-source-option" data-source="obsidian" style="flex: 1; padding: 32px 24px; border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; text-align: center; transition: all 0.2s;">
                                        <div style="font-size: 40px; margin-bottom: 12px; color: var(--accent);"><i class="ph ph-notebook"></i></div>
                                        <div style="font-weight: 600; font-size: 18px; margin-bottom: 6px;">Obsidian</div>
                                        <div style="font-size: 14px; color: var(--text-secondary);">Vault ZIP export</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 2: Instructions -->
                        <div id="importStep2" style="display: none;">
                            <div class="form-group">
                                <label class="form-label" style="font-size: 16px; margin-bottom: 12px;">Export Instructions</label>
                                <div id="exportInstructions" style="padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius); font-size: 13px; line-height: 1.6;">
                                </div>
                            </div>
                            <div class="form-group" style="padding: 16px; background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.4); border-radius: var(--radius); font-size: 14px; color: var(--text-primary);">
                                <strong style="color: var(--accent);"><i class="ph ph-warning"></i> Import Limitations:</strong>
                                <ul style="margin: 12px 0 0 20px; padding: 0; color: var(--text-secondary);">
                                    <li style="margin-bottom: 6px;">Text content and basic formatting only</li>
                                    <li style="margin-bottom: 6px;">Images cannot be imported (external links will be preserved)</li>
                                    <li style="margin-bottom: 6px;">Tables, databases, and embeds are not supported</li>
                                    <li>Nested pages become separate notes</li>
                                </ul>
                            </div>
                            <div class="form-group" style="text-align: center; margin-top: 24px;">
                                <button class="btn btn-primary" id="goToImportStep3">I've Exported My Data</button>
                            </div>
                        </div>
                        
                        <!-- Step 3: Upload -->
                        <div id="importStep3" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Upload your export file</label>
                                <div id="importDropZone" style="border: 2px dashed var(--border); border-radius: var(--radius); padding: 48px; text-align: center; cursor: pointer;">
                                    <i class="ph ph-cloud-arrow-up" style="font-size: 48px; color: var(--accent);"></i>
                                    <p style="margin-top: 16px; color: var(--text-secondary);">Drop ZIP or Markdown files here</p>
                                    <p style="font-size: 12px; color: var(--text-tertiary);">or click to browse</p>
                                    <input type="file" id="importFileInput" accept=".zip,.md,.markdown" style="display: none;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="importFolders" checked>
                                    Import folder structure
                                </label>
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="importTags" checked>
                                    Extract tags from YAML frontmatter
                                </label>
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="convertLinks" checked>
                                    Convert wiki-links to regular links
                                </label>
                            </div>
                        </div>
                        
                        <!-- Step 4: Progress -->
                        <div id="importStep4" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Importing...</label>
                                <div style="padding: 24px; text-align: center;">
                                    <div id="importProgressText" style="margin-bottom: 16px;">Reading files...</div>
                                    <div style="width: 100%; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
                                        <div id="importProgressBar" style="width: 0%; height: 100%; background: var(--accent); transition: width 0.3s;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" id="importWizardFooter">
                        <button class="btn btn-secondary" id="backImportStep" style="display: none;">Back</button>
                        <button class="btn btn-secondary" id="cancelImportWizard">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- AI Panel Modal -->
            <div class="modal-overlay" id="aiPanelModal">
                <div class="modal" style="max-width: 500px;">
                    <div class="modal-header">
                        <div class="modal-title"><i class="ph ph-sparkle"></i> Mind AI</div>
                        <button class="modal-close" id="closeAiPanel">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="padding: 12px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: var(--radius); margin-bottom: 20px; font-size: 13px;">
                            <strong style="color: var(--accent);"><i class="ph ph-lightning"></i> Demo Mode:</strong> AI features are simulated. Connect a provider for real AI.
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">AI Provider</label>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <label class="ai-provider-option" style="padding: 16px; border: 2px solid var(--accent); border-radius: var(--radius); cursor: pointer; display: flex; align-items: flex-start; gap: 12px;">
                                    <input type="radio" name="aiProvider" value="webllm" checked style="margin-top: 2px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 4px;"><i class="ph ph-rocket"></i> WebLLM (Recommended)</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">Runs in browser. No installation. One-time 1.9GB download.</div>
                                    </div>
                                </label>
                                <label class="ai-provider-option" style="padding: 16px; border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; display: flex; align-items: flex-start; gap: 12px;">
                                    <input type="radio" name="aiProvider" value="ollama" style="margin-top: 2px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 4px;"><i class="ph ph-lightning"></i> Ollama Desktop</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">Better performance. Requires desktop app.</div>
                                    </div>
                                </label>
                                <label class="ai-provider-option" style="padding: 16px; border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; display: flex; align-items: flex-start; gap: 12px;">
                                    <input type="radio" name="aiProvider" value="cloud" style="margin-top: 2px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 4px;"><i class="ph ph-cloud"></i> Cloud API</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">OpenAI/Anthropic. Requires API key.</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div id="webllmSection">
                            <div class="form-group">
                                <label class="form-label">Model Size</label>
                                <select class="form-select" id="webllmModel">
                                    <option value="tiny">Tiny (1B) - Fast, basic quality</option>
                                    <option value="small" selected>Small (3B) - Balanced (1.9GB)</option>
                                    <option value="medium">Medium (14B) - Better quality</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="downloadWebllmModel" style="width: 100%;">
                                <i class="ph ph-download"></i> Download Model
                            </button>
                        </div>
                        
                        <div id="ollamaSection" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Ollama Status</label>
                                <div id="ollamaStatus" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius); font-size: 13px;">
                                    Not connected. Install Ollama desktop app.
                                </div>
                            </div>
                            <button class="btn btn-secondary" id="testOllamaConnection" style="width: 100%;">
                                <i class="ph ph-plugs"></i> Test Connection
                            </button>
                        </div>
                        
                        <div id="cloudSection" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">API Key</label>
                                <input type="password" class="form-input" id="cloudApiKey" placeholder="sk-...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Provider</label>
                                <select class="form-select" id="cloudProvider">
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Anthropic</option>
                                    <option value="openrouter">OpenRouter</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 24px;">
                            <label class="form-label">AI Features</label>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <div class="ai-feature-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius);">
                                    <i class="ph ph-text-t" style="color: var(--accent);"></i>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500;">Summarize Note</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">Condense long content into key points</div>
                                    </div>
                                </div>
                                <div class="ai-feature-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius);">
                                    <i class="ph ph-tag" style="color: var(--accent);"></i>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500;">Suggest Tags</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">Auto-generate relevant tags</div>
                                    </div>
                                </div>
                                <div class="ai-feature-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius);">
                                    <i class="ph ph-pencil-simple" style="color: var(--accent);"></i>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500;">Continue Writing</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">Complete your thoughts</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="closeAiPanelBtn">Close</button>
                        <button class="btn btn-primary" id="saveAiSettings">Save Settings</button>
                    </div>
                </div>
            </div>

            <div class="editor-container" id="editorContainer">
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon"><i class="ph ph-brain ph-xl"></i></div>
                    <div class="empty-state-title">Welcome to Mind</div>
                    <div class="empty-state-desc">
                        Your private, offline knowledge management system.
                        Create your first note to get started.
                    </div>
                    <button class="btn btn-primary" id="emptyNewNoteBtn">
                        <i class="ph ph-plus"></i> Create First Note
                    </button>
                </div>

                <div class="editor-toolbar hidden" id="editorToolbar" style="display: none !important;">
                    <div class="toolbar-group">
                        <button class="toolbar-btn" data-command="bold" title="Bold"><i class="ph ph-text-b"></i></button>
                        <button class="toolbar-btn" data-command="italic" title="Italic"><i class="ph ph-text-italic"></i></button>
                        <button class="toolbar-btn" data-command="underline" title="Underline"><i class="ph ph-text-underline"></i></button>
                        <button class="toolbar-btn" data-command="strikeThrough" title="Strikethrough"><i class="ph ph-text-strikethrough"></i></button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" data-command="formatBlock" data-value="H1" title="Heading 1"><i class="ph ph-text-h-one"></i></button>
                        <button class="toolbar-btn" data-command="formatBlock" data-value="H2" title="Heading 2"><i class="ph ph-text-h-two"></i></button>
                        <button class="toolbar-btn" data-command="formatBlock" data-value="H3" title="Heading 3"><i class="ph ph-text-h-three"></i></button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List"><i class="ph ph-list-bullets"></i></button>
                        <button class="toolbar-btn" data-command="insertOrderedList" title="Numbered List"><i class="ph ph-list-numbers"></i></button>
                        <button class="toolbar-btn" data-command="formatBlock" data-value="BLOCKQUOTE" title="Quote"><i class="ph ph-quotes"></i></button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" id="linkBtn" title="Insert Link"><i class="ph ph-link"></i></button>
                        <button class="toolbar-btn" id="imageBtn" title="Insert Image"><i class="ph ph-image"></i></button>
                        <button class="toolbar-btn" id="attachBtn" title="Attach File"><i class="ph ph-paperclip"></i></button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" data-command="removeFormat" title="Clear Formatting"><i class="ph ph-text-t-slash"></i></button>
                    </div>
                </div>

                <!-- Tabs Bar -->
                <div class="tabs-bar hidden" id="tabsBar">
                    <div class="sidebar-toggle-tab" id="sidebarToggleTab" title="Toggle Sidebar">
                        <i class="ph ph-sidebar"></i>
                    </div>
                    <div class="tabs-container" id="tabsContainer"></div>
                    <button class="tabs-new-btn" id="newTabBtn" title="New Note"><i class="ph ph-plus"></i></button>
                    <div style="flex: 1;"></div>
                    <button class="toolbar-btn" id="moreBtn" title="More" style="padding: 6px 10px; background: transparent; border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 14px; margin-right: 20px; align-self: center;"><i class="ph ph-dots-three"></i></button>
                </div>

                <!-- Note Menu Dropdown -->
                <div class="note-menu-dropdown" id="noteMenuDropdown">
                    <div class="note-menu-fonts">
                        <div class="note-menu-font-option active" data-font="default">
                            <div class="note-menu-font-preview">Ag</div>
                            <div class="note-menu-font-label">Default</div>
                        </div>
                        <div class="note-menu-font-option" data-font="serif">
                            <div class="note-menu-font-preview serif">Ag</div>
                            <div class="note-menu-font-label">Serif</div>
                        </div>
                        <div class="note-menu-font-option" data-font="mono">
                            <div class="note-menu-font-preview mono">Ag</div>
                            <div class="note-menu-font-label">Mono</div>
                        </div>
                    </div>
                    <div class="note-menu-divider"></div>
                    <div class="note-menu-item" data-action="copy">
                        <span class="note-menu-icon"><i class="ph ph-copy"></i></span>
                        <span>Copy Page Contents</span>
                    </div>
                    <div class="note-menu-item" data-action="duplicate">
                        <span class="note-menu-icon"><i class="ph ph-copy-simple"></i></span>
                        <span>Duplicate</span>
                    </div>
                    <div class="note-menu-item" data-action="pdf">
                        <span class="note-menu-icon"><i class="ph ph-file-pdf"></i></span>
                        <span>Convert to PDF</span>
                    </div>
                    <div class="note-menu-item" id="clipWebpageBtn">
                        <span class="note-menu-icon"><i class="ph ph-globe"></i></span>
                        <span>Clip Web Page</span>
                    </div>
                    <div class="note-menu-divider"></div>
                    <div class="note-menu-toggle" data-toggle="smallText">
                        <span class="note-menu-icon"><i class="ph ph-text-t"></i></span>
                        <span>Small Text</span>
                        <span class="note-menu-toggle-indicator" id="smallTextToggle"></span>
                    </div>
                    <div class="note-menu-toggle" data-toggle="fullWidth">
                        <span class="note-menu-icon"><i class="ph ph-arrows-left-right"></i></span>
                        <span>Full Width</span>
                        <span class="note-menu-toggle-indicator" id="fullWidthToggle"></span>
                    </div>
                    <div class="note-menu-item" id="versionHistoryBtn">
                        <span class="note-menu-icon"><i class="ph ph-clock-counter-clockwise"></i></span>
                        <span>Version History</span>
                    </div>
                    <div class="note-menu-divider"></div>
                    <div class="note-menu-item delete" data-action="delete">
                        <span class="note-menu-icon"><i class="ph ph-trash"></i></span>
                        <span>Move to Trash</span>
                    </div>
                </div>

                <div class="editor-content-wrapper hidden" id="editorContentWrapper">
                    <div class="editor-content">
                        <input type="text" class="note-title-input" id="noteTitle" placeholder="Note Title">
                        <div class="note-meta">
                            <div class="note-meta-item">
                                <span><i class="ph ph-calendar-blank"></i></span>
                                <span id="noteDate">Created today</span>
                            </div>
                            <div class="note-meta-item">
                                <span><i class="ph ph-tag"></i></span>
                                <div class="note-tags-input" id="noteTagsInput">
                                    <input type="text" class="tag-input" id="tagInput" placeholder="Add tag...">
                                    <div class="tag-autocomplete" id="tagAutocomplete" style="display: none;"></div>
                                </div>
                                <button class="btn btn-secondary" id="suggestTagsBtn" title="AI Suggest Tags" style="padding: 4px 8px; font-size: 11px; margin-left: 4px; background: transparent; border: 1px solid var(--border); color: #fbbf24;">
                                    <i class="ph ph-sparkle"></i> AI Tags
                                </button>
                            </div>
                        </div>
                        
                        <!-- Note Tabs -->
                        <div class="note-tabs" style="display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 16px;">
                            <button class="note-tab active" data-tab="note" style="padding: 8px 16px; background: transparent; border: none; border-bottom: 2px solid var(--accent); color: var(--text-primary); font-size: 13px; cursor: pointer;">Note</button>
                            <button class="note-tab" data-tab="summary" style="padding: 8px 16px; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer;">Summary</button>
                            <button class="note-tab" data-tab="tasks" style="padding: 8px 16px; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-secondary); font-size: 13px; cursor: pointer;">Tasks</button>
                        </div>
                        <div class="note-tab-content" id="noteTabContent">
                            <!-- Template Selector -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <select id="templateSelect" style="background: transparent; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 10px; font-size: 12px; color: var(--text-secondary); cursor: pointer;">
                                    <option value="">Template</option>
                                    <option value="blank">Blank</option>
                                    <option value="trading-journal">Trading Journal</option>
                                    <option value="daily-review">Daily Review</option>
                                    <option value="strategy">Strategy Plan</option>
                                    <option value="meeting">Meeting Notes</option>
                                </select>
                            </div>
                            <div class="wysiwyg-editor" id="wysiwygEditor" contenteditable="true"></div>
                        </div>
                        <div class="note-tab-content" id="summaryTabContent" style="display: none;">
                            <!-- AI Summary Button -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <button class="btn btn-secondary" id="summarizeBtn" title="AI Summarize Note" style="background: transparent; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 6px 10px; font-size: 12px; color: #fbbf24; cursor: pointer;">
                                    <i class="ph ph-sparkle"></i> AI Summary
                                </button>
                            </div>
                            <div id="summaryContent" style="padding: 16px; color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
                                <div id="summaryEmptyState">
                                    <p style="font-style: italic; color: var(--text-tertiary);">No summary yet. Click "AI Summary" to generate one from your note content.</p>
                                </div>
                                <div id="summaryResult" style="display: none;">
                                    <div id="summaryText"></div>
                                    <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border);">
                                        <small style="color: var(--text-tertiary);">
                                            <i class="ph ph-info"></i> Demo mode: Summary generated from keywords
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="note-tab-content" id="tasksTabContent" style="display: none;">
                            <div id="tasksList" style="padding: 8px 0;"></div>
                            <button class="btn btn-secondary" id="addFirstTaskBtn" style="margin-top: 12px; font-size: 12px; padding: 6px 12px; background: transparent; border: 1px solid var(--border); color: var(--text-secondary);"><i class="ph ph-plus"></i> Add Task</button>
                        </div>
                    </div>
                    
                    <!-- Selection Toolbar -->
                    <div class="selection-toolbar" id="selectionToolbar">
                        <button class="selection-toolbar-btn" data-command="bold" title="Bold">
                            <i class="ph ph-text-b"></i>
                        </button>
                        <button class="selection-toolbar-btn" data-command="italic" title="Italic">
                            <i class="ph ph-text-italic"></i>
                        </button>
                        <button class="selection-toolbar-btn" data-command="underline" title="Underline">
                            <i class="ph ph-text-underline"></i>
                        </button>
                        <button class="selection-toolbar-btn" data-command="strikeThrough" title="Strikethrough">
                            <i class="ph ph-text-strikethrough"></i>
                        </button>
                        <span class="selection-toolbar-divider"></span>
                        <button class="selection-toolbar-btn" data-command="formatBlock" data-value="H1" title="Heading 1">
                            <i class="ph ph-text-h-one"></i>
                        </button>
                        <button class="selection-toolbar-btn" data-command="formatBlock" data-value="H2" title="Heading 2">
                            <i class="ph ph-text-h-two"></i>
                        </button>
                        <button class="selection-toolbar-btn" data-command="formatBlock" data-value="H3" title="Heading 3">
                            <i class="ph ph-text-h-three"></i>
                        </button>
                        <span class="selection-toolbar-divider"></span>
                        <button class="selection-toolbar-btn" data-command="insertUnorderedList" title="Bullet List">
                            <i class="ph ph-list-bullets"></i>
                        </button>
                        <button class="selection-toolbar-btn" data-command="insertOrderedList" title="Numbered List">
                            <i class="ph ph-list-numbers"></i>
                        </button>
                        <span class="selection-toolbar-divider"></span>
                        <button class="selection-toolbar-btn" id="toolbarLinkBtn" title="Insert Link">
                            <i class="ph ph-link"></i>
                        </button>
                        <button class="selection-toolbar-btn" id="toolbarImageBtn" title="Insert Image">
                            <i class="ph ph-image"></i>
                        </button>
                        <span class="selection-toolbar-divider"></span>
                        <button class="selection-toolbar-btn ai" id="askAiSelectionBtn" title="Ask AI">
                            <i class="ph ph-sparkle"></i> Ask AI
                        </button>
                    </div>
                </div>

                <div class="backlinks-panel hidden" id="backlinksPanel">
                    <div class="backlinks-title">Linked from</div>
                    <div class="backlinks-list" id="backlinksList"></div>
                </div>
            </div>

            <button class="exit-distraction-free" id="exitFocusBtn" title="Exit Focus Mode"><i class="ph ph-x"></i></button>
        </main>

        <!-- Version History Panel -->
        <div class="version-history-panel" id="versionHistoryPanel">
            <div class="version-history-header">
                <div class="version-history-title">Version History</div>
                <div class="version-history-close" id="closeVersionHistory"><i class="ph ph-x"></i></div>
            </div>
            <div class="version-history-list" id="versionHistoryList">
                <!-- Versions will be rendered here -->
            </div>
            <div class="version-preview" id="versionPreview" style="display: none;">
                <div class="version-preview-title">Preview</div>
                <div class="version-preview-content" id="versionPreviewContent"></div>
            </div>
            <div class="version-history-footer">
                <button class="btn btn-secondary" id="cancelVersionRestore">Cancel</button>
                <button class="btn btn-primary" id="confirmVersionRestore">Restore</button>
            </div>
        </div>

        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-nav">
            <div class="mobile-nav-items">
                <div class="mobile-nav-item active" data-view="notes">
                    <span class="mobile-nav-icon"><i class="ph ph-file-text"></i></span>
                    <span class="mobile-nav-label">Notes</span>
                </div>
                <div class="mobile-nav-item" data-view="folders">
                    <span class="mobile-nav-icon"><i class="ph ph-folder"></i></span>
                    <span class="mobile-nav-label">Folders</span>
                </div>
                <div class="mobile-nav-item" data-view="tags">
                    <span class="mobile-nav-icon"><i class="ph ph-tag"></i></span>
                    <span class="mobile-nav-label">Tags</span>
                </div>
                <div class="mobile-nav-item" data-view="search">
                    <span class="mobile-nav-icon"><i class="ph ph-magnifying-glass"></i></span>
                    <span class="mobile-nav-label">Search</span>
                </div>
            </div>
        </nav>
    </div>

    <!-- New Note Modal -->
    <div class="modal-overlay" id="newNoteModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create New Note</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Note Title</label>
                    <input type="text" class="form-input" id="newNoteTitle" placeholder="Enter note title..." autofocus>
                </div>
                <div class="form-group">
                    <label class="form-label">Folder</label>
                    <select class="form-select" id="newNoteFolder"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelNewNote">Cancel</button>
                <button class="btn btn-primary" id="confirmNewNote">Create</button>
            </div>
        </div>
    </div>

    <!-- New Folder Modal -->
    <div class="modal-overlay" id="newFolderModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create New Folder</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Folder Name</label>
                    <input type="text" class="form-input" id="newFolderName" placeholder="Enter folder name...">
                </div>
                <div class="form-group">
                    <label class="form-label">Parent Folder</label>
                    <select class="form-select" id="newFolderParent"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelNewFolder">Cancel</button>
                <button class="btn btn-primary" id="confirmNewFolder">Create</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Theme</label>
                    <select class="form-select" id="themeSelect">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="auto">Auto (System)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">AI Settings</label>
                    <button class="btn btn-secondary" id="aiSettingsBtn" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="ph ph-robot"></i> Configure AI
                    </button>
                    <small style="color: var(--text-tertiary); font-size: 11px; display: block; margin-top: 8px;">
                        Set up WebLLM, Ollama, or Cloud AI providers
                    </small>
                </div>
                <div class="form-group">
                    <label class="form-label">Data Management</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" id="exportJsonBtn">Export JSON</button>
                        <button class="btn btn-secondary" id="exportMarkdownBtn">Export Markdown</button>
                        <button class="btn btn-secondary" id="importBtn">Import Data</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Data Recovery</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" id="checkBackupBtn">Check for Backups</button>
                        <button class="btn btn-secondary" id="createBackupBtn">Create Backup Now</button>
                    </div>
                    <small id="backupStatus" style="color: var(--text-tertiary); font-size: 11px; display: block; margin-top: 8px;"></small>
                </div>
                <div class="form-group">
                    <label class="form-label">Trash</label>
                    <button class="btn btn-secondary" id="trashBtn" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="ph ph-trash"></i> View Trash
                    </button>
                    <small id="trashCount" style="color: var(--text-tertiary); font-size: 11px; display: block; margin-top: 8px;">0 items in trash</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Debug</label>
                    <button class="btn btn-secondary" id="debugBtn">Show Debug Info</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Danger Zone</label>
                    <button class="btn btn-secondary" id="clearAllBtn" style="color: var(--danger);">Clear All Data</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeSettings">Close</button>
            </div>
        </div>
    </div>

    <!-- Trash Modal -->
    <div class="modal-overlay" id="trashModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title"><i class="ph ph-trash"></i> Trash</div>
                <button class="modal-close" id="closeTrashModal">&times;</button>
            </div>
            <div class="modal-body" id="trashModalBody">
                <div id="trashEmptyState" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="ph ph-trash" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                    <p>Trash is empty</p>
                </div>
                <div id="trashItemsList" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Items in Trash</label>
                        <div id="trashItemsContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); padding: 8px;">
                            <!-- Trash items rendered here -->
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <button class="btn btn-secondary" id="emptyTrashNowBtn" style="width: 100%; color: var(--danger);">
                            <i class="ph ph-trash"></i> Delete All Permanently
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeTrashBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Link Modal -->
    <div class="modal-overlay" id="linkModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Insert Link</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Link Text</label>
                    <input type="text" class="form-input" id="linkText" placeholder="Link text...">
                </div>
                <div class="form-group">
                    <label class="form-label">URL or Note Title</label>
                    <input type="text" class="form-input" id="linkUrl" placeholder="https://... or note title">
                    <small style="color: var(--text-tertiary); font-size: 11px;">
                        Type a note title to create an internal link
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelLink">Cancel</button>
                <button class="btn btn-primary" id="confirmLink">Insert</button>
            </div>
        </div>
    </div>

    <!-- AI Selection Modal -->
    <div class="modal-overlay" id="aiSelectionModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title"><i class="ph ph-sparkle"></i> Improve with AI</div>
                <button class="modal-close" id="closeAiSelection">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Selected text</label>
                    <div id="aiSelectedText" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius); font-size: 14px; max-height: 100px; overflow-y: auto; color: var(--text-secondary);"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">What would you like to do?</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn btn-secondary ai-action-btn" data-action="improve">
                            <i class="ph ph-text-t"></i> Improve writing
                        </button>
                        <button class="btn btn-secondary ai-action-btn" data-action="grammar">
                            <i class="ph ph-check-circle"></i> Fix grammar & spelling
                        </button>
                        <button class="btn btn-secondary ai-action-btn" data-action="shorter">
                            <i class="ph ph-text-align-left"></i> Make it shorter
                        </button>
                        <button class="btn btn-secondary ai-action-btn" data-action="longer">
                            <i class="ph ph-text-align-justify"></i> Make it longer
                        </button>
                        <button class="btn btn-secondary ai-action-btn" data-action="simplify">
                            <i class="ph ph-brain"></i> Simplify language
                        </button>
                        <button class="btn btn-secondary ai-action-btn" data-action="professional">
                            <i class="ph ph-briefcase"></i> Make it more professional
                        </button>
                    </div>
                </div>
                <div id="aiSuggestionResult" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">AI Suggestion</label>
                        <div id="aiSuggestionText" style="padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius); font-size: 15px; line-height: 1.6; border-left: 3px solid var(--accent);"></div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" id="acceptAiSuggestion" style="flex: 1;">
                            <i class="ph ph-check"></i> Accept
                        </button>
                        <button class="btn btn-secondary" id="discardAiSuggestion" style="flex: 1;">
                            <i class="ph ph-x"></i> Discard
                        </button>
                    </div>
                </div>
                <div id="aiLoadingState" style="display: none; text-align: center; padding: 24px;">
                    <i class="ph ph-spinner" style="font-size: 32px; color: var(--accent); animation: spin 1s linear infinite;"></i>
                    <p style="margin-top: 12px; color: var(--text-secondary);">Thinking...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="ctxRename"><i class="ph ph-pencil-simple"></i> Rename</div>
        <div class="context-menu-item" id="ctxDuplicate"><i class="ph ph-copy"></i> Duplicate</div>
        <div class="context-menu-item" id="ctxMove"><i class="ph ph-folder"></i> Move to...</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item danger" id="ctxDelete"><i class="ph ph-trash"></i> Delete</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Hidden File Input -->
    <input type="file" id="fileInput" accept="image/*" hidden>
    <input type="file" id="attachInput" hidden>
    <input type="file" id="importInput" accept=".json,.md,.markdown" hidden>

    <script>
        // ==================== KNOWLEDGE BASE APP ====================

        class KnowledgeBase {
            constructor() {
                this.data = {
                    folders: [
                        { id: 'root', name: 'All Notes', parentId: null },
                        { id: 'inbox', name: 'Inbox', parentId: null }
                    ],
                    notes: [],
                    tags: [],
                    settings: {
                        theme: 'auto',
                        sidebarCollapsed: {}
                    }
                };
                this.currentNote = null;
                this.currentFolder = 'root';
                this.currentTagFilter = null;
                this.contextMenuTarget = null;
                this.draggedNote = null;
                this.draggedFolder = null;
                this.db = null;
                this.openTabs = []; // Array of note IDs
                this.activeTabId = null;
                
                // AI Integration
                this.ollamaUrl = 'http://localhost:11434';
                this.ollamaModel = 'llama3.2';
                this.ollamaReady = false;

                this.init();
            }

            async init() {
                try {
                    await this.initIndexedDB();
                    this.loadData();
                    this.autoBackup(); // Create backup on startup if data exists
                    this.setupEventListeners();
                    this.setupMobileGestures();
                    this.applyTheme();
                    this.render();

                    // Create welcome note if empty
                    if (this.data.notes.length === 0) {
                        this.createWelcomeNote();
                    }

                    // Restore sidebar width and collapsed state
                    this.restoreSidebarState();

                    console.log('App initialized successfully');
                } catch (err) {
                    console.error('Initialization error:', err);
                    alert('Error starting app: ' + err.message);
                }
            }

            autoBackup() {
                // Silently create a backup if we have data
                const data = localStorage.getItem('kb_data');
                if (data && data.length > 100) { // Only backup if substantial data exists
                    localStorage.setItem('kb_data_backup', data);
                    localStorage.setItem('kb_backup_date', new Date().toISOString());
                    console.log('Auto-backup created');
                }
            }

            restoreSidebarState() {
                const sidebar = document.getElementById('sidebar');
                if (!sidebar) return;

                // Restore width
                if (this.data.settings.sidebarWidth) {
                    sidebar.style.width = this.data.settings.sidebarWidth + 'px';
                }

                // Restore collapsed state
                if (this.data.settings.sidebarCollapsed === true) {
                    sidebar.classList.add('collapsed');
                }
            }

            // ==================== INDEXEDDB ====================

            initIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('KnowledgeBase', 1);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('attachments')) {
                            db.createObjectStore('attachments', { keyPath: 'id' });
                        }
                    };
                });
            }

            async saveAttachment(id, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['attachments'], 'readwrite');
                    const store = transaction.objectStore('attachments');
                    const request = store.put({ id, data, timestamp: Date.now() });
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async getAttachment(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['attachments'], 'readonly');
                    const store = transaction.objectStore('attachments');
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result?.data);
                    request.onerror = () => reject(request.error);
                });
            }

            // ==================== DATA PERSISTENCE ====================

            loadData() {
                const saved = localStorage.getItem('kb_data');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        // Validate data structure before merging
                        if (parsed && typeof parsed === 'object') {
                            this.data = { ...this.data, ...parsed };
                            // Ensure critical arrays exist
                            if (!Array.isArray(this.data.folders)) this.data.folders = [];
                            if (!Array.isArray(this.data.notes)) this.data.notes = [];
                            if (!Array.isArray(this.data.tags)) this.data.tags = [];
                            if (!this.data.settings) this.data.settings = {};
                            this.repairData();
                        } else {
                            console.error('Invalid data structure, using defaults');
                        }
                    } catch (e) {
                        console.error('Failed to load data:', e);
                        // Try to restore from backup
                        const backup = localStorage.getItem('kb_data_backup');
                        if (backup) {
                            try {
                                const parsed = JSON.parse(backup);
                                this.data = { ...this.data, ...parsed };
                                console.log('Restored from backup');
                                this.showToast('Restored from backup', 'success');
                            } catch (backupErr) {
                                console.error('Backup also corrupted:', backupErr);
                            }
                        }
                    }
                }
            }

            repairData() {
                // Fix corrupted parent references
                this.data.folders.forEach(folder => {
                    // Fix self-referencing folders (inbox parent = inbox, etc.)
                    if (folder.parentId === folder.id) {
                        console.log(`Repairing self-referencing folder: ${folder.name}`);
                        folder.parentId = null;
                    }
                    // Fix folders pointing to 'root' - should be null
                    if (folder.parentId === 'root') {
                        folder.parentId = null;
                    }
                    // Fix folders pointing to non-existent parents
                    if (folder.parentId && !this.data.folders.find(f => f.id === folder.parentId)) {
                        console.log(`Repairing orphaned folder: ${folder.name}`);
                        folder.parentId = null;
                    }
                });
                this.saveData();
            }

            saveData() {
                localStorage.setItem('kb_data', JSON.stringify(this.data));
            }

            // ==================== THEME ====================

            applyTheme() {
                const theme = this.data.settings.theme;
                const isDark = theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                
                if (isDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
                
                // Update theme select dropdown
                const themeSelect = document.getElementById('themeSelect');
                if (themeSelect) {
                    themeSelect.value = theme;
                }
                
                // Update theme button icon
                const themeBtn = document.getElementById('themeBtn');
                if (themeBtn) {
                    themeBtn.innerHTML = isDark ? '<i class="ph ph-sun"></i>' : '<i class="ph ph-moon"></i>';
                    themeBtn.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
                    themeBtn.style.color = 'var(--text-secondary)';
                }
            }

            toggleTheme() {
                const themes = ['light', 'dark', 'auto'];
                const current = this.data.settings.theme;
                const next = themes[(themes.indexOf(current) + 1) % themes.length];
                this.data.settings.theme = next;
                this.applyTheme();
                this.saveData();
            }

            setTheme(theme) {
                this.data.settings.theme = theme;
                this.applyTheme();
                this.saveData();
            }

            // ==================== FOLDER OPERATIONS ====================

            createFolder(name, parentId = null) {
                const folder = {
                    id: 'folder_' + Date.now(),
                    name: name.trim(),
                    parentId: parentId
                };
                this.data.folders.push(folder);
                this.saveData();
                this.render();
                this.showToast('Folder created', 'success');
                return folder;
            }

            renameFolder(id, newName) {
                const folder = this.data.folders.find(f => f.id === id);
                if (folder && !this.isSystemFolder(id)) {
                    folder.name = newName.trim();
                    this.saveData();
                    this.render();
                    this.showToast('Folder renamed', 'success');
                }
            }

            moveFolder(folderId, newParentId) {
                const folder = this.data.folders.find(f => f.id === folderId);
                if (folder && !this.isSystemFolder(folderId)) {
                    // Prevent moving into itself or its descendants
                    if (newParentId === folderId || this.getChildFolderIds(folderId).includes(newParentId)) {
                        this.showToast('Cannot move folder into itself', 'error');
                        return;
                    }
                    folder.parentId = newParentId;
                    this.saveData();
                    this.render();
                    this.showToast('Folder moved', 'success');
                }
            }

            isDescendant(ancestorId, descendantId) {
                // Check if descendantId is a descendant of ancestorId (to prevent cycles)
                let current = this.data.folders.find(f => f.id === descendantId);
                while (current) {
                    if (current.parentId === ancestorId) return true;
                    current = this.data.folders.find(f => f.id === current.parentId);
                }
                return false;
            }

            reorderFolder(draggedFolderId, targetFolderId, insertBefore) {
                const draggedFolder = this.data.folders.find(f => f.id === draggedFolderId);
                const targetFolder = this.data.folders.find(f => f.id === targetFolderId);

                if (!draggedFolder || !targetFolder) return;

                // Only reorder if same parent
                if (draggedFolder.parentId !== targetFolder.parentId) {
                    // Move to same parent as target
                    draggedFolder.parentId = targetFolder.parentId;
                }

                // Get folders with same parent
                const siblings = this.data.folders.filter(f => f.parentId === targetFolder.parentId);
                const draggedIndex = siblings.findIndex(f => f.id === draggedFolderId);
                const targetIndex = siblings.findIndex(f => f.id === targetFolderId);

                if (draggedIndex === -1 || targetIndex === -1) return;

                // Remove dragged folder from current position
                siblings.splice(draggedIndex, 1);

                // Calculate new index
                let newIndex = targetIndex;
                if (draggedIndex < targetIndex && !insertBefore) {
                    newIndex = targetIndex;
                } else if (draggedIndex > targetIndex && insertBefore) {
                    newIndex = targetIndex;
                } else if (draggedIndex < targetIndex && insertBefore) {
                    newIndex = targetIndex - 1;
                } else if (draggedIndex > targetIndex && !insertBefore) {
                    newIndex = targetIndex + 1;
                }

                // Insert at new position
                siblings.splice(newIndex, 0, draggedFolder);

                // Update main array to match new order
                const otherFolders = this.data.folders.filter(f => f.parentId !== targetFolder.parentId);
                this.data.folders = [...otherFolders, ...siblings];

                this.saveData();
                this.render();
                this.showToast('Folder reordered', 'success');
            }

            addFolderToFavorites(id) {
                const folder = this.data.folders.find(f => f.id === id);
                if (folder) {
                    if (!this.data.settings.favoriteFolders) {
                        this.data.settings.favoriteFolders = [];
                    }
                    if (!this.data.settings.favoriteFolders.includes(id)) {
                        this.data.settings.favoriteFolders.push(id);
                        this.saveData();
                        this.renderFavorites();
                        this.showToast('Added to favorites', 'success');
                    } else {
                        this.showToast('Already in favorites', 'info');
                    }
                }
            }

            renderFavorites() {
                const favoritesContainer = document.getElementById('favoritesSectionContainer');
                const favoritesTree = document.getElementById('favoritesTree');
                const favoriteIds = this.data.settings.favoriteFolders || [];

                if (favoriteIds.length === 0) {
                    favoritesContainer.style.display = 'none';
                    return;
                }

                favoritesContainer.style.display = 'block';
                favoritesTree.innerHTML = '';

                // Track expanded state in favorites separately
                if (!this.data.settings.favoritesExpanded) {
                    this.data.settings.favoritesExpanded = {};
                }

                favoriteIds.forEach(folderId => {
                    const folder = this.data.folders.find(f => f.id === folderId);
                    if (folder) {
                        const li = document.createElement('li');
                        li.className = 'folder-item';

                        const noteCount = this.data.notes.filter(n => n.folderId === folderId).length;
                        const hasChildren = this.data.folders.some(f => f.parentId === folder.id);
                        const isExpanded = this.data.settings.favoritesExpanded[folder.id];

                        li.innerHTML = `
                            <div class="folder-header ${this.currentFolder === folder.id ? 'active' : ''}"
                                 data-folder="${folder.id}"
                                 style="padding-left: 8px;">
                                ${hasChildren ? `<span class="folder-toggle ${isExpanded ? '' : 'collapsed'}">${isExpanded ? '' : ''}</span>` : '<span class="folder-toggle" style="visibility: hidden;"></span>'}
                                <span class="folder-icon"><i class="ph ph-star"></i></span>
                                <span class="folder-name">${this.escapeHtml(folder.name)}</span>
                                <span class="folder-count">${noteCount}</span>
                                <div class="folder-actions">
                                    <button class="folder-action-btn more-menu" title="More options"><i class="ph ph-dots-three"></i></button>
                                    <div class="folder-dropdown" id="dropdown-fav-${folder.id}">
                                        <div class="folder-dropdown-item" data-action="remove-favorite">
                                            <span class="folder-dropdown-icon"><i class="ph ph-star"></i></span>
                                            <span>Remove from Favorites</span>
                                        </div>
                                        <div class="folder-dropdown-item" data-action="rename">
                                            <span class="folder-dropdown-icon"><i class="ph ph-pencil-simple"></i></span>
                                            <span>Rename</span>
                                        </div>
                                        <div class="folder-dropdown-divider"></div>
                                        <div class="folder-dropdown-item delete" data-action="delete">
                                            <span class="folder-dropdown-icon"><i class="ph ph-trash"></i></span>
                                            <span>Move to Trash</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        const header = li.querySelector('.folder-header');
                        header.addEventListener('click', (e) => {
                            if (e.target.classList.contains('folder-action-btn') || e.target.closest('.folder-dropdown')) return;
                            this.selectFolder(folder.id);
                        });

                        // Toggle expand/collapse
                        const toggle = li.querySelector('.folder-toggle');
                        if (toggle && hasChildren) {
                            toggle.addEventListener('click', (e) => {
                                e.stopPropagation();
                                // Get current state at click time, not render time
                                const currentExpanded = !!this.data.settings.favoritesExpanded?.[folder.id];
                                this.data.settings.favoritesExpanded[folder.id] = !currentExpanded;
                                this.saveData();
                                this.renderFavorites();
                            });
                        }

                        // More menu button
                        const moreMenuBtn = li.querySelector('.folder-action-btn.more-menu');
                        const dropdown = li.querySelector(`#dropdown-fav-${folder.id}`);

                        if (moreMenuBtn && dropdown) {
                            moreMenuBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                document.querySelectorAll('.folder-dropdown.show').forEach(d => {
                                    if (d !== dropdown) d.classList.remove('show');
                                });
                                dropdown.classList.toggle('show');
                            });

                            dropdown.querySelectorAll('.folder-dropdown-item').forEach(item => {
                                item.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    const action = item.dataset.action;
                                    dropdown.classList.remove('show');

                                    switch(action) {
                                        case 'remove-favorite':
                                            this.removeFolderFromFavorites(folder.id);
                                            break;
                                        case 'rename':
                                            this.renameFolder(folder.id);
                                            break;
                                        case 'delete':
                                            this.deleteFolder(folder.id);
                                            break;
                                    }
                                });
                            });
                        }

                        // Render children if expanded
                        if (isExpanded && hasChildren) {
                            const childrenUl = this.renderFolderChildren(folder.id, 1, true);
                            if (childrenUl) {
                                li.appendChild(childrenUl);
                            }
                        }

                        // Drag to reorder favorites
                        li.draggable = true;
                        li.addEventListener('dragstart', (e) => {
                            this.draggedFavoriteIndex = favoriteIds.indexOf(folder.id);
                            li.style.opacity = '0.5';
                            e.dataTransfer.effectAllowed = 'move';
                        });

                        li.addEventListener('dragend', () => {
                            li.style.opacity = '';
                            this.draggedFavoriteIndex = null;
                            document.querySelectorAll('.folder-item').forEach(item => {
                                item.style.borderTop = '';
                                item.style.borderBottom = '';
                            });
                        });

                        li.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            if (this.draggedFavoriteIndex === null) return;
                            
                            const currentIndex = favoriteIds.indexOf(folder.id);
                            if (currentIndex === this.draggedFavoriteIndex) return;
                            
                            const rect = li.getBoundingClientRect();
                            const midpoint = rect.top + rect.height / 2;
                            
                            if (e.clientY < midpoint) {
                                li.style.borderTop = '2px solid var(--accent)';
                                li.style.borderBottom = '';
                            } else {
                                li.style.borderTop = '';
                                li.style.borderBottom = '2px solid var(--accent)';
                            }
                        });

                        li.addEventListener('dragleave', () => {
                            li.style.borderTop = '';
                            li.style.borderBottom = '';
                        });

                        li.addEventListener('drop', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            li.style.borderTop = '';
                            li.style.borderBottom = '';
                            
                            if (this.draggedFavoriteIndex === null) return;
                            
                            const currentIndex = favoriteIds.indexOf(folder.id);
                            if (currentIndex === this.draggedFavoriteIndex) return;
                            
                            const rect = li.getBoundingClientRect();
                            const midpoint = rect.top + rect.height / 2;
                            let newIndex = currentIndex;
                            
                            if (e.clientY > midpoint) {
                                newIndex = currentIndex + 1;
                            }
                            
                            // Reorder
                            const [moved] = this.data.settings.favoriteFolders.splice(this.draggedFavoriteIndex, 1);
                            if (newIndex > this.draggedFavoriteIndex) {
                                newIndex--;
                            }
                            this.data.settings.favoriteFolders.splice(newIndex, 0, moved);
                            
                            this.saveData();
                            this.renderFavorites();
                            this.showToast('Favorites reordered', 'success');
                        });

                        favoritesTree.appendChild(li);
                    }
                });
            }

            renderFolderChildren(parentId, level = 0, useFavoritesState = false) {
                const folders = this.data.folders.filter(f => f.parentId === parentId);
                if (folders.length === 0) return null;

                const ul = document.createElement('ul');
                ul.className = 'folder-children';
                ul.style.paddingLeft = '12px';

                folders.forEach(folder => {
                    const li = document.createElement('li');
                    li.className = 'folder-item';

                    const noteCount = this.data.notes.filter(n => n.folderId === folder.id).length;
                    const hasChildren = this.data.folders.some(f => f.parentId === folder.id);
                    const isCollapsed = useFavoritesState 
                        ? !this.data.settings.favoritesExpanded?.[folder.id]
                        : this.data.settings.sidebarCollapsed?.[folder.id];

                    li.innerHTML = `
                        <div class="folder-header ${this.currentFolder === folder.id ? 'active' : ''}"
                             data-folder="${folder.id}"
                             style="padding-left: ${8 + level * 4}px;">
                            ${hasChildren ? `<span class="folder-toggle ${isCollapsed ? 'collapsed' : ''}">${isCollapsed ? '' : ''}</span>` : '<span class="folder-toggle" style="visibility: hidden;"></span>'}
                            <span class="folder-icon"><i class="ph ph-folder"></i></span>
                            <span class="folder-name">${this.escapeHtml(folder.name)}</span>
                            <span class="folder-count">${noteCount}</span>
                        </div>
                    `;

                    const header = li.querySelector('.folder-header');
                    header.addEventListener('click', (e) => {
                        // Use closest to handle clicks on the arrow text inside the toggle
                        if (e.target.closest('.folder-toggle') && hasChildren) {
                            // Toggle collapse - use appropriate state
                            if (useFavoritesState) {
                                const currentExpanded = !!this.data.settings.favoritesExpanded?.[folder.id];
                                this.data.settings.favoritesExpanded[folder.id] = !currentExpanded;
                            } else {
                                const currentCollapsed = !!this.data.settings.sidebarCollapsed?.[folder.id];
                                this.data.settings.sidebarCollapsed[folder.id] = !currentCollapsed;
                            }
                            this.saveData();
                            if (useFavoritesState) {
                                this.renderFavorites();
                            } else {
                                this.render();
                            }
                        } else {
                            this.selectFolder(folder.id);
                        }
                    });

                    // Recursively render children
                    if (hasChildren && !isCollapsed) {
                        const childrenUl = this.renderFolderChildren(folder.id, level + 1, useFavoritesState);
                        if (childrenUl) {
                            li.appendChild(childrenUl);
                        }
                    }

                    ul.appendChild(li);
                });

                return ul;
            }

            removeFolderFromFavorites(id) {
                if (this.data.settings.favoriteFolders) {
                    this.data.settings.favoriteFolders = this.data.settings.favoriteFolders.filter(fId => fId !== id);
                    this.saveData();
                    this.renderFavorites();
                    this.showToast('Removed from favorites', 'success');
                }
            }

            renderClippedPages() {
                const clippedContainer = document.getElementById('clippedSectionContainer');
                const clippedList = document.getElementById('clippedList');
                const clippedNotes = this.data.notes.filter(n => n.clippedFrom);

                if (clippedNotes.length === 0) {
                    clippedContainer.style.display = 'none';
                    return;
                }

                clippedContainer.style.display = 'block';
                clippedList.innerHTML = '';

                clippedNotes.forEach(note => {
                    const li = document.createElement('li');
                    li.className = 'bookmark-item';
                    li.innerHTML = `
                        <i class="ph ph-globe"></i>
                        <span class="bookmark-title">${this.escapeHtml(note.title || 'Clipped Page')}</span>
                    `;
                    li.addEventListener('click', () => this.selectNote(note.id));
                    clippedList.appendChild(li);
                });
            }
            restoreFromTrash(id) {
                const item = this.data.trash?.find(t => t.id === id);
                if (!item) return;

                if (item.type === 'folder') {
                    // Check if parent still exists, default to root if not
                    const parentExists = this.data.folders.some(f => f.id === item.parentId);
                    this.data.folders.push({
                        id: item.id,
                        name: item.name,
                        parentId: parentExists ? item.parentId : 'root',
                        created: new Date().toISOString()
                    });
                } else {
                    // Check if folder still exists, default to inbox if not
                    const folderExists = this.data.folders.some(f => f.id === item.folderId);
                    this.data.notes.push({
                        id: item.id,
                        title: item.title,
                        content: item.content,
                        folderId: folderExists ? item.folderId : 'inbox',
                        tags: item.tags || [],
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    });
                }

                // Remove from trash
                this.data.trash = this.data.trash.filter(t => t.id !== id);
                this.saveData();
                this.render();
                this.showToast('Item restored', 'success');
            }

            permanentDelete(id) {
                if (!confirm('Delete permanently? This cannot be undone.')) return;

                this.data.trash = this.data.trash.filter(t => t.id !== id);
                this.saveData();
                this.render();
                this.showToast('Item permanently deleted', 'success');
            }

            duplicateFolder(id) {
                const folder = this.data.folders.find(f => f.id === id);
                if (folder && !this.isSystemFolder(id)) {
                    // Create duplicate folder
                    const newFolder = {
                        id: 'folder_' + Date.now(),
                        name: folder.name + ' (Copy)',
                        parentId: folder.parentId,
                        created: new Date().toISOString()
                    };
                    this.data.folders.push(newFolder);

                    // Duplicate notes in this folder
                    const notesToDuplicate = this.data.notes.filter(n => n.folderId === id);
                    notesToDuplicate.forEach(note => {
                        const newNote = {
                            id: 'note_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            title: note.title,
                            content: note.content,
                            folderId: newFolder.id,
                            tags: [...note.tags],
                            created: new Date().toISOString(),
                            updated: new Date().toISOString()
                        };
                        this.data.notes.push(newNote);
                    });

                    // Recursively duplicate child folders
                    const childFolders = this.data.folders.filter(f => f.parentId === id);
                    this.duplicateChildFolders(id, newFolder.id);

                    this.saveData();
                    this.render();
                    this.showToast('Folder duplicated', 'success');
                }
            }

            duplicateChildFolders(parentId, newParentId) {
                const childFolders = this.data.folders.filter(f => f.parentId === parentId);
                childFolders.forEach(child => {
                    const newChild = {
                        id: 'folder_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: child.name,
                        parentId: newParentId,
                        created: new Date().toISOString()
                    };
                    this.data.folders.push(newChild);

                    // Duplicate notes
                    const notesToDuplicate = this.data.notes.filter(n => n.folderId === child.id);
                    notesToDuplicate.forEach(note => {
                        const newNote = {
                            id: 'note_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            title: note.title,
                            content: note.content,
                            folderId: newChild.id,
                            tags: [...note.tags],
                            created: new Date().toISOString(),
                            updated: new Date().toISOString()
                        };
                        this.data.notes.push(newNote);
                    });

                    // Recurse
                    this.duplicateChildFolders(child.id, newChild.id);
                });
            }

            renameFolder(id) {
                const folder = this.data.folders.find(f => f.id === id);
                if (folder) {
                    const newName = prompt('Enter new folder name:', folder.name);
                    if (newName && newName.trim()) {
                        folder.name = newName.trim();
                        this.saveData();
                        this.render();
                        this.showToast('Folder renamed', 'success');
                    }
                }
            }

            deleteFolder(id) {
                if (this.isSystemFolder(id)) {
                    this.showToast('Cannot delete system folders', 'error');
                    return;
                }

                const folder = this.data.folders.find(f => f.id === id);
                if (!folder) return;

                // Move folder to trash
                if (!this.data.trash) this.data.trash = [];
                this.data.trash.push({
                    type: 'folder',
                    id: folder.id,
                    name: folder.name,
                    parentId: folder.parentId,
                    deletedAt: Date.now()
                });

                // Also move all notes in this folder to trash
                const notesInFolder = this.data.notes.filter(n => n.folderId === id);
                notesInFolder.forEach(note => {
                    this.data.trash.push({
                        type: 'note',
                        id: note.id,
                        title: note.title,
                        content: note.content,
                        folderId: note.folderId,
                        tags: note.tags,
                        deletedAt: Date.now()
                    });
                });
                this.data.notes = this.data.notes.filter(n => n.folderId !== id);

                // Handle child folders - recursively delete them
                const childFolders = this.data.folders.filter(f => f.parentId === id);
                childFolders.forEach(child => {
                    this.deleteFolder(child.id);
                });

                // Remove from favorites if present
                if (this.data.settings.favoriteFolders) {
                    this.data.settings.favoriteFolders = this.data.settings.favoriteFolders.filter(fId => fId !== id);
                }

                // Actually delete the folder
                this.data.folders = this.data.folders.filter(f => f.id !== id);

                this.saveData();
                this.render();
                this.showToast('Folder moved to Trash', 'success');
            }

            isSystemFolder(id) {
                return ['root'].includes(id);
            }

            getFolderPath(folderId) {
                const path = [];
                let current = this.data.folders.find(f => f.id === folderId);
                while (current) {
                    path.unshift(current);
                    current = this.data.folders.find(f => f.id === current.parentId);
                }
                return path;
            }

            // ==================== NOTE OPERATIONS ====================

            createNote(title, folderId = 'root') {
                const note = {
                    id: 'note_' + Date.now(),
                    title: title?.trim() || 'Untitled Note',
                    content: '',
                    folderId: folderId,
                    tags: [],
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                this.data.notes.push(note);
                this.saveData();
                this.selectNote(note.id);
                this.render();
                this.showToast('Note created', 'success');
                return note;
            }

            createWelcomeNote() {
                const welcomeContent = `
                    <h1>Welcome to Knowledge Base!</h1>
                    <p>This is your personal, offline knowledge management system. Here's how to get started:</p>
                    <h2><i class="ph ph-notebook"></i> Creating Notes</h2>
                    <ul>
                        <li>Click "New Note" to create a note</li>
                        <li>Use the toolbar to format your text</li>
                        <li>Add tags to organize your notes</li>
                    </ul>
                    <h2><i class="ph ph-folders"></i> Organizing with Folders</h2>
                    <ul>
                        <li>Right-click in the sidebar to create folders</li>
                        <li>Drag and drop notes between folders</li>
                        <li>Create nested folders for better organization</li>
                    </ul>
                    <h2><i class="ph ph-link"></i> Linking Notes</h2>
                    <p>Type <code>[[Note Title]]</code> or use the link button to create connections between notes. Backlinks are automatically tracked!</p>
                    <h2><i class="ph ph-tag"></i> Tags</h2>
                    <p>Add tags to your notes for cross-cutting organization. Click any tag in the sidebar to filter.</p>
                    <h2><i class="ph ph-lightbulb"></i> Pro Tips</h2>
                    <ul>
                        <li>Use <strong>Cmd/Ctrl + K</strong> to quickly search</li>
                        <li>Try Focus Mode for distraction-free writing</li>
                        <li>Your data stays on your device - completely private</li>
                    </ul>
                    <p>Happy writing! <i class="ph ph-sparkle"></i></p>
                `;

                const note = {
                    id: 'note_welcome',
                    title: '\u003ci class="ph ph-waving-hand"\u003e\u003c/i\u003e Welcome to Knowledge Base',
                    content: welcomeContent,
                    folderId: 'root',
                    tags: ['getting-started', 'tutorial'],
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                this.data.notes.push(note);
                this.saveData();
                this.selectNote(note.id);
            }

            updateNote(id, updates) {
                const note = this.data.notes.find(n => n.id === id);
                if (note) {
                    const titleChanged = updates.title && updates.title !== note.title;
                    Object.assign(note, updates, { updatedAt: Date.now() });
                    this.saveData();
                    this.renderBacklinks();
                    // Re-render sidebar if title changed to update folder tree
                    if (titleChanged) {
                        this.render();
                    }
                }
            }

            deleteNote(id) {
                const note = this.data.notes.find(n => n.id === id);
                if (!note) return;

                // Move to trash instead of permanent delete
                if (!this.data.trash) this.data.trash = [];
                this.data.trash.push({
                    type: 'note',
                    id: note.id,
                    title: note.title,
                    content: note.content,
                    folderId: note.folderId,
                    tags: note.tags,
                    deletedAt: Date.now()
                });

                // Remove from open tabs if present
                this.openTabs = this.openTabs.filter(tabId => tabId !== id);

                this.data.notes = this.data.notes.filter(n => n.id !== id);
                if (this.currentNote?.id === id) {
                    this.currentNote = null;
                    this.showEmptyState();
                }
                this.saveData();
                this.render();
                this.showToast('Note moved to Trash', 'success');
            }

            duplicateNote(id) {
                const note = this.data.notes.find(n => n.id === id);
                if (note) {
                    const newNote = {
                        ...note,
                        id: 'note_' + Date.now(),
                        title: note.title + ' (Copy)',
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    };
                    this.data.notes.push(newNote);
                    this.saveData();
                    this.render();
                    this.selectNote(newNote.id);
                    this.showToast('Note duplicated', 'success');
                }
            }

            renameNote(id) {
                const note = this.data.notes.find(n => n.id === id);
                if (note) {
                    const newTitle = prompt('Enter new note title:', note.title);
                    if (newTitle && newTitle.trim()) {
                        note.title = newTitle.trim();
                        note.updatedAt = Date.now();
                        this.saveData();
                        this.render();
                        this.showToast('Note renamed', 'success');
                    }
                }
            }

            moveNote(noteId, folderId) {
                const note = this.data.notes.find(n => n.id === noteId);
                if (note) {
                    note.folderId = folderId;
                    this.saveData();
                    this.render();
                    this.showToast('Note moved', 'success');
                }
            }

            reorderNote(draggedId, targetId, insertBefore) {
                const draggedIndex = this.data.notes.findIndex(n => n.id === draggedId);
                const targetIndex = this.data.notes.findIndex(n => n.id === targetId);

                if (draggedIndex === -1 || targetIndex === -1) return;

                // Remove dragged note from array
                const [draggedNote] = this.data.notes.splice(draggedIndex, 1);

                // Calculate new index after removal
                let newIndex = this.data.notes.findIndex(n => n.id === targetId);
                if (!insertBefore) newIndex++;

                // Insert at new position
                this.data.notes.splice(newIndex, 0, draggedNote);

                this.saveData();
                this.render();
                this.showToast('Note reordered', 'success');
            }

            selectNote(id) {
                const note = this.data.notes.find(n => n.id === id);
                if (!note) return;

                // Check if already open in a tab
                if (!this.openTabs.includes(id)) {
                    this.openTabs.push(id);
                }

                this.activeTabId = id;
                this.renderTabs();
                this.loadNoteIntoEditor(note);
            }

            loadNoteIntoEditor(note) {
                this.currentNote = note;
                this.currentFolder = note.folderId;

                // Show editor
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('editorToolbar').classList.remove('hidden');
                document.getElementById('tabsBar').classList.remove('hidden');
                document.getElementById('editorContentWrapper').classList.remove('hidden');
                document.getElementById('backlinksPanel').classList.remove('hidden');

                // Populate fields
                document.getElementById('noteTitle').value = note.title;
                document.getElementById('wysiwygEditor').innerHTML = note.content;
                document.getElementById('headerTitle').textContent = '';

                // Update date
                const date = new Date(note.updatedAt);
                let dateText = 'Updated ' + date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Add clipped indicator if applicable
                if (note.clippedFrom) {
                    dateText += '  Clipped from web';
                }
                
                document.getElementById('noteDate').textContent = dateText;

                // Update tags
                this.renderNoteTags();

                // Reset and update tasks for new note
                this.renderTasks();

                // Apply font preference
                const editor = document.getElementById('wysiwygEditor');
                editor.classList.remove('font-serif', 'font-mono');
                if (note.fontFamily === 'serif') {
                    editor.classList.add('font-serif');
                } else if (note.fontFamily === 'mono') {
                    editor.classList.add('font-mono');
                }

                // Apply toggle preferences - ensure defaults are respected
                const editorContent = document.querySelector('.editor-content');
                editor.classList.toggle('small-text', !!note.smallText);
                editorContent.classList.toggle('full-width', !!note.fullWidth);

                // Update menu toggle indicators
                const noteMenuDropdown = document.getElementById('noteMenuDropdown');
                if (noteMenuDropdown) {
                    noteMenuDropdown.querySelectorAll('.note-menu-font-option').forEach(opt => {
                        opt.classList.toggle('active', opt.dataset.font === (note.fontFamily || 'default'));
                    });
                    const smallTextToggle = document.getElementById('smallTextToggle');
                    const fullWidthToggle = document.getElementById('fullWidthToggle');
                    if (smallTextToggle) {
                        smallTextToggle.textContent = note.smallText ? '' : '';
                        smallTextToggle.classList.toggle('on', !!note.smallText);
                    }
                    if (fullWidthToggle) {
                        fullWidthToggle.textContent = note.fullWidth ? '' : '';
                        fullWidthToggle.classList.toggle('on', !!note.fullWidth);
                    }
                }

                // Update breadcrumb
                this.renderBreadcrumb();

                // Update backlinks
                this.renderBacklinks();

                // Update active states
                this.updateActiveStates();

                // Auto-save on content change
                this.setupAutoSave();
            }

            renderTabs() {
                const container = document.getElementById('tabsContainer');
                if (!container) return;

                container.innerHTML = this.openTabs.map(noteId => {
                    const note = this.data.notes.find(n => n.id === noteId);
                    if (!note) return '';
                    const isActive = noteId === this.activeTabId;
                    return `
                        <div class="tab ${isActive ? 'active' : ''}" data-note-id="${noteId}">
                            <span class="tab-title">${this.escapeHtml(note.title || 'Untitled')}</span>
                            <span class="tab-close" data-note-id="${noteId}"></span>
                        </div>
                    `;
                }).join('');

                // Add click handlers
                container.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        if (e.target.classList.contains('tab-close')) {
                            e.stopPropagation();
                            this.closeTab(tab.dataset.noteId);
                        } else {
                            this.switchTab(tab.dataset.noteId);
                        }
                    });
                });
            }

            switchTab(noteId) {
                if (!this.openTabs.includes(noteId)) return;
                const note = this.data.notes.find(n => n.id === noteId);
                if (!note) {
                    this.closeTab(noteId);
                    return;
                }
                this.activeTabId = noteId;
                this.renderTabs();
                this.loadNoteIntoEditor(note);
            }

            closeTab(noteId) {
                const index = this.openTabs.indexOf(noteId);
                if (index === -1) return;

                this.openTabs.splice(index, 1);

                if (this.activeTabId === noteId) {
                    // Switch to another tab
                    if (this.openTabs.length > 0) {
                        const newIndex = index < this.openTabs.length ? index : this.openTabs.length - 1;
                        this.switchTab(this.openTabs[newIndex]);
                    } else {
                        // No tabs left
                        this.activeTabId = null;
                        this.currentNote = null;
                        this.showEmptyState();
                    }
                }

                this.renderTabs();
            }

            showEmptyState() {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('editorToolbar').classList.add('hidden');
                document.getElementById('tabsBar').classList.add('hidden');
                document.getElementById('editorContentWrapper').classList.add('hidden');
                document.getElementById('backlinksPanel').classList.add('hidden');
                document.getElementById('headerTitle').textContent = '';
            }

            // ==================== TAG OPERATIONS ====================

            addTagToNote(noteId, tagName) {
                const note = this.data.notes.find(n => n.id === noteId);
                if (note && !note.tags.includes(tagName)) {
                    note.tags.push(tagName);
                    if (!this.data.tags.includes(tagName)) {
                        this.data.tags.push(tagName);
                    }
                    this.saveData();
                    this.renderNoteTags();
                    this.renderTagsCloud();
                }
            }

            removeTagFromNote(noteId, tagName) {
                const note = this.data.notes.find(n => n.id === noteId);
                if (note) {
                    note.tags = note.tags.filter(t => t !== tagName);
                    this.saveData();
                    this.renderNoteTags();
                    this.renderTagsCloud();
                }
            }

            getAllTags() {
                const tags = new Set();
                this.data.notes.forEach(note => {
                    note.tags.forEach(tag => tags.add(tag));
                });
                return Array.from(tags).sort();
            }

            // ==================== RENDERING ====================

            render() {
                this.renderClippedPages();
                this.renderFavorites();
                this.renderFolderTree();
                this.renderTagsCloud();
                this.updateActiveStates();
                this.updateTrashCount();

                // Debug: Log folder state
                console.log('Folders:', this.data.folders.map(f => ({id: f.id, name: f.name, parentId: f.parentId})));
            }

            updateTrashCount() {
                const count = this.data.trash?.length || 0;
                const trashCountEl = document.getElementById('trashCount');
                if (trashCountEl) {
                    trashCountEl.textContent = count === 1 ? '1 item in trash' : `${count} items in trash`;
                }
            }

            openTrashModal() {
                const modal = document.getElementById('trashModal');
                const emptyState = document.getElementById('trashEmptyState');
                const itemsList = document.getElementById('trashItemsList');
                const container = document.getElementById('trashItemsContainer');
                
                const trashItems = this.data.trash || [];
                
                if (trashItems.length === 0) {
                    emptyState.style.display = 'block';
                    itemsList.style.display = 'none';
                } else {
                    emptyState.style.display = 'none';
                    itemsList.style.display = 'block';
                    
                    // Sort by deleted date (newest first)
                    const sorted = [...trashItems].sort((a, b) => b.deletedAt - a.deletedAt);
                    
                    container.innerHTML = sorted.map(item => `
                        <div class="trash-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border);" data-id="${item.id}">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0;">
                                <i class="ph ${item.type === 'folder' ? 'ph-folder' : 'ph-file-text'}" style="color: var(--text-tertiary); font-size: 20px;"></i>
                                <div style="min-width: 0;">
                                    <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${this.escapeHtml(item.name || item.title || 'Untitled')}</div>
                                    <div style="font-size: 12px; color: var(--text-tertiary);">${item.type === 'folder' ? 'Folder' : 'Note'}  Deleted ${new Date(item.deletedAt).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary restore-trash-item" data-id="${item.id}" style="padding: 6px 12px; font-size: 13px; white-space: nowrap;">
                                <i class="ph ph-arrow-counter-clockwise"></i> Restore
                            </button>
                        </div>
                    `).join('');
                    
                    // Add restore listeners
                    container.querySelectorAll('.restore-trash-item').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.restoreFromTrash(btn.dataset.id);
                            this.openTrashModal(); // Refresh the modal
                        });
                    });
                }
                
                modal.classList.add('active');
                
                // Setup close buttons
                document.getElementById('closeTrashModal').onclick = () => modal.classList.remove('active');
                document.getElementById('closeTrashBtn').onclick = () => modal.classList.remove('active');
                
                // Setup empty trash button
                document.getElementById('emptyTrashNowBtn').onclick = () => {
                    if (trashItems.length === 0) {
                        this.showToast('Trash is already empty', 'info');
                        return;
                    }
                    if (confirm(`Delete ${trashItems.length} item(s) permanently? This cannot be undone.`)) {
                        this.data.trash = [];
                        this.saveData();
                        this.render();
                        this.openTrashModal(); // Refresh
                        this.showToast('Trash emptied', 'success');
                    }
                };
            }

            renderFolderTree() {
                const tree = document.getElementById('folderTree');
                if (!tree) {
                    console.error('folderTree element not found!');
                    return;
                }
                tree.innerHTML = '';

                console.log('Rendering folders:', this.data.folders.length);

                const renderFolder = (parentId, level = 0) => {
                    const folders = this.data.folders.filter(f => f.parentId === parentId && f.id !== 'root');
                    console.log(`Found ${folders.length} folders with parent ${parentId}`);

                    if (folders.length === 0) return null;

                    const ul = document.createElement('ul');
                    ul.className = level === 0 ? 'folder-tree' : 'folder-children';
                    if (level > 0) ul.style.paddingLeft = '16px';

                    folders.forEach(folder => {
                        const li = document.createElement('li');
                        li.className = 'folder-item';

                        const noteCount = this.data.notes.filter(n => {
                            if (n.folderId === folder.id) return true;
                            const childIds = this.getChildFolderIds(folder.id);
                            return childIds.includes(n.folderId);
                        }).length;

                        const hasChildren = this.data.folders.some(f => f.parentId === folder.id);
                        const isCollapsed = this.data.settings.sidebarCollapsed?.[folder.id];

                        li.innerHTML = `
                            <div class="folder-header ${this.currentFolder === folder.id ? 'active' : ''}"
                                 data-folder="${folder.id}"
                                 style="padding-left: ${8 + level * 4}px">
                                ${hasChildren ? `<span class="folder-toggle ${isCollapsed ? 'collapsed' : ''}"></span>` : '<span class="folder-toggle" style="visibility: hidden;"></span>'}
                                <span class="folder-icon"><i class="ph ph-folder"></i></span>
                                <span class="folder-name">${this.escapeHtml(folder.name)}</span>
                                <span class="folder-count">${noteCount}</span>
                                <div class="folder-actions">
                                    <button class="folder-action-btn add-page" title="Add a new note"><i class="ph ph-plus"></i></button>
                                    <button class="folder-action-btn more-menu" title="More options"><i class="ph ph-dots-three"></i></button>
                                    <div class="folder-dropdown" id="dropdown-${folder.id}">
                                        <div class="folder-dropdown-item" data-action="favorite">
                                            <span class="folder-dropdown-icon"><i class="ph ph-star"></i></span>
                                            <span>Add to Favorites</span>
                                        </div>
                                        <div class="folder-dropdown-item" data-action="duplicate">
                                            <span class="folder-dropdown-icon"><i class="ph ph-copy"></i></span>
                                            <span>Duplicate</span>
                                        </div>
                                        <div class="folder-dropdown-item" data-action="rename">
                                            <span class="folder-dropdown-icon"><i class="ph ph-pencil-simple"></i></span>
                                            <span>Rename</span>
                                        </div>
                                        <div class="folder-dropdown-divider"></div>
                                        <div class="folder-dropdown-item delete" data-action="delete">
                                            <span class="folder-dropdown-icon"><i class="ph ph-trash"></i></span>
                                            <span>Move to Trash</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        const header = li.querySelector('.folder-header');

                        // Click to toggle expand/collapse (if has children) or select
                        header.addEventListener('click', (e) => {
                            // Ignore clicks on buttons
                            if (e.target.classList.contains('folder-action-btn') ||
                                e.target.closest('.folder-dropdown')) return;

                            // Always toggle collapse state on click
                            if (!this.data.settings.sidebarCollapsed) {
                                this.data.settings.sidebarCollapsed = {};
                            }
                            this.data.settings.sidebarCollapsed[folder.id] = !isCollapsed;
                            this.saveData();
                            this.renderFolderTree();
                        });

                        // Context menu
                        header.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            this.showContextMenu(e, 'folder', folder.id);
                        });

                        // DROP ZONE: Allow notes to be dropped onto this folder
                        header.addEventListener('dragover', (e) => {
                            if (!this.draggedNote) return;
                            e.preventDefault();
                            e.dataTransfer.dropEffect = 'move';
                            header.classList.add('drag-over');
                        });

                        header.addEventListener('dragleave', () => {
                            header.classList.remove('drag-over');
                        });

                        header.addEventListener('drop', (e) => {
                            if (!this.draggedNote) return;
                            e.preventDefault();
                            e.stopPropagation();
                            header.classList.remove('drag-over');

                            const note = this.data.notes.find(n => n.id === this.draggedNote);
                            if (note && note.folderId !== folder.id) {
                                note.folderId = folder.id;
                                this.saveData();
                                this.render();
                                this.showToast(`Moved to ${folder.name}`, 'success');
                            }
                            this.draggedNote = null;
                        });

                        // FOLDER DRAG/DROP - all folders can receive drops
                        // DROP: Move folder to be a child of this folder
                        header.addEventListener('dragover', (e) => {
                            if (!this.draggedFolder || this.draggedFolder === folder.id) return;
                            const dragged = this.data.folders.find(f => f.id === this.draggedFolder);
                            if (!dragged) return;

                            // Prevent dropping a parent into its own child (would create cycle)
                            if (this.isDescendant(folder.id, dragged.id)) return;

                            e.preventDefault();
                            e.dataTransfer.dropEffect = 'move';

                            const rect = header.getBoundingClientRect();
                            const y = e.clientY - rect.top;
                            const h = rect.height;

                            // Clear previous indicators
                            header.style.borderTop = '';
                            header.style.borderBottom = '';
                            header.classList.remove('drag-over');

                            if (y < h * 0.25) {
                                // Top 25% - reorder before
                                header.style.borderTop = '3px solid var(--accent)';
                                header.title = 'Drop to move before';
                            } else if (y > h * 0.75) {
                                // Bottom 25% - reorder after
                                header.style.borderBottom = '3px solid var(--accent)';
                                header.title = 'Drop to move after';
                            } else {
                                // Middle 50% - nest as child
                                header.classList.add('drag-over');
                                header.title = 'Drop to nest inside';
                            }
                        });

                        header.addEventListener('dragleave', () => {
                            header.style.borderTop = '';
                            header.style.borderBottom = '';
                            header.classList.remove('drag-over');
                            header.title = '';
                        });

                        header.addEventListener('drop', (e) => {
                            if (!this.draggedFolder || this.draggedFolder === folder.id) return;
                            const dragged = this.data.folders.find(f => f.id === this.draggedFolder);
                            if (!dragged) return;

                            // Prevent dropping a parent into its own child
                            if (this.isDescendant(folder.id, dragged.id)) return;

                            e.preventDefault();
                            e.stopPropagation();
                            header.style.borderTop = '';
                            header.style.borderBottom = '';
                            header.classList.remove('drag-over');
                            header.title = '';

                            const rect = header.getBoundingClientRect();
                            const y = e.clientY - rect.top;
                            const h = rect.height;

                            if (y < h * 0.25) {
                                // Top - reorder before
                                this.reorderFolder(this.draggedFolder, folder.id, true);
                            } else if (y > h * 0.75) {
                                // Bottom - reorder after
                                this.reorderFolder(this.draggedFolder, folder.id, false);
                            } else {
                                // Middle - nest as child
                                dragged.parentId = folder.id;
                                this.saveData();
                                this.render();
                                this.showToast(`Moved into ${folder.name}`, 'success');
                            }
                            this.draggedFolder = null;
                        });

                        // DRAG: Only non-system folders can be dragged
                        if (!this.isSystemFolder(folder.id)) {
                            header.draggable = true;

                            header.addEventListener('dragstart', (e) => {
                                this.draggedFolder = folder.id;
                                header.style.opacity = '0.5';
                                e.dataTransfer.effectAllowed = 'move';
                            });

                            header.addEventListener('dragend', () => {
                                header.style.opacity = '';
                                this.draggedFolder = null;
                                document.querySelectorAll('.folder-header').forEach(h => {
                                    h.style.borderTop = '';
                                    h.style.borderBottom = '';
                                    h.classList.remove('drag-over');
                                });
                            });
                        }

                        // Add page button (plus icon)
                        const addPageBtn = li.querySelector('.folder-action-btn.add-page');
                        if (addPageBtn) {
                            addPageBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.createNote('', folder.id);
                            });
                        }

                        // More menu button (three dots)
                        const moreMenuBtn = li.querySelector('.folder-action-btn.more-menu');
                        const dropdown = li.querySelector(`#dropdown-${folder.id}`);

                        if (moreMenuBtn && dropdown) {
                            moreMenuBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                // Close other dropdowns
                                document.querySelectorAll('.folder-dropdown.show').forEach(d => {
                                    if (d !== dropdown) d.classList.remove('show');
                                });
                                dropdown.classList.toggle('show');
                            });

                            // Handle dropdown item clicks
                            dropdown.querySelectorAll('.folder-dropdown-item').forEach(item => {
                                item.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    const action = item.dataset.action;
                                    dropdown.classList.remove('show');

                                    switch(action) {
                                        case 'favorite':
                                            this.addFolderToFavorites(folder.id);
                                            break;
                                        case 'duplicate':
                                            this.duplicateFolder(folder.id);
                                            break;
                                        case 'rename':
                                            this.renameFolder(folder.id);
                                            break;
                                        case 'delete':
                                            this.deleteFolder(folder.id);
                                            break;
                                    }
                                });
                            });
                        }

                        // Close dropdown when clicking outside
                        document.addEventListener('click', () => {
                            if (dropdown) dropdown.classList.remove('show');
                        });

                        // Drag and drop: Header = move as child, List item = reorder

                        // DRAG AND DROP DISABLED - TOO BUGGY
                        // Simple drag indicators only - no actual drag functionality
                        /*
                        li.draggable = true;

                        li.addEventListener('dragstart', (e) => {
                            this.draggedFolder = folder.id;
                            li.style.opacity = '0.5';
                            e.dataTransfer.effectAllowed = 'move';
                        });

                        li.addEventListener('dragend', () => {
                            li.style.opacity = '1';
                            document.querySelectorAll('.folder-item').forEach(item => {
                                item.style.borderTop = '';
                                item.style.borderBottom = '';
                            });
                            this.draggedFolder = null;
                        });

                        li.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            if (!this.draggedFolder || this.draggedFolder === folder.id) return;

                            const rect = li.getBoundingClientRect();
                            const midY = rect.top + rect.height / 2;

                            if (e.clientY < midY) {
                                li.style.borderTop = '2px solid var(--accent)';
                                li.style.borderBottom = '';
                            } else {
                                li.style.borderTop = '';
                                li.style.borderBottom = '2px solid var(--accent)';
                            }
                        });

                        li.addEventListener('dragleave', () => {
                            li.style.borderTop = '';
                            li.style.borderBottom = '';
                        });

                        li.addEventListener('drop', (e) => {
                            e.preventDefault();
                            e.stopPropagation();

                            li.style.borderTop = '';
                            li.style.borderBottom = '';

                            if (!this.draggedFolder || this.draggedFolder === folder.id) return;

                            const draggedFolder = this.data.folders.find(f => f.id === this.draggedFolder);
                            if (!draggedFolder) return;

                            // Move to same parent as target
                            if (draggedFolder.parentId !== folder.parentId) {
                                draggedFolder.parentId = folder.parentId;
                            }

                            const rect = li.getBoundingClientRect();
                            const midY = rect.top + rect.height / 2;
                            const insertBefore = e.clientY < midY;

                            this.reorderFolder(this.draggedFolder, folder.id, insertBefore);
                            this.draggedFolder = null;
                        });
                        */

                        // Render children
                        if (hasChildren && !isCollapsed) {
                            const children = renderFolder(folder.id, level + 1);
                            li.appendChild(children);
                        }

                        // Render notes in this folder (only if expanded)
                        if (!isCollapsed) {
                            const notes = this.data.notes.filter(n => n.folderId === folder.id);
                            if (notes.length > 0) {
                                const notesUl = document.createElement('ul');
                                notesUl.className = 'folder-children';
                                notes.forEach(note => {
                                    const noteLi = document.createElement('li');
                                    noteLi.className = `note-item ${this.currentNote?.id === note.id ? 'active' : ''}`;
                                    noteLi.draggable = true;
                                    noteLi.dataset.noteId = note.id;
                                    noteLi.innerHTML = `
                                        <span class="note-icon"><i class="ph ph-file-text"></i></span>
                                        <span class="note-title">${this.escapeHtml(note.title)}</span>
                                        <div class="note-actions">
                                            <button class="note-action-btn more-menu" title="More options"><i class="ph ph-dots-three"></i></button>
                                            <div class="note-dropdown" id="note-dropdown-${note.id}">
                                                <div class="note-dropdown-item" data-action="rename">Rename</div>
                                                <div class="note-dropdown-item" data-action="duplicate">Duplicate</div>
                                                <div class="note-dropdown-item delete" data-action="delete">Delete</div>
                                            </div>
                                        </div>
                                    `;

                                    noteLi.addEventListener('click', () => this.selectNote(note.id));
                                    noteLi.addEventListener('contextmenu', (e) => {
                                        e.preventDefault();
                                        this.showContextMenu(e, 'note', note.id);
                                    });

                                    // Note dropdown menu
                                    const moreMenuBtn = noteLi.querySelector('.note-action-btn.more-menu');
                                    const dropdown = noteLi.querySelector(`#note-dropdown-${note.id}`);

                                    if (moreMenuBtn && dropdown) {
                                        moreMenuBtn.addEventListener('click', (e) => {
                                            e.stopPropagation();
                                            // Close other dropdowns
                                            document.querySelectorAll('.note-dropdown.show').forEach(d => {
                                                if (d !== dropdown) d.classList.remove('show');
                                            });
                                            dropdown.classList.toggle('show');
                                        });

                                        // Handle dropdown item clicks
                                        dropdown.querySelectorAll('.note-dropdown-item').forEach(item => {
                                            item.addEventListener('click', (e) => {
                                                e.stopPropagation();
                                                const action = item.dataset.action;
                                                dropdown.classList.remove('show');

                                                switch(action) {
                                                    case 'rename':
                                                        this.renameNote(note.id);
                                                        break;
                                                    case 'duplicate':
                                                        this.duplicateNote(note.id);
                                                        break;
                                                    case 'delete':
                                                        this.deleteNote(note.id);
                                                        break;
                                                }
                                            });
                                        });
                                    }

                                    // Close dropdown when clicking outside
                                    document.addEventListener('click', () => {
                                        if (dropdown) dropdown.classList.remove('show');
                                    });

                                    // Drag start
                                    noteLi.addEventListener('dragstart', (e) => {
                                        this.draggedNote = note.id;
                                        this.draggedNoteSourceFolder = folder.id;
                                        noteLi.classList.add('dragging');
                                        e.dataTransfer.effectAllowed = 'move';
                                    });

                                    noteLi.addEventListener('dragend', () => {
                                        noteLi.classList.remove('dragging');
                                        this.draggedNote = null;
                                        this.draggedNoteSourceFolder = null;
                                        // Clear all drop indicators
                                        document.querySelectorAll('.note-item').forEach(el => {
                                            el.style.borderTop = '';
                                            el.style.borderBottom = '';
                                        });
                                    });

                                    // Drag over for reordering within same folder
                                    noteLi.addEventListener('dragover', (e) => {
                                        if (!this.draggedNote || this.draggedNote === note.id) return;
                                        // Only allow reordering if from same folder
                                        if (this.draggedNoteSourceFolder !== folder.id) return;

                                        e.preventDefault();
                                        e.dataTransfer.dropEffect = 'move';

                                        const rect = noteLi.getBoundingClientRect();
                                        const midY = rect.top + rect.height / 2;

                                        if (e.clientY < midY) {
                                            noteLi.style.borderTop = '2px solid var(--accent)';
                                            noteLi.style.borderBottom = '';
                                        } else {
                                            noteLi.style.borderTop = '';
                                            noteLi.style.borderBottom = '2px solid var(--accent)';
                                        }
                                    });

                                    noteLi.addEventListener('dragleave', () => {
                                        noteLi.style.borderTop = '';
                                        noteLi.style.borderBottom = '';
                                    });

                                    noteLi.addEventListener('drop', (e) => {
                                        if (!this.draggedNote || this.draggedNote === note.id) return;
                                        // Only allow reordering if from same folder
                                        if (this.draggedNoteSourceFolder !== folder.id) return;

                                        e.preventDefault();
                                        e.stopPropagation();
                                        noteLi.style.borderTop = '';
                                        noteLi.style.borderBottom = '';

                                        const rect = noteLi.getBoundingClientRect();
                                        const midY = rect.top + rect.height / 2;
                                        const insertBefore = e.clientY < midY;

                                        this.reorderNote(this.draggedNote, note.id, insertBefore);
                                    });

                                    notesUl.appendChild(noteLi);
                                });
                                li.appendChild(notesUl);
                            }
                        }

                        ul.appendChild(li);
                    });

                    return ul;
                };

                const rootUl = renderFolder(null);

                // TOP DROP ZONE for reordering main folders at the top
                const topDropZone = document.createElement('div');
                topDropZone.className = 'folder-reorder-zone';
                topDropZone.style.cssText = 'height: 8px; margin-bottom: 4px; border-radius: 4px; transition: all 0.2s;';
                topDropZone.title = 'Drop here to move folder to top';

                topDropZone.addEventListener('dragover', (e) => {
                    if (!this.draggedFolder) return;
                    const dragged = this.data.folders.find(f => f.id === this.draggedFolder);
                    if (!dragged || dragged.parentId !== null) return; // Only for main folders

                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    topDropZone.style.background = 'var(--accent)';
                    topDropZone.style.height = '20px';
                });

                topDropZone.addEventListener('dragleave', () => {
                    topDropZone.style.background = '';
                    topDropZone.style.height = '8px';
                });

                topDropZone.addEventListener('drop', (e) => {
                    if (!this.draggedFolder) return;
                    const dragged = this.data.folders.find(f => f.id === this.draggedFolder);
                    if (!dragged || dragged.parentId !== null) return;

                    e.preventDefault();
                    topDropZone.style.background = '';
                    topDropZone.style.height = '8px';

                    // Get main folders
                    const mainFolders = this.data.folders.filter(f => f.parentId === null && f.id !== 'root');
                    if (mainFolders.length < 2) return;

                    // Move dragged to first position
                    const draggedIndex = this.data.folders.findIndex(f => f.id === this.draggedFolder);
                    const [movedFolder] = this.data.folders.splice(draggedIndex, 1);

                    // Find insert position (after root, before first non-root main folder)
                    const rootIndex = this.data.folders.findIndex(f => f.id === 'root');
                    let insertIndex = rootIndex + 1;
                    this.data.folders.splice(insertIndex, 0, movedFolder);

                    this.saveData();
                    this.render();
                    this.showToast('Folder moved to top', 'success');
                    this.draggedFolder = null;
                });

                tree.appendChild(topDropZone);

                if (rootUl) {
                    tree.appendChild(rootUl);
                    console.log('Folder tree rendered successfully');
                } else {
                    console.log('No root folders found');
                    tree.innerHTML = '<div style="padding: 20px; color: var(--text-tertiary); text-align: center;">No folders found</div>';
                }

                // ROOT DROP ZONE: Move folders to become main folders (parentId: null)
                const rootDropZone = document.createElement('div');
                rootDropZone.className = 'root-drop-zone';
                rootDropZone.style.cssText = 'height: 20px; margin-top: 10px; border-radius: 4px; transition: all 0.2s;';
                rootDropZone.title = 'Drop folder here to make it a main folder';

                rootDropZone.addEventListener('dragover', (e) => {
                    if (!this.draggedFolder) return;
                    const dragged = this.data.folders.find(f => f.id === this.draggedFolder);
                    if (!dragged || dragged.parentId === null) return; // Already a main folder

                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    rootDropZone.style.background = 'var(--accent)';
                    rootDropZone.style.height = '40px';
                });

                rootDropZone.addEventListener('dragleave', () => {
                    rootDropZone.style.background = '';
                    rootDropZone.style.height = '20px';
                });

                rootDropZone.addEventListener('drop', (e) => {
                    if (!this.draggedFolder) return;
                    const dragged = this.data.folders.find(f => f.id === this.draggedFolder);
                    if (!dragged || dragged.parentId === null) return;

                    e.preventDefault();
                    rootDropZone.style.background = '';
                    rootDropZone.style.height = '20px';

                    // Move to root level
                    dragged.parentId = null;
                    this.saveData();
                    this.render();
                    this.showToast('Moved to main folders', 'success');
                    this.draggedFolder = null;
                });

                tree.appendChild(rootDropZone);
            }

            getChildFolderIds(parentId) {
                const ids = [];
                const children = this.data.folders.filter(f => f.parentId === parentId);
                children.forEach(child => {
                    ids.push(child.id);
                    ids.push(...this.getChildFolderIds(child.id));
                });
                return ids;
            }

            renderTagsCloud() {
                const container = document.getElementById('tagsAlphabetical');
                const searchInput = document.getElementById('tagsSearch');
                const tags = this.getAllTags().sort();

                if (tags.length === 0) {
                    container.innerHTML = '<div style="padding: 12px; color: var(--text-tertiary); font-size: 12px; text-align: center;">No tags yet</div>';
                    return;
                }

                // Group tags by first letter
                const groups = {};
                tags.forEach(tag => {
                    const letter = tag.charAt(0).toUpperCase();
                    if (!groups[letter]) groups[letter] = [];
                    groups[letter].push(tag);
                });

                const render = (filter = '') => {
                    const filteredTags = filter
                        ? tags.filter(t => t.toLowerCase().includes(filter.toLowerCase()))
                        : tags;

                    if (filteredTags.length === 0) {
                        container.innerHTML = '<div style="padding: 12px; color: var(--text-tertiary); font-size: 12px; text-align: center;">No matching tags</div>';
                        return;
                    }

                    // Re-group filtered tags
                    const filteredGroups = {};
                    filteredTags.forEach(tag => {
                        const letter = tag.charAt(0).toUpperCase();
                        if (!filteredGroups[letter]) filteredGroups[letter] = [];
                        filteredGroups[letter].push(tag);
                    });

                    container.innerHTML = Object.keys(filteredGroups).sort().map(letter => {
                        const letterTags = filteredGroups[letter];
                        const isCollapsed = this.data.settings?.tagsCollapsed?.[letter];

                        return `
                            <div class="tags-letter-group">
                                <div class="tags-letter-header" data-letter="${letter}">
                                    <span>${letter} (${letterTags.length})</span>
                                    <span class="tags-letter-toggle ${isCollapsed ? 'collapsed' : ''}"></span>
                                </div>
                                <div class="tags-letter-content ${isCollapsed ? 'collapsed' : ''}">
                                    ${letterTags.map(tag => {
                                        const count = this.data.notes.filter(n => n.tags.includes(tag)).length;
                                        return `<span class="tag-item-small ${this.currentTagFilter === tag ? 'active' : ''}" data-tag="${this.escapeHtml(tag)}">${this.escapeHtml(tag)} <span class="tag-count">${count}</span></span>`;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Add click handlers
                    container.querySelectorAll('.tags-letter-header').forEach(header => {
                        header.addEventListener('click', () => {
                            const letter = header.dataset.letter;
                            const content = header.nextElementSibling;
                            const toggle = header.querySelector('.tags-letter-toggle');

                            content.classList.toggle('collapsed');
                            toggle.classList.toggle('collapsed');

                            // Save preference
                            if (!this.data.settings.tagsCollapsed) this.data.settings.tagsCollapsed = {};
                            this.data.settings.tagsCollapsed[letter] = content.classList.contains('collapsed');
                            this.saveData();
                        });
                    });

                    container.querySelectorAll('.tag-item-small').forEach(el => {
                        el.addEventListener('click', () => {
                            const tag = el.dataset.tag;
                            this.filterByTag(tag);
                        });
                    });
                };

                // Initial render
                render();

                // Search handler
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        render(e.target.value);
                    });
                }
            }

            renderNoteTags() {
                const container = document.getElementById('noteTagsInput');
                const input = document.getElementById('tagInput');

                // Clear existing tags (keep input)
                Array.from(container.children).forEach(child => {
                    if (!child.classList.contains('tag-input')) {
                        child.remove();
                    }
                });

                // Add tags before input
                if (this.currentNote) {
                    this.currentNote.tags.forEach(tag => {
                        const tagEl = document.createElement('span');
                        tagEl.className = 'note-tag';
                        tagEl.innerHTML = `
                            ${this.escapeHtml(tag)}
                            <span class="note-tag-remove" data-tag="${this.escapeHtml(tag)}"></span>
                        `;
                        container.insertBefore(tagEl, input);

                        tagEl.querySelector('.note-tag-remove').addEventListener('click', () => {
                            this.removeTagFromNote(this.currentNote.id, tag);
                        });
                    });
                }
            }

            renderBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                if (!this.currentNote) {
                    breadcrumb.innerHTML = '<span class="breadcrumb-item" data-folder="root">All Notes</span>';
                    return;
                }

                const path = this.getFolderPath(this.currentNote.folderId);
                breadcrumb.innerHTML = path.map((folder, i) => `
                    <span class="breadcrumb-item" data-folder="${folder.id}">${this.escapeHtml(folder.name)}</span>
                    ${i < path.length - 1 ? '<span class="breadcrumb-separator">/</span>' : ''}
                `).join('');

                breadcrumb.querySelectorAll('.breadcrumb-item').forEach(el => {
                    el.addEventListener('click', () => {
                        this.selectFolder(el.dataset.folder);
                    });
                });
            }

            renderBacklinks() {
                const panel = document.getElementById('backlinksPanel');
                const list = document.getElementById('backlinksList');

                if (!this.currentNote) {
                    panel.classList.add('hidden');
                    return;
                }

                // Find notes that link to this note
                const noteTitle = this.currentNote.title;
                const backlinks = this.data.notes.filter(n => {
                    if (n.id === this.currentNote.id) return false;
                    const linkPattern = new RegExp(`\\[\\[${this.escapeRegex(noteTitle)}\\]\\]|href=["']note:${this.escapeRegex(this.currentNote.id)}["']`, 'i');
                    return linkPattern.test(n.content);
                });

                if (backlinks.length === 0) {
                    panel.classList.add('hidden');
                    return;
                }

                panel.classList.remove('hidden');
                list.innerHTML = backlinks.map(note => `
                    <div class="backlink-item" data-note="${note.id}">
                        <span class="backlink-icon"><i class="ph ph-file-text"></i></span>
                        <span>${this.escapeHtml(note.title)}</span>
                    </div>
                `).join('');

                list.querySelectorAll('.backlink-item').forEach(el => {
                    el.addEventListener('click', () => this.selectNote(el.dataset.note));
                });
            }

            updateActiveStates() {
                // Update folder active states
                document.querySelectorAll('.folder-header').forEach(el => {
                    el.classList.toggle('active', el.dataset.folder === this.currentFolder);
                });

                // Update note active states
                document.querySelectorAll('.note-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.noteId === this.currentNote?.id);
                });
            }

            // ==================== SELECTION & FILTERING ====================

            selectFolder(folderId) {
                this.currentFolder = folderId;
                this.currentNote = null;
                this.showEmptyState();
                this.renderFolderTree();
                this.updateActiveStates();

                // Update header title
                const folder = this.data.folders.find(f => f.id === folderId);
                document.getElementById('headerTitle').textContent = folder?.name || '';
            }

            filterByTag(tag) {
                // Toggle off if already filtering by this tag
                if (this.currentTagFilter === tag) {
                    this.currentTagFilter = null;
                    this.currentFolder = 'root';
                    this.render();
                    return;
                }

                // Show notes with this tag
                this.currentTagFilter = tag;
                this.currentFolder = 'tag:' + tag;
                this.currentNote = null;
                this.showEmptyState();

                // Update UI
                document.querySelectorAll('.tag-item-small').forEach(el => {
                    el.classList.toggle('active', el.dataset.tag === tag);
                });

                document.getElementById('headerTitle').textContent = `Tag: ${tag}`;

                // Re-render tags to show active state
                this.renderTagsCloud();

                // Re-render folder tree to show filtered notes
                this.renderFolderTreeForTag(tag);
            }

            renderFolderTreeForTag(tag) {
                const tree = document.getElementById('folderTree');
                tree.innerHTML = '';

                const notes = this.data.notes.filter(n => n.tags.includes(tag));

                const ul = document.createElement('ul');
                ul.className = 'folder-tree';

                notes.forEach(note => {
                    const li = document.createElement('li');
                    li.className = 'folder-item';
                    li.innerHTML = `
                        <div class="note-item" data-note-id="${note.id}" style="padding-left: 8px;">
                            <span class="note-icon"><i class="ph ph-file-text"></i></span>
                            <span class="note-title">${this.escapeHtml(note.title)}</span>
                        </div>
                    `;

                    li.querySelector('.note-item').addEventListener('click', () => this.selectNote(note.id));
                    ul.appendChild(li);
                });

                tree.appendChild(ul);
            }

            // ==================== SEARCH ====================

            search(query) {
                if (!query.trim()) {
                    document.getElementById('searchResults').classList.remove('active');
                    return;
                }

                const q = query.toLowerCase();
                const results = this.data.notes.filter(note => {
                    return note.title.toLowerCase().includes(q) ||
                           note.content.toLowerCase().includes(q) ||
                           note.tags.some(t => t.toLowerCase().includes(q));
                }).slice(0, 10);

                const resultsEl = document.getElementById('searchResults');

                if (results.length === 0) {
                    resultsEl.innerHTML = '<div class="search-result-item"><div class="search-result-preview">No results found</div></div>';
                } else {
                    resultsEl.innerHTML = results.map(note => {
                        const preview = this.stripHtml(note.content).substring(0, 100);
                        return `
                            <div class="search-result-item" data-note="${note.id}">
                                <div class="search-result-title">${this.escapeHtml(note.title)}</div>
                                <div class="search-result-preview">${this.escapeHtml(preview)}${preview.length >= 100 ? '...' : ''}</div>
                                <div class="search-result-meta">${note.tags.map(t => '#' + t).join(' ')}</div>
                            </div>
                        `;
                    }).join('');
                }

                resultsEl.classList.add('active');

                resultsEl.querySelectorAll('.search-result-item[data-note]').forEach(el => {
                    el.addEventListener('click', () => {
                        this.selectNote(el.dataset.note);
                        resultsEl.classList.remove('active');
                        document.getElementById('searchInput').value = '';
                    });
                });
            }

            // ==================== EDITOR OPERATIONS ====================

            execCommand(command, value = null) {
                document.execCommand(command, false, value);
                document.getElementById('wysiwygEditor').focus();
                this.updateToolbarState();
            }

            updateToolbarState() {
                const commands = ['bold', 'italic', 'underline', 'strikeThrough'];
                commands.forEach(cmd => {
                    const btn = document.querySelector(`[data-command="${cmd}"]`);
                    if (btn) {
                        btn.classList.toggle('active', document.queryCommandState(cmd));
                    }
                });
            }

            insertLink() {
                const selection = window.getSelection().toString();
                document.getElementById('linkText').value = selection;
                document.getElementById('linkUrl').value = '';
                document.getElementById('linkModal').classList.add('active');
            }

            confirmLink() {
                const text = document.getElementById('linkText').value;
                const url = document.getElementById('linkUrl').value;

                if (!url) return;

                // Check if it's an internal link (note title)
                const linkedNote = this.data.notes.find(n =>
                    n.title.toLowerCase() === url.toLowerCase()
                );

                if (linkedNote) {
                    // Internal link
                    const html = `<a href="note:${linkedNote.id}" class="internal-link">${text || linkedNote.title}</a>`;
                    this.execCommand('insertHTML', html);
                } else {
                    // External link
                    this.execCommand('createLink', url);
                }

                document.getElementById('linkModal').classList.remove('active');
            }

            async insertImage() {
                const input = document.getElementById('fileInput');
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const base64 = event.target.result;
                        const id = 'img_' + Date.now();

                        // Save to IndexedDB if large
                        if (base64.length > 50000) {
                            await this.saveAttachment(id, base64);
                            this.execCommand('insertImage', base64);
                        } else {
                            this.execCommand('insertImage', base64);
                        }
                    };
                    reader.readAsDataURL(file);
                };
                input.click();
            }

            setupAutoSave() {
                const editor = document.getElementById('wysiwygEditor');
                const titleInput = document.getElementById('noteTitle');

                let timeout;
                let versionTimeout;

                const save = () => {
                    if (this.currentNote) {
                        this.updateNote(this.currentNote.id, {
                            title: titleInput.value || 'Untitled Note',
                            content: editor.innerHTML
                        });
                    }
                };

                const saveVersion = () => {
                    if (this.currentNote) {
                        this.saveVersion(this.currentNote.id);
                    }
                };

                editor.oninput = () => {
                    clearTimeout(timeout);
                    clearTimeout(versionTimeout);
                    timeout = setTimeout(save, 1000);
                    // Save version after 5 seconds of inactivity
                    versionTimeout = setTimeout(saveVersion, 5000);
                };

                titleInput.oninput = () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(save, 500);
                };
            }

            // ==================== EXPORT/IMPORT ====================

            exportJSON() {
                const data = JSON.stringify(this.data, null, 2);
                this.downloadFile(data, 'knowledge-base-backup.json', 'application/json');
                this.showToast('Exported as JSON', 'success');
            }

            exportMarkdown() {
                let md = '# Knowledge Base Export\n\n';

                this.data.notes.forEach(note => {
                    md += `## ${note.title}\n\n`;
                    md += `*Folder: ${this.getFolderPath(note.folderId).map(f => f.name).join(' / ')}*\n\n`;
                    if (note.tags.length) {
                        md += `Tags: ${note.tags.join(', ')}\n\n`;
                    }
                    md += this.htmlToMarkdown(note.content);
                    md += '\n\n---\n\n';
                });

                this.downloadFile(md, 'knowledge-base-export.md', 'text/markdown');
                this.showToast('Exported as Markdown', 'success');
            }

            exportNoteToPDF(noteId) {
                const note = this.data.notes.find(n => n.id === noteId);
                if (!note) {
                    this.showToast('Note not found', 'error');
                    return;
                }

                // Simple HTML-to-PDF using print dialog
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    this.showToast('Please allow popups to export PDF', 'error');
                    return;
                }

                const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <title>${this.escapeHtml(note.title)}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="content">${note.content}</div>
</body>
</html>
                `;

                printWindow.document.write(htmlContent);
                printWindow.document.close();

                // Auto-trigger print dialog
                setTimeout(() => {
                    printWindow.print();
                }, 500);

                this.showToast('PDF export ready - use Save as PDF in print dialog', 'success');
            }

            importData() {
                // Legacy function - kept for compatibility
                this.openImportWizard();
            }

            openImportWizard() {
                // Reset wizard state
                document.getElementById('importStep1').style.display = 'block';
                document.getElementById('importStep2').style.display = 'none';
                document.getElementById('importStep3').style.display = 'none';
                document.getElementById('importStep4').style.display = 'none';
                document.getElementById('backImportStep').style.display = 'none';
                
                // Clear any previous selection
                document.querySelectorAll('.import-source-option').forEach(opt => {
                    opt.style.borderColor = 'var(--border)';
                    opt.style.background = '';
                });
                
                // Show modal
                document.getElementById('importWizardModal').classList.add('active');
                
                // Setup close buttons
                document.getElementById('closeImportWizard').onclick = () => {
                    document.getElementById('importWizardModal').classList.remove('active');
                };
                document.getElementById('cancelImportWizard').onclick = () => {
                    document.getElementById('importWizardModal').classList.remove('active');
                };
                
                // Setup step 1 listeners
                document.querySelectorAll('.import-source-option').forEach(option => {
                    option.onclick = () => {
                        // Visual selection
                        document.querySelectorAll('.import-source-option').forEach(opt => {
                            opt.style.borderColor = 'var(--border)';
                            opt.style.background = '';
                        });
                        option.style.borderColor = 'var(--accent)';
                        option.style.background = 'var(--bg-hover)';
                        
                        const source = option.dataset.source;
                        this.showImportStep2(source);
                    };
                });
            }

            showImportStep2(source) {
                const instructions = document.getElementById('exportInstructions');
                
                if (source === 'notion') {
                    instructions.innerHTML = `
                        <div style="font-size: 16px; line-height: 1.7;">
                            <strong style="font-size: 18px; color: var(--text-primary);">How to export from Notion:</strong>
                            <ol style="margin: 16px 0; padding-left: 24px; color: var(--text-secondary);">
                                <li style="margin-bottom: 10px;">Open your Notion workspace</li>
                                <li style="margin-bottom: 10px;">Click <strong style="color: var(--text-primary);">Settings & Members</strong>  <strong style="color: var(--text-primary);">Settings</strong></li>
                                <li style="margin-bottom: 10px;">Scroll to <strong style="color: var(--text-primary);">Export</strong> section</li>
                                <li style="margin-bottom: 10px;">Click <strong style="color: var(--text-primary);">Export all workspace content</strong></li>
                                <li style="margin-bottom: 10px;">Choose <strong style="color: var(--text-primary);">Markdown & CSV</strong> format</li>
                                <li style="margin-bottom: 10px;">Wait for the email with download link</li>
                                <li>Download and extract the ZIP file</li>
                            </ol>
                            <p style="color: var(--text-tertiary); margin-top: 16px; font-size: 14px; font-style: italic;">
                                 Only Markdown files will be imported. CSV databases will be skipped.
                            </p>
                        </div>
                    `;
                } else if (source === 'obsidian') {
                    instructions.innerHTML = `
                        <div style="font-size: 16px; line-height: 1.7;">
                            <strong style="font-size: 18px; color: var(--text-primary);">How to export from Obsidian:</strong>
                            <ol style="margin: 16px 0; padding-left: 24px; color: var(--text-secondary);">
                                <li style="margin-bottom: 10px;">Open Obsidian on your computer</li>
                                <li style="margin-bottom: 10px;">Open the vault you want to export</li>
                                <li style="margin-bottom: 10px;">Go to <strong style="color: var(--text-primary);">Settings</strong>  <strong style="color: var(--text-primary);">Files and Links</strong></li>
                                <li style="margin-bottom: 10px;">Note your vault location, or:</li>
                                <li style="margin-bottom: 10px;">Use your file manager to locate the vault folder</li>
                                <li style="margin-bottom: 10px;">Create a ZIP file of the entire vault folder</li>
                                <li>Make sure Markdown (.md) files are included</li>
                            </ol>
                            <p style="color: var(--text-tertiary); margin-top: 16px; font-size: 14px; font-style: italic;">
                                 Your vault is just a folder of Markdown files. No special export needed!
                            </p>
                        </div>
                    `;
                }
                
                // Show step 2
                document.getElementById('importStep1').style.display = 'none';
                document.getElementById('importStep2').style.display = 'block';
                document.getElementById('backImportStep').style.display = 'inline-block';
                
                // Setup next button
                document.getElementById('goToImportStep3').onclick = () => {
                    this.showImportStep3();
                };
                
                // Setup back button
                document.getElementById('backImportStep').onclick = () => {
                    document.getElementById('importStep2').style.display = 'none';
                    document.getElementById('importStep1').style.display = 'block';
                    document.getElementById('backImportStep').style.display = 'none';
                };
            }

            showImportStep3() {
                document.getElementById('importStep2').style.display = 'none';
                document.getElementById('importStep3').style.display = 'block';
                
                // Setup file upload
                const dropZone = document.getElementById('importDropZone');
                const fileInput = document.getElementById('importFileInput');
                
                dropZone.onclick = () => fileInput.click();
                
                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.processImportFile(file);
                    }
                };
                
                // Update back button
                document.getElementById('backImportStep').onclick = () => {
                    document.getElementById('importStep3').style.display = 'none';
                    document.getElementById('importStep2').style.display = 'block';
                };
            }

            processImportFile(file) {
                // Show progress
                document.getElementById('importStep3').style.display = 'none';
                document.getElementById('importStep4').style.display = 'block';
                document.getElementById('backImportStep').style.display = 'none';
                
                const progressText = document.getElementById('importProgressText');
                const progressBar = document.getElementById('importProgressBar');
                
                progressText.textContent = 'Reading file...';
                progressBar.style.width = '20%';
                
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    progressText.textContent = 'Processing content...';
                    progressBar.style.width = '50%';
                    
                    setTimeout(() => {
                        try {
                            if (file.name.endsWith('.json')) {
                                const data = JSON.parse(event.target.result);
                                if (data.notes && data.folders) {
                                    this.data = { ...this.data, ...data };
                                    this.saveData();
                                }
                            } else if (file.name.endsWith('.md') || file.name.endsWith('.markdown')) {
                                this.importMarkdown(event.target.result);
                            } else if (file.name.endsWith('.zip')) {
                                progressText.textContent = 'Extracting ZIP (simulated)...';
                                progressBar.style.width = '75%';
                                // Simulate ZIP processing
                                this.simulateZipImport();
                                return;
                            }
                            
                            progressText.textContent = 'Complete!';
                            progressBar.style.width = '100%';
                            
                            setTimeout(() => {
                                document.getElementById('importWizardModal').classList.remove('active');
                                this.render();
                                this.showToast('Import completed successfully', 'success');
                            }, 500);
                            
                        } catch (err) {
                            progressText.textContent = 'Error: ' + err.message;
                            progressBar.style.background = 'var(--danger)';
                            setTimeout(() => {
                                document.getElementById('importWizardModal').classList.remove('active');
                                this.showToast('Import failed: ' + err.message, 'error');
                            }, 1500);
                        }
                    }, 500);
                };
                
                reader.onerror = () => {
                    progressText.textContent = 'Error reading file';
                    progressBar.style.background = 'var(--danger)';
                };
                
                if (file.name.endsWith('.zip')) {
                    // For ZIP, we'd need JSZip library in a real implementation
                    // For now, simulate the import
                    reader.readAsText(file);
                } else {
                    reader.readAsText(file);
                }
            }

            simulateZipImport() {
                // Simulate creating sample data from ZIP
                const folders = [
                    { id: 'import_' + Date.now(), name: 'Imported Notes', parentId: null }
                ];
                
                const notes = [
                    {
                        id: 'note_import_1',
                        title: 'Welcome to Mind',
                        content: '<p>This is a sample imported note.</p>',
                        folderId: folders[0].id,
                        tags: ['imported'],
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    }
                ];
                
                folders.forEach(f => this.data.folders.push(f));
                notes.forEach(n => this.data.notes.push(n));
                this.saveData();
                
                setTimeout(() => {
                    document.getElementById('importWizardModal').classList.remove('active');
                    this.render();
                    this.showToast('Import completed! Sample data added.', 'success');
                }, 500);
            }

            checkForBackups() {
                const statusEl = document.getElementById('backupStatus');
                const saved = localStorage.getItem('kb_data');
                const backup = localStorage.getItem('kb_data_backup');

                let message = '';
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        const folderCount = data.folders ? data.folders.length : 0;
                        const noteCount = data.notes ? data.notes.length : 0;
                        message += `Current data: ${folderCount} folders, ${noteCount} notes. `;
                    } catch (e) {
                        message += 'Current data: corrupted. ';
                    }
                } else {
                    message += 'No current data found. ';
                }

                if (backup) {
                    try {
                        const data = JSON.parse(backup);
                        const folderCount = data.folders ? data.folders.length : 0;
                        const noteCount = data.notes ? data.notes.length : 0;
                        message += `Backup found: ${folderCount} folders, ${noteCount} notes.`;

                        if (confirm('Backup found! Would you like to restore it?')) {
                            localStorage.setItem('kb_data', backup);
                            this.loadData();
                            this.render();
                            this.showToast('Backup restored!', 'success');
                        }
                    } catch (e) {
                        message += 'Backup: corrupted.';
                    }
                } else {
                    message += 'No backup found.';
                }

                statusEl.textContent = message;
            }

            createBackup() {
                const data = localStorage.getItem('kb_data');
                if (data) {
                    localStorage.setItem('kb_data_backup', data);
                    localStorage.setItem('kb_backup_date', new Date().toISOString());
                    document.getElementById('backupStatus').textContent = 'Backup created at ' + new Date().toLocaleString();
                    this.showToast('Backup created successfully', 'success');
                } else {
                    document.getElementById('backupStatus').textContent = 'No data to backup';
                }
            }

            importMarkdown(content) {
                // Simple markdown import - create one note per file
                const title = content.match(/^#\s+(.+)$/m)?.[1] || 'Imported Note';
                const note = this.createNote(title, 'inbox');
                note.content = this.markdownToHtml(content);
                this.saveData();
                this.selectNote(note.id);
                this.showToast('Markdown imported', 'success');
            }

            downloadFile(content, filename, type) {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }

            clearAllData() {
                if (confirm('Are you sure you want to delete ALL data? This cannot be undone.')) {
                    localStorage.removeItem('kb_data');
                    this.data = {
                        folders: [
                            { id: 'root', name: 'All Notes', parentId: null },
                            { id: 'inbox', name: 'Inbox', parentId: null }
                        ],
                        notes: [],
                        tags: [],
                        settings: { theme: 'auto', sidebarCollapsed: {} }
                    };
                    this.currentNote = null;
                    this.currentFolder = 'root';
                    this.showEmptyState();
                    this.render();
                    this.showToast('All data cleared', 'success');
                }
            }

            // ==================== UI HELPERS ====================

            showContextMenu(e, type, id) {
                this.contextMenuTarget = { type, id };
                const menu = document.getElementById('contextMenu');

                // Position menu
                const x = Math.min(e.clientX, window.innerWidth - 180);
                const y = Math.min(e.clientY, window.innerHeight - 150);
                menu.style.left = x + 'px';
                menu.style.top = y + 'px';
                menu.classList.add('active');
            }

            hideContextMenu() {
                document.getElementById('contextMenu').classList.remove('active');
                this.contextMenuTarget = null;
            }

            showToast(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span class="toast-icon">${type === 'success' ? '' : ''}</span>
                    <span class="toast-message">${this.escapeHtml(message)}</span>
                    <button class="toast-close"></button>
                `;

                container.appendChild(toast);

                toast.querySelector('.toast-close').addEventListener('click', () => {
                    toast.remove();
                });

                setTimeout(() => toast.remove(), 4000);
            }

            toggleFocusMode() {
                document.body.classList.toggle('distraction-free');
            }

            toggleSidebar() {
                document.getElementById('sidebar').classList.toggle('open');
                document.getElementById('sidebarOverlay').classList.toggle('active');
            }

            // ==================== EVENT LISTENERS ====================

            setupEventListeners() {
                console.log('Setting up event listeners...');

                // Settings - set up first for debugging
                const settingsBtn = document.getElementById('settingsBtn');
                const settingsModal = document.getElementById('settingsModal');
                if (settingsBtn && settingsModal) {
                    settingsBtn.addEventListener('click', () => {
                        console.log('Settings button clicked');
                        settingsModal.classList.add('active');
                    });
                } else {
                    console.error('Settings elements not found:', {settingsBtn, settingsModal});
                }

                const closeSettings = document.getElementById('closeSettings');
                if (closeSettings && settingsModal) {
                    closeSettings.addEventListener('click', () => {
                        settingsModal.classList.remove('active');
                    });
                }

                // New note
                const newNoteBtn = document.getElementById('newNoteBtn');
                if (newNoteBtn) {
                    newNoteBtn.addEventListener('click', () => {
                        this.populateFolderSelect();
                        document.getElementById('newNoteModal').classList.add('active');
                        document.getElementById('newNoteTitle').focus();
                    });
                }

                // Add new folder
                document.getElementById('addFolderBtn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const name = prompt('Enter folder name:');
                    if (name && name.trim()) {
                        this.createFolder(name.trim(), null);
                    }
                });

                document.getElementById('emptyNewNoteBtn').addEventListener('click', () => {
                    this.populateFolderSelect();
                    document.getElementById('newNoteModal').classList.add('active');
                    document.getElementById('newNoteTitle').focus();
                });

                document.getElementById('confirmNewNote').addEventListener('click', () => {
                    const title = document.getElementById('newNoteTitle').value;
                    const folderId = document.getElementById('newNoteFolder').value;
                    if (title.trim()) {
                        this.createNote(title, folderId);
                        document.getElementById('newNoteModal').classList.remove('active');
                        document.getElementById('newNoteTitle').value = '';
                    }
                });

                document.getElementById('cancelNewNote').addEventListener('click', () => {
                    document.getElementById('newNoteModal').classList.remove('active');
                });

                // Theme select
                document.getElementById('themeSelect').addEventListener('change', (e) => {
                    this.setTheme(e.target.value);
                });

                document.getElementById('themeBtn').addEventListener('click', () => this.toggleTheme());

                // Export/Import
                document.getElementById('exportJsonBtn').addEventListener('click', () => this.exportJSON());
                document.getElementById('exportMarkdownBtn').addEventListener('click', () => this.exportMarkdown());
                document.getElementById('importBtn').addEventListener('click', () => {
                    // Close settings and open import wizard
                    document.getElementById('settingsModal').classList.remove('active');
                    this.openImportWizard();
                });
                document.getElementById('clearAllBtn').addEventListener('click', () => this.clearAllData());
                // Debug button
                const debugBtn = document.getElementById('debugBtn');
                if (debugBtn) {
                    debugBtn.addEventListener('click', () => {
                        const folderInfo = this.data.folders.map(f => `  - ${f.name} (id: ${f.id}, parent: ${f.parentId})`).join('\n');
                        const noteInfo = this.data.notes.map(n => `  - ${n.title} (folder: ${n.folderId})`).join('\n');
                        const debugOutput = `FOLDERS (${this.data.folders.length}):\n${folderInfo}\n\nNOTES (${this.data.notes.length}):\n${noteInfo || '  (none)'}`;
                        console.log('=== DEBUG INFO ===');
                        console.log(debugOutput);
                        console.log('==================');
                        // Also copy to clipboard
                        navigator.clipboard.writeText(debugOutput).then(() => {
                            this.showToast('Debug info copied to clipboard!', 'success');
                        }).catch(() => {
                            this.showToast('Debug info logged to console (F12)', 'success');
                        });
                    });
                }

                // Backup buttons
                document.getElementById('checkBackupBtn').addEventListener('click', () => this.checkForBackups());
                document.getElementById('createBackupBtn').addEventListener('click', () => this.createBackup());

                // Focus mode - exit button only (toggle is now in sidebar tab)
                const exitFocusBtn = document.getElementById('exitFocusBtn');
                if (exitFocusBtn) {
                    exitFocusBtn.addEventListener('click', () => this.toggleFocusMode());
                }

                // Mobile menu
                document.getElementById('menuBtn').addEventListener('click', () => this.toggleSidebar());
                document.getElementById('sidebarOverlay').addEventListener('click', () => this.toggleSidebar());

                // Toolbar
                document.querySelectorAll('.toolbar-btn[data-command]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const command = btn.dataset.command;
                        const value = btn.dataset.value || null;
                        this.execCommand(command, value);
                    });
                });

                document.getElementById('linkBtn').addEventListener('click', () => this.insertLink());
                document.getElementById('imageBtn').addEventListener('click', () => this.insertImage());
                document.getElementById('confirmLink').addEventListener('click', () => this.confirmLink());
                document.getElementById('cancelLink').addEventListener('click', () => {
                    document.getElementById('linkModal').classList.remove('active');
                });

                // Search
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.search(e.target.value);
                });

                document.getElementById('searchInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.search(e.target.value);
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.sidebar-search')) {
                        document.getElementById('searchResults').classList.remove('active');
                    }
                });

                // Tags input with autocomplete
                const tagInput = document.getElementById('tagInput');
                let tagAutocomplete = document.getElementById('tagAutocomplete');
                let activeAutocompleteIndex = -1;

                // Move autocomplete to body for proper positioning
                if (tagAutocomplete) {
                    document.body.appendChild(tagAutocomplete);
                }

                function positionAutocomplete() {
                    if (!tagAutocomplete || tagAutocomplete.style.display === 'none') return;
                    const rect = tagInput.getBoundingClientRect();
                    tagAutocomplete.style.left = rect.left + 'px';
                    tagAutocomplete.style.top = (rect.bottom + 4) + 'px';
                }

                tagInput.addEventListener('input', (e) => {
                    const value = e.target.value.trim().toLowerCase();
                    
                    if (value.length === 0) {
                        tagAutocomplete.style.display = 'none';
                        return;
                    }
                    
                    const existingTags = this.getAllTags();
                    const currentNoteTags = this.currentNote?.tags || [];
                    const matches = existingTags.filter(tag => 
                        tag.toLowerCase().includes(value) && 
                        !currentNoteTags.includes(tag)
                    ).slice(0, 5);
                    
                    if (matches.length > 0) {
                        const rect = tagInput.getBoundingClientRect();
                        tagAutocomplete.innerHTML = matches.map((tag, index) => `
                            <div class="tag-autocomplete-item ${index === 0 ? 'active' : ''}" data-tag="${this.escapeHtml(tag)}" data-index="${index}">
                                <i class="ph ph-tag"></i>
                                ${this.escapeHtml(tag)}
                            </div>
                        `).join('');
                        
                        tagAutocomplete.style.cssText = `
                            display: block !important;
                            position: fixed;
                            z-index: 99999;
                            background: var(--bg-primary);
                            border: 1px solid var(--accent);
                            border-radius: 4px;
                            max-height: 200px;
                            overflow-y: auto;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            min-width: ${rect.width}px;
                            width: auto;
                        `;
                        positionAutocomplete();
                        activeAutocompleteIndex = 0;
                        
                        tagAutocomplete.querySelectorAll('.tag-autocomplete-item').forEach(item => {
                            item.addEventListener('click', () => {
                                if (this.currentNote) {
                                    this.addTagToNote(this.currentNote.id, item.dataset.tag);
                                    tagInput.value = '';
                                    tagAutocomplete.style.display = 'none';
                                }
                            });
                        });
                    } else {
                        tagAutocomplete.style.display = 'none';
                    }
                });

                // Reposition on scroll/resize
                window.addEventListener('scroll', positionAutocomplete);
                window.addEventListener('resize', positionAutocomplete);

                tagInput.addEventListener('keydown', (e) => {
                    const items = tagAutocomplete.querySelectorAll('.tag-autocomplete-item');
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (items.length > 0) {
                            items[activeAutocompleteIndex]?.classList.remove('active');
                            activeAutocompleteIndex = (activeAutocompleteIndex + 1) % items.length;
                            items[activeAutocompleteIndex]?.classList.add('active');
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (items.length > 0) {
                            items[activeAutocompleteIndex]?.classList.remove('active');
                            activeAutocompleteIndex = activeAutocompleteIndex <= 0 ? items.length - 1 : activeAutocompleteIndex - 1;
                            items[activeAutocompleteIndex]?.classList.add('active');
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        const activeItem = items[activeAutocompleteIndex];
                        if (activeItem && tagAutocomplete.style.display !== 'none') {
                            // Use the suggested tag
                            if (this.currentNote) {
                                this.addTagToNote(this.currentNote.id, activeItem.dataset.tag);
                                tagInput.value = '';
                                tagAutocomplete.style.display = 'none';
                            }
                        } else {
                            // Add new tag from input
                            const tag = tagInput.value.trim();
                            if (tag && this.currentNote) {
                                this.addTagToNote(this.currentNote.id, tag);
                                tagInput.value = '';
                            }
                        }
                    } else if (e.key === ',' || e.key === ' ') {
                        // Allow comma to add tag
                        if (e.key === ',') {
                            e.preventDefault();
                            const tag = tagInput.value.trim();
                            if (tag && this.currentNote) {
                                this.addTagToNote(this.currentNote.id, tag);
                                tagInput.value = '';
                                tagAutocomplete.style.display = 'none';
                            }
                        }
                    } else if (e.key === 'Escape') {
                        tagAutocomplete.style.display = 'none';
                    }
                });

                // Hide autocomplete when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.note-tags-input')) {
                        tagAutocomplete.style.display = 'none';
                    }
                });

                // Context menu
                document.getElementById('ctxRename').addEventListener('click', () => {
                    if (this.contextMenuTarget?.type === 'folder') {
                        const folder = this.data.folders.find(f => f.id === this.contextMenuTarget.id);
                        const newName = prompt('Rename folder:', folder?.name);
                        if (newName) this.renameFolder(this.contextMenuTarget.id, newName);
                    } else if (this.contextMenuTarget?.type === 'note') {
                        this.renameNote(this.contextMenuTarget.id);
                    }
                    this.hideContextMenu();
                });

                document.getElementById('ctxDuplicate').addEventListener('click', () => {
                    if (this.contextMenuTarget?.type === 'note') {
                        this.duplicateNote(this.contextMenuTarget.id);
                    }
                    this.hideContextMenu();
                });

                document.getElementById('ctxMove').addEventListener('click', () => {
                    if (this.contextMenuTarget?.type === 'note') {
                        const folderId = prompt('Enter folder ID (root, inbox, archive, or custom):', 'root');
                        if (folderId) this.moveNote(this.contextMenuTarget.id, folderId);
                    }
                    this.hideContextMenu();
                });

                document.getElementById('ctxDelete').addEventListener('click', () => {
                    if (this.contextMenuTarget?.type === 'note') {
                        this.deleteNote(this.contextMenuTarget.id);
                    } else if (this.contextMenuTarget?.type === 'folder') {
                        this.deleteFolder(this.contextMenuTarget.id);
                    }
                    this.hideContextMenu();
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.context-menu')) {
                        this.hideContextMenu();
                    }
                });

                // Collapsible sections
                document.querySelectorAll('.section-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const section = header.dataset.section;
                        const content = document.getElementById(section + 'Section');
                        const toggle = header.querySelector('.section-toggle');
                        content.classList.toggle('collapsed');
                        toggle.classList.toggle('collapsed');
                    });
                });

                // Section toggles
                document.querySelectorAll('.section-toggle').forEach(toggle => {
                    toggle.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const section = toggle.closest('.section-header').dataset.section;
                        const content = document.getElementById(section + 'Section');
                        content.classList.toggle('collapsed');
                        toggle.classList.toggle('collapsed');
                    });
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Cmd/Ctrl + K for search
                    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                        e.preventDefault();
                        document.getElementById('searchInput').focus();
                    }

                    // Cmd/Ctrl + N for new note
                    if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
                        e.preventDefault();
                        const newNoteBtn = document.getElementById('newNoteBtn');
                        if (newNoteBtn) {
                            newNoteBtn.click();
                        } else {
                            // Fallback if button removed - open modal directly
                            this.populateFolderSelect();
                            document.getElementById('newNoteModal').classList.add('active');
                            document.getElementById('newNoteTitle').focus();
                        }
                    }

                    // Escape to close modals
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal-overlay.active').forEach(m => {
                            m.classList.remove('active');
                        });
                    }
                });

                // More button - note menu
                const moreBtn = document.getElementById('moreBtn');
                const noteMenuDropdown = document.getElementById('noteMenuDropdown');

                if (moreBtn && noteMenuDropdown) {
                    moreBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        noteMenuDropdown.classList.toggle('show');
                    });

                    // Close menu when clicking outside
                    document.addEventListener('click', () => {
                        noteMenuDropdown.classList.remove('show');
                    });

                    // New tab button
                    const newTabBtn = document.getElementById('newTabBtn');
                    if (newTabBtn) {
                        newTabBtn.addEventListener('click', () => {
                            this.createNote('', this.currentFolder || 'root');
                        });
                    }

                    // Font options
                    noteMenuDropdown.querySelectorAll('.note-menu-font-option').forEach(option => {
                        option.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const font = option.dataset.font;
                            const editor = document.getElementById('wysiwygEditor');

                            // Remove all font classes
                            editor.classList.remove('font-serif', 'font-mono');

                            // Add selected font class
                            if (font === 'serif') {
                                editor.classList.add('font-serif');
                            } else if (font === 'mono') {
                                editor.classList.add('font-mono');
                            }

                            // Update active state
                            noteMenuDropdown.querySelectorAll('.note-menu-font-option').forEach(opt => {
                                opt.classList.remove('active');
                            });
                            option.classList.add('active');

                            // Save preference
                            if (this.currentNote) {
                                this.currentNote.fontFamily = font;
                                this.saveData();
                            }
                        });
                    });

                    // Menu actions
                    noteMenuDropdown.querySelectorAll('.note-menu-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const action = item.dataset.action;
                            noteMenuDropdown.classList.remove('show');

                            if (!this.currentNote) return;

                            switch(action) {
                                case 'copy':
                                    const content = document.getElementById('wysiwygEditor').innerText;
                                    navigator.clipboard.writeText(content).then(() => {
                                        this.showToast('Page contents copied!', 'success');
                                    });
                                    break;
                                case 'duplicate':
                                    this.duplicateNote(this.currentNote.id);
                                    break;
                                case 'pdf':
                                    this.exportNoteToPDF(this.currentNote.id);
                                    break;
                                case 'delete':
                                    this.deleteNote(this.currentNote.id);
                                    break;
                            }
                        });
                    });

                    // Toggle items
                    noteMenuDropdown.querySelectorAll('.note-menu-toggle').forEach(toggle => {
                        toggle.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const toggleType = toggle.dataset.toggle;
                            const indicator = toggle.querySelector('.note-menu-toggle-indicator');

                            if (toggleType === 'smallText') {
                                const editor = document.getElementById('wysiwygEditor');
                                editor.classList.toggle('small-text');
                                const isOn = editor.classList.contains('small-text');
                                indicator.textContent = isOn ? '' : '';
                                indicator.classList.toggle('on', isOn);
                                if (this.currentNote) {
                                    this.currentNote.smallText = isOn;
                                    this.saveData();
                                }
                            } else if (toggleType === 'fullWidth') {
                                const editorContent = document.querySelector('.editor-content');
                                editorContent.classList.toggle('full-width');
                                const isOn = editorContent.classList.contains('full-width');
                                indicator.textContent = isOn ? '' : '';
                                indicator.classList.toggle('on', isOn);
                                if (this.currentNote) {
                                    this.currentNote.fullWidth = isOn;
                                    this.saveData();
                                }
                            }
                        });
                    });
                    // Clip Webpage button
                    const clipWebpageBtn = document.getElementById('clipWebpageBtn');
                    const clipWebpageModal = document.getElementById('clipWebpageModal');
                    if (clipWebpageBtn && clipWebpageModal) {
                        clipWebpageBtn.addEventListener('click', () => {
                            noteMenuDropdown.classList.remove('show');
                            document.getElementById('clipUrlInput').value = '';
                            document.getElementById('clipStatus').style.display = 'none';
                            clipWebpageModal.classList.add('active');
                        });
                    }

                    // Close clip modal
                    const closeClipModal = document.getElementById('closeClipModal');
                    if (closeClipModal && clipWebpageModal) {
                        closeClipModal.addEventListener('click', () => {
                            clipWebpageModal.classList.remove('active');
                        });
                    }

                    // Clip webpage action
                    const clipWebpageAction = document.getElementById('clipWebpageAction');
                    if (clipWebpageAction) {
                        clipWebpageAction.addEventListener('click', async () => {
                            const url = document.getElementById('clipUrlInput').value.trim();
                            if (!url) {
                                this.showToast('Please enter a URL', 'error');
                                return;
                            }

                            const statusDiv = document.getElementById('clipStatus');
                            const statusText = document.getElementById('clipStatusText');
                            statusDiv.style.display = 'block';
                            statusText.textContent = 'Clipping page...';
                            clipWebpageAction.disabled = true;

                            try {
                                // Try to fetch the page content
                                const response = await fetch(`https://r.jina.ai/http://${url.replace(/^https?:\/\//, '')}`);
                                if (!response.ok) throw new Error('Failed to fetch');
                                
                                const text = await response.text();
                                
                                // Create a new note with the clipped content
                                const note = this.createNote('Clipped: ' + url, this.currentFolder || 'root');
                                note.content = `<h1>${url}</h1><p><em>Clipped from: <a href="${url}" target="_blank">${url}</a></em></p><hr>${text.replace(/\n/g, '<br>')}`;
                                note.clippedFrom = url;
                                this.saveData();
                                
                                clipWebpageModal.classList.remove('active');
                                this.showToast('Web page clipped successfully!', 'success');
                                
                                // Refresh the note content
                                this.loadNoteIntoEditor(note);
                            } catch (err) {
                                statusText.textContent = 'Error: ' + err.message + '. Try copying content manually.';
                                this.showToast('Failed to clip page. Copy content manually.', 'error');
                            } finally {
                                clipWebpageAction.disabled = false;
                            }
                        });
                    }
                }

                // Sidebar resize functionality
                const sidebar = document.getElementById('sidebar');
                const resizeHandle = document.getElementById('sidebarResizeHandle');
                const sidebarToggleTab = document.getElementById('sidebarToggleTab');

                if (resizeHandle && sidebar) {
                    let isResizing = false;
                    let startX, startWidth;

                    resizeHandle.addEventListener('mousedown', (e) => {
                        if (sidebar.classList.contains('collapsed')) return;
                        isResizing = true;
                        startX = e.clientX;
                        startWidth = parseInt(document.defaultView.getComputedStyle(sidebar).width, 10);
                        resizeHandle.classList.add('resizing');
                        document.body.style.cursor = 'col-resize';
                        e.preventDefault();
                    });

                    document.addEventListener('mousemove', (e) => {
                        if (!isResizing) return;
                        const width = startWidth + e.clientX - startX;
                        if (width >= 200 && width <= 500) {
                            sidebar.style.width = width + 'px';
                        }
                    });

                    document.addEventListener('mouseup', () => {
                        if (isResizing) {
                            isResizing = false;
                            resizeHandle.classList.remove('resizing');
                            document.body.style.cursor = '';
                            // Save width preference
                            if (this.data.settings) {
                                this.data.settings.sidebarWidth = parseInt(document.defaultView.getComputedStyle(sidebar).width, 10);
                                this.saveData();
                            }
                        }
                    });
                }

                // Sidebar toggle in tabs bar
                if (sidebarToggleTab && sidebar) {
                    sidebarToggleTab.addEventListener('click', () => {
                        sidebar.classList.toggle('collapsed');
                        sidebarToggleTab.title = sidebar.classList.contains('collapsed') ? 'Show Sidebar' : 'Hide Sidebar';
                        
                        // Save preference
                        if (this.data.settings) {
                            this.data.settings.sidebarCollapsed = sidebar.classList.contains('collapsed');
                            this.saveData();
                        }
                    });
                }

                // AI Suggest button
                const aiSuggestBtn = document.getElementById('aiSuggestBtn');
                const aiSuggestModal = document.getElementById('aiSuggestModal');
                const aiSuggestType = document.getElementById('aiSuggestType');
                const aiCustomRequestGroup = document.getElementById('aiCustomRequestGroup');
                const aiCustomRequest = document.getElementById('aiCustomRequest');
                const aiContentPreview = document.getElementById('aiContentPreview');
                const aiResultGroup = document.getElementById('aiResultGroup');
                const aiResult = document.getElementById('aiResult');
                const generateAiSuggest = document.getElementById('generateAiSuggest');
                const applyAiSuggest = document.getElementById('applyAiSuggest');
                const closeAiSuggest = document.getElementById('closeAiSuggest');

                if (aiSuggestBtn && aiSuggestModal) {
                    aiSuggestBtn.addEventListener('click', () => {
                        if (!this.currentNote) {
                            this.showToast('Open a note first', 'error');
                            return;
                        }

                        // Reset modal state
                        aiSuggestType.value = 'improve';
                        aiCustomRequestGroup.style.display = 'none';
                        aiCustomRequest.value = '';
                        aiResultGroup.style.display = 'none';
                        aiResult.textContent = '';
                        generateAiSuggest.style.display = 'inline-block';
                        applyAiSuggest.style.display = 'none';

                        // Show content preview
                        const content = document.getElementById('wysiwygEditor').innerText;
                        aiContentPreview.textContent = content.substring(0, 500) + (content.length > 500 ? '...' : '');

                        aiSuggestModal.classList.add('active');
                    });

                    // Show/hide custom request field
                    aiSuggestType.addEventListener('change', () => {
                        aiCustomRequestGroup.style.display =
                            aiSuggestType.value === 'custom' ? 'block' : 'none';
                    });

                    // Close modal
                    closeAiSuggest.addEventListener('click', () => {
                        aiSuggestModal.classList.remove('active');
                    });

                    // Generate suggestions (placeholder - integrate with AI later)
                    generateAiSuggest.addEventListener('click', () => {
                        const type = aiSuggestType.value;
                        const custom = aiCustomRequest.value;
                        const content = document.getElementById('wysiwygEditor').innerText;

                        generateAiSuggest.textContent = 'Thinking...';
                        generateAiSuggest.disabled = true;

                        // Simulate AI processing
                        setTimeout(() => {
                            let suggestion = '';

                            switch(type) {
                                case 'improve':
                                    suggestion = `[Improved version]\n\n${content}\n\n[Suggestions:\n- Consider using more active voice\n- Break long sentences into shorter ones\n- Add specific examples where possible]`;
                                    break;
                                case 'summarize':
                                    suggestion = `[Summary]\n\nKey points:\n- Main idea extracted from your note\n- Supporting detail 1\n- Supporting detail 2\n\n[Original text: ${content.substring(0, 200)}...]`;
                                    break;
                                case 'expand':
                                    suggestion = `[Expanded version]\n\n${content}\n\n[Additional context and details would be added here to elaborate on your key points. Each major idea would be developed with examples and supporting information.]`;
                                    break;
                                case 'fix':
                                    suggestion = `[Grammar \u0026 spelling checked]\n\n${content}\n\n[Corrections made:\n- Fixed punctuation\n- Corrected spelling\n- Improved sentence structure]`;
                                    break;
                                case 'simplify':
                                    suggestion = `[Simplified version]\n\n${content}\n\n[Changes made:\n- Replaced complex words with simpler alternatives\n- Shortened long sentences\n- Removed jargon]`;
                                    break;
                                case 'custom':
                                    suggestion = `[Custom: ${custom}]\n\n${content}\n\n[AI would process your specific request: "${custom}" and provide tailored suggestions here.]`;
                                    break;
                            }

                            aiResult.textContent = suggestion;
                            aiResultGroup.style.display = 'block';
                            generateAiSuggest.style.display = 'none';
                            applyAiSuggest.style.display = 'inline-block';
                            generateAiSuggest.textContent = 'Generate Suggestions';
                            generateAiSuggest.disabled = false;
                        }, 1500);
                    });

                    // Apply suggestions
                    applyAiSuggest.addEventListener('click', () => {
                        const suggestion = aiResult.textContent;
                        // For now, just show what would be applied
                        this.showToast('Feature ready for AI integration!', 'success');
                        aiSuggestModal.classList.remove('active');
                    });
                }

                // Version History
                const versionHistoryBtn = document.getElementById('versionHistoryBtn');
                if (versionHistoryBtn) {
                    versionHistoryBtn.addEventListener('click', () => this.openVersionHistory());
                }

                document.getElementById('closeVersionHistory').addEventListener('click', () => this.closeVersionHistory());
                document.getElementById('cancelVersionRestore').addEventListener('click', () => this.closeVersionHistory());
                document.getElementById('confirmVersionRestore').addEventListener('click', () => this.restoreVersion());

                // AI Panel - opened from Settings
                document.getElementById('aiSettingsBtn')?.addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.remove('active');
                    document.getElementById('aiPanelModal').classList.add('active');
                });

                // Trash - opened from Settings
                document.getElementById('trashBtn')?.addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.remove('active');
                    this.openTrashModal();
                });

                // AI Panel setup (for the panel itself, not the button)
                this.setupAiPanelListeners();

                // Handle link clicks
                document.getElementById('wysiwygEditor').addEventListener('click', (e) => {
                    if (e.target.tagName === 'A') {
                        e.preventDefault();
                        const href = e.target.getAttribute('href');
                        if (e.target.classList.contains('internal-link')) {
                            const noteId = href.replace('note:', '');
                            const note = this.data.notes.find(n => n.id === noteId);
                            if (note) {
                                this.selectNote(note.id);
                            }
                        } else if (href) {
                            window.open(href, '_blank');
                        }
                    }
                });

                // Auto-create internal links on [[text]]
                document.getElementById('wysiwygEditor').addEventListener('input', (e) => {
                    const editor = e.target;
                    const text = editor.innerText;

                    // Check for [[text]] pattern
                    const match = text.match(/\[\[([^\]]+)\]\](?![^(]*\))/);
                    if (match && !e.isComposing) {
                        const linkText = match[1];
                        const linkedNote = this.data.notes.find(n =>
                            n.title.toLowerCase() === linkText.toLowerCase()
                        );

                        if (linkedNote) {
                            // Replace the pattern with a link
                            const html = editor.innerHTML;
                            const newHtml = html.replace(
                                new RegExp(`\\[\\[${this.escapeRegex(linkText)}\\]\\]`),
                                `<a href="note:${linkedNote.id}" class="internal-link">${linkedNote.title}</a>`
                            );
                            editor.innerHTML = newHtml;

                            // Move cursor to end
                            const range = document.createRange();
                            range.selectNodeContents(editor);
                            range.collapse(false);
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                        }
                    }
                });

                // Selection Toolbar
                this.setupSelectionToolbar();

                // Note Tabs
                document.querySelectorAll('.note-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchNoteTab(tab.dataset.tab));
                });

                // Add First Task button
                document.getElementById('addFirstTaskBtn')?.addEventListener('click', () => this.addTask());

                // Template selector
                document.getElementById('templateSelect')?.addEventListener('change', (e) => this.applyTemplate(e.target.value));

                // AI Suggest Tags button
                document.getElementById('suggestTagsBtn')?.addEventListener('click', () => this.suggestTagsWithAi());

                // AI Summarize button
                document.getElementById('summarizeBtn')?.addEventListener('click', () => this.summarizeNote());
            }

            suggestTagsWithAi() {
                // Check if AI is configured
                if (!this.data.settings?.aiProvider) {
                    document.getElementById('aiPanelModal').classList.add('active');
                    return;
                }

                if (!this.currentNote) {
                    this.showToast('Open a note first', 'error');
                    return;
                }

                const content = document.getElementById('wysiwygEditor').innerText.trim();
                if (content.length < 10) {
                    this.showToast('Note needs more content', 'error');
                    return;
                }

                // Demo mode - generate suggestions based on keywords
                const suggestions = this.generateDemoTagSuggestions(content, this.currentNote.tags || []);
                
                if (suggestions.length === 0) {
                    this.showToast('No tag suggestions found', 'info');
                    return;
                }

                this.showTagSuggestionsModal(suggestions);
            }

            generateDemoTagSuggestions(content, existingTags) {
                const text = content.toLowerCase();
                const suggestions = [];
                
                const keywords = {
                    'trading': ['trading', 'trade', 'market', 'buy', 'sell', 'position'],
                    'psychology': ['psychology', 'mental', 'mindset', 'emotion', 'fear', 'greed'],
                    'analysis': ['analysis', 'chart', 'pattern', 'trend', 'support', 'resistance'],
                    'strategy': ['strategy', 'plan', 'system', 'method', 'approach'],
                    'risk-management': ['risk', 'stop loss', 'stop-loss', 'position size'],
                    'journal': ['journal', 'log', 'record', 'track', 'review'],
                    'learning': ['learn', 'study', 'education', 'course', 'book'],
                    'crypto': ['crypto', 'bitcoin', 'btc', 'ethereum', 'eth'],
                    'forex': ['forex', 'currency', 'eurusd', 'gbpusd'],
                    'stocks': ['stock', 'equity', 'shares', 'nasdaq', 'nyse'],
                    'gold': ['gold', 'xauusd', 'xau'],
                    'tutorial': ['tutorial', 'guide', 'how to', 'lesson'],
                    'research': ['research', 'study', 'data', 'backtest'],
                    'ideas': ['idea', 'concept', 'thought', 'insight'],
                    'workflow': ['workflow', 'process', 'routine', 'habit'],
                    'review': ['review', 'retrospective', 'summary'],
                    'goals': ['goal', 'target', 'objective', 'aim']
                };

                for (const [tag, words] of Object.entries(keywords)) {
                    if (words.some(w => text.includes(w)) && !existingTags.includes(tag)) {
                        suggestions.push(tag);
                    }
                }

                return [...new Set(suggestions)].slice(0, 5);
            }

            showTagSuggestionsModal(suggestions) {
                // Create modal if not exists
                let modal = document.getElementById('tagSuggestionsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'tagSuggestionsModal';
                    modal.className = 'modal-overlay';
                    modal.innerHTML = `
                        <div class="modal" style="max-width: 400px;">
                            <div class="modal-header">
                                <div class="modal-title"><i class="ph ph-sparkle"></i> Suggested Tags</div>
                                <button class="modal-close" onclick="document.getElementById('tagSuggestionsModal').classList.remove('active')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div style="background: var(--bg-tertiary); padding: 10px 12px; border-radius: var(--radius); margin-bottom: 16px; font-size: 12px; color: var(--text-secondary);">
                                    <i class="ph ph-info"></i> <strong>Demo mode:</strong> Tags suggested based on keywords in your note.
                                </div>
                                <p style="margin-bottom: 16px; color: var(--text-secondary); font-size: 13px;">Click tags to add them:</p>
                                <div id="tagSuggestionsList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="document.getElementById('tagSuggestionsModal').classList.remove('active')">Close</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }

                // Populate suggestions
                const list = document.getElementById('tagSuggestionsList');
                list.innerHTML = suggestions.map(tag => `
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" data-tag="${tag}">
                        <i class="ph ph-plus"></i> ${tag}
                    </button>
                `).join('');

                // Add click handlers
                list.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tag = btn.dataset.tag;
                        if (this.currentNote) {
                            this.addTagToNote(this.currentNote.id, tag);
                            btn.style.opacity = '0.5';
                            btn.disabled = true;
                            btn.innerHTML = `<i class="ph ph-check"></i> ${tag}`;
                        }
                    });
                });

                // Show modal
                modal.classList.add('active');
            }

            summarizeNote() {
                // Check if AI is configured
                if (!this.data.settings?.aiProvider) {
                    document.getElementById('aiPanelModal').classList.add('active');
                    return;
                }

                if (!this.currentNote) {
                    this.showToast('Open a note first', 'error');
                    return;
                }

                const content = document.getElementById('wysiwygEditor').innerText.trim();
                if (content.length < 50) {
                    this.showToast('Note needs more content to summarize', 'error');
                    return;
                }

                // Show loading
                const btn = document.getElementById('summarizeBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Summarizing...';
                btn.disabled = true;

                // Simulate AI processing
                setTimeout(() => {
                    const summary = this.generateDemoSummary(content);
                    this.displaySummary(summary);
                    
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    this.showToast('Summary generated!', 'success');
                }, 1000);
            }

            generateDemoSummary(content) {
                const sentences = content.match(/[^.!?]+[.!?]+/g) || [content];
                const keywords = ['analysis', 'strategy', 'trading', 'market', 'psychology', 'risk', 'entry', 'exit', 'target', 'stop'];
                
                // Score sentences by keyword density
                const scored = sentences.map(sentence => {
                    const score = keywords.reduce((acc, kw) => {
                        return acc + (sentence.toLowerCase().includes(kw) ? 1 : 0);
                    }, 0);
                    return { sentence: sentence.trim(), score };
                });
                
                // Sort by score and pick top sentences
                scored.sort((a, b) => b.score - a.score);
                const topSentences = scored.slice(0, 3).map(s => s.sentence);
                
                // If no keywords matched, use first and last sentences
                if (topSentences.length === 0) {
                    topSentences.push(sentences[0]);
                    if (sentences.length > 1) topSentences.push(sentences[sentences.length - 1]);
                }
                
                return topSentences.join(' ');
            }

            displaySummary(summary) {
                document.getElementById('summaryEmptyState').style.display = 'none';
                document.getElementById('summaryResult').style.display = 'block';
                document.getElementById('summaryText').innerHTML = `<p>${summary}</p>`;
                
                // Store in note metadata
                if (!this.currentNote.metadata) this.currentNote.metadata = {};
                this.currentNote.metadata.summary = summary;
                this.saveData();
            }

            applyTemplate(templateId) {
                if (!templateId || !this.currentNote) return;
                
                const currentContent = document.getElementById('wysiwygEditor').innerText.trim();
                if (currentContent.length > 50) {
                    if (!confirm('This will replace your current note content. Continue?')) {
                        document.getElementById('templateSelect').value = '';
                        return;
                    }
                }
                
                const templates = {
                    'blank': '',
                    'trading-journal': `<h2>Trade Setup</h2>
<p><strong>Instrument:</strong> </p>
<p><strong>Timeframe:</strong> </p>
<p><strong>Direction:</strong> Long / Short</p>
<p><strong>Entry:</strong> </p>
<p><strong>Stop Loss:</strong> </p>
<p><strong>Target:</strong> </p>
<p><strong>Risk:Reward:</strong> </p>

<h2>Analysis</h2>
<p>Market structure / Key levels / Confluences:</p>

<h2>Psychology</h2>
<p>Emotional state / Confidence level:</p>

<h2>Outcome</h2>
<p>Result / Lessons learned:</p>`,
                    'daily-review': `<h2>Market Overview</h2>
<p>Key moves / Economic events:</p>

<h2>My Trades</h2>
<ul>
<li>Trade 1:</li>
<li>Trade 2:</li>
</ul>

<h2>What Worked</h2>
<p></p>

<h2>What Didn't</h2>
<p></p>

<h2>Tomorrow's Focus</h2>
<p></p>`,
                    'strategy': `<h2>Strategy Name</h2>
<p></p>

<h2>Setup Criteria</h2>
<ul>
<li>Criterion 1:</li>
<li>Criterion 2:</li>
<li>Criterion 3:</li>
</ul>

<h2>Entry Rules</h2>
<p></p>

<h2>Exit Rules</h2>
<p>Take profit / Stop loss:</p>

<h2>Risk Management</h2>
<p>Position sizing / Max risk per trade:</p>

<h2>Backtest Results</h2>
<p>Win rate / Expectancy / Sample size:</p>`,
                    'meeting': `<h2>Meeting Details</h2>
<p><strong>Date:</strong> </p>
<p><strong>Attendees:</strong> </p>
<p><strong>Objective:</strong> </p>

<h2>Agenda</h2>
<ul>
<li>Item 1:</li>
<li>Item 2:</li>
</ul>

<h2>Key Discussion Points</h2>
<p></p>

<h2>Decisions Made</h2>
<ul>
<li>Decision 1:</li>
</ul>

<h2>Action Items</h2>
<ul>
<li>[ ] Action 1 - Owner:</li>
<li>[ ] Action 2 - Owner:</li>
</ul>`
                };
                
                const template = templates[templateId];
                if (template === undefined) return;
                
                document.getElementById('wysiwygEditor').innerHTML = template;
                this.currentNote.content = template;
                this.saveData();
                
                document.getElementById('templateSelect').value = '';
                
                const templateNames = {
                    'blank': 'Blank',
                    'trading-journal': 'Trading Journal',
                    'daily-review': 'Daily Review',
                    'strategy': 'Strategy Plan',
                    'meeting': 'Meeting Notes'
                };
                this.showToast(`Applied ${templateNames[templateId]} template`, 'success');
            }

            switchNoteTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.note-tab').forEach(tab => {
                    if (tab.dataset.tab === tabName) {
                        tab.classList.add('active');
                        tab.style.borderBottomColor = 'var(--accent)';
                        tab.style.color = 'var(--text-primary)';
                    } else {
                        tab.classList.remove('active');
                        tab.style.borderBottomColor = 'transparent';
                        tab.style.color = 'var(--text-secondary)';
                    }
                });

                // Hide all content
                document.getElementById('noteTabContent').style.display = 'none';
                document.getElementById('summaryTabContent').style.display = 'none';
                document.getElementById('tasksTabContent').style.display = 'none';

                // Show selected content
                if (tabName === 'note') {
                    document.getElementById('noteTabContent').style.display = 'block';
                } else if (tabName === 'summary') {
                    document.getElementById('summaryTabContent').style.display = 'block';
                } else if (tabName === 'tasks') {
                    document.getElementById('tasksTabContent').style.display = 'block';
                    this.renderTasks();
                }
            }

            addTask(text = '') {
                if (!this.currentNote) return;
                if (!this.currentNote.tasks) this.currentNote.tasks = [];
                
                const task = {
                    id: 'task_' + Date.now(),
                    text: text || '',
                    completed: false,
                    createdAt: Date.now()
                };
                
                this.currentNote.tasks.push(task);
                this.saveData();
                this.renderTasks();
                
                // Focus the new task input
                setTimeout(() => {
                    const input = document.querySelector(`[data-task-id="${task.id}"] .task-title-input`);
                    if (input) input.focus();
                }, 0);
            }

            toggleTask(taskId) {
                if (!this.currentNote?.tasks) return;
                const task = this.currentNote.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    this.saveData();
                    this.renderTasks();
                }
            }

            updateTaskTitle(taskId, text) {
                if (!this.currentNote?.tasks) return;
                const task = this.currentNote.tasks.find(t => t.id === taskId);
                if (task) {
                    task.text = text;
                    this.saveData();
                }
            }

            deleteTask(taskId) {
                if (!this.currentNote?.tasks) return;
                this.currentNote.tasks = this.currentNote.tasks.filter(t => t.id !== taskId);
                this.saveData();
                this.renderTasks();
            }

            renderTasks() {
                const container = document.getElementById('tasksList');
                if (!this.currentNote) {
                    container.innerHTML = '';
                    return;
                }

                const tasks = this.currentNote.tasks || [];
                
                if (tasks.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = tasks.map(task => `
                    <div class="task-item" data-task-id="${task.id}" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border); margin-bottom: 8px;">
                        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}
                            >
                        <input type="text" class="task-title-input" value="${this.escapeHtml(task.text)}"
                            placeholder="Task..."
                            style="flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 14px; outline: none; text-decoration: ${task.completed ? 'line-through' : 'none'}; opacity: ${task.completed ? '0.6' : '1'}; padding: 0;">
                        <button class="task-delete" style="background: none; border: none; color: var(--text-tertiary); cursor: pointer; padding: 4px; opacity: 0; transition: opacity 0.2s;">
                            <i class="ph ph-trash"></i>
                        </button>
                    </div>
                `).join('');

                // Add event listeners
                container.querySelectorAll('.task-item').forEach(item => {
                    const taskId = item.dataset.taskId;
                    const checkbox = item.querySelector('.task-checkbox');
                    const titleInput = item.querySelector('.task-title-input');
                    const deleteBtn = item.querySelector('.task-delete');

                    checkbox.addEventListener('change', () => this.toggleTask(taskId));
                    titleInput.addEventListener('input', (e) => this.updateTaskTitle(taskId, e.target.value));
                    deleteBtn.addEventListener('click', () => this.deleteTask(taskId));

                    // Return key creates new task
                    titleInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.addTask();
                        }
                    });

                    // Show delete button on hover
                    item.addEventListener('mouseenter', () => deleteBtn.style.opacity = '1');
                    item.addEventListener('mouseleave', () => deleteBtn.style.opacity = '0');
                });
            }

            setupSelectionToolbar() {
                const toolbar = document.getElementById('selectionToolbar');
                const editor = document.getElementById('wysiwygEditor');
                let currentSelection = null;
                let currentRange = null;

                // Show toolbar on selection
                document.addEventListener('mouseup', (e) => {
                    setTimeout(() => {
                        const selection = window.getSelection();
                        const text = selection.toString().trim();

                        if (text.length > 0 && editor.contains(selection.anchorNode)) {
                            currentSelection = text;
                            currentRange = selection.getRangeAt(0).cloneRange();

                            // Get selection coordinates using getBoundingClientRect for viewport positioning
                            const rect = currentRange.getBoundingClientRect();
                            
                            // Make toolbar visible to get dimensions
                            toolbar.style.display = 'flex';
                            toolbar.style.visibility = 'hidden';
                            const toolbarRect = toolbar.getBoundingClientRect();
                            
                            // Calculate position - above the selection using viewport coordinates
                            let top = rect.top - toolbarRect.height - 8;
                            let left = rect.left;
                            
                            // If too close to top, show below selection
                            if (top < 0) {
                                top = rect.bottom + 8;
                            }
                            
                            // Keep within viewport horizontally
                            if (left + toolbarRect.width > window.innerWidth) {
                                left = window.innerWidth - toolbarRect.width - 16;
                            }
                            
                            // Apply fixed positioning
                            toolbar.style.position = 'fixed';
                            toolbar.style.top = top + 'px';
                            toolbar.style.left = left + 'px';
                            toolbar.style.visibility = 'visible';
                            toolbar.classList.add('visible');
                        } else {
                            toolbar.classList.remove('visible');
                            toolbar.style.display = 'none';
                        }
                    }, 0);
                });

                // Hide toolbar when clicking elsewhere
                document.addEventListener('mousedown', (e) => {
                    if (!toolbar.contains(e.target)) {
                        toolbar.classList.remove('visible');
                        toolbar.style.display = 'none';
                    }
                });

                // Formatting buttons
                toolbar.querySelectorAll('[data-command]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const command = btn.dataset.command;
                        const value = btn.dataset.value || null;
                        document.execCommand(command, false, value);
                        toolbar.classList.remove('visible');
                    });
                });

                // Link button
                document.getElementById('toolbarLinkBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const url = prompt('Enter URL:');
                    if (url) {
                        document.execCommand('createLink', false, url);
                    }
                    toolbar.classList.remove('visible');
                });

                // Image button
                document.getElementById('toolbarImageBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const url = prompt('Enter image URL:');
                    if (url) {
                        document.execCommand('insertImage', false, url);
                    }
                    toolbar.classList.remove('visible');
                });

                // Ask AI button
                document.getElementById('askAiSelectionBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toolbar.classList.remove('visible');
                    this.openAiSelectionModal(currentSelection, currentRange);
                });
            }

            openAiSelectionModal(selectedText, range) {
                const modal = document.getElementById('aiSelectionModal');
                document.getElementById('aiSelectedText').textContent = selectedText;
                document.getElementById('aiSuggestionResult').style.display = 'none';
                document.getElementById('aiLoadingState').style.display = 'none';

                // Store for later use
                this.currentAiRange = range;
                this.currentAiText = selectedText;

                modal.classList.add('active');

                // Close button
                document.getElementById('closeAiSelection').onclick = () => {
                    modal.classList.remove('active');
                };

                // AI action buttons
                document.querySelectorAll('.ai-action-btn').forEach(btn => {
                    btn.onclick = async () => {
                        const action = btn.dataset.action;
                        await this.processAiSelection(action);
                    };
                });

                // Accept/Discard buttons
                document.getElementById('acceptAiSuggestion').onclick = () => {
                    this.applyAiSuggestion();
                    modal.classList.remove('active');
                };

                document.getElementById('discardAiSuggestion').onclick = () => {
                    document.getElementById('aiSuggestionResult').style.display = 'none';
                };
            }

            simulateAiImprove(text) {
                // Simple simulation - in real app this would call an AI API
                return text.replace(/\b(good|nice|big)\b/g, (match) => {
                    const improvements = {
                        'good': 'excellent',
                        'nice': 'elegant',
                        'big': 'substantial'
                    };
                    return improvements[match] || match;
                }) + ' (improved with better vocabulary and flow)';
            }

            simulateAiGrammar(text) {
                return text.replace(/\s+/g, ' ').trim() + '.';
            }

            simulateAiShorter(text) {
                const sentences = text.split(/[.!?]+/).filter(s => s.trim());
                return sentences.slice(0, Math.max(1, Math.floor(sentences.length / 2))).join('. ') + '.';
            }

            simulateAiLonger(text) {
                return text + ' This expanded version provides additional context and detail to make the point more comprehensive and easier to understand for the reader.';
            }

            simulateAiSimplify(text) {
                return text.replace(/\b(utilize|implement|facilitate|subsequently)\b/gi, (match) => {
                    const simple = {
                        'utilize': 'use',
                        'implement': 'do',
                        'facilitate': 'help',
                        'subsequently': 'then'
                    };
                    return simple[match.toLowerCase()] || match;
                }) + ' (simplified)';
            }

            simulateAiProfessional(text) {
                return 'In accordance with established protocols, ' + text.toLowerCase() + ' This approach ensures compliance with industry standards and best practices.';
            }

            applyAiSuggestion() {
                if (!this.currentAiRange || !this.currentAiSuggestion) return;

                const editor = document.getElementById('wysiwygEditor');
                editor.focus();

                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(this.currentAiRange);

                document.execCommand('insertText', false, this.currentAiSuggestion);
                this.showToast('AI suggestion applied', 'success');
            }

            setupMobileGestures() {
                let touchStartX = 0;
                let touchEndX = 0;

                document.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                document.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    this.handleSwipe(touchStartX, touchEndX);
                }, { passive: true });
            }

            handleSwipe(startX, endX) {
                const threshold = 100;
                const diff = endX - startX;

                // Swipe right to open sidebar
                if (diff > threshold && startX < 50) {
                    document.getElementById('sidebar').classList.add('open');
                    document.getElementById('sidebarOverlay').classList.add('active');
                }

                // Swipe left to close sidebar
                if (diff < -threshold) {
                    document.getElementById('sidebar').classList.remove('open');
                    document.getElementById('sidebarOverlay').classList.remove('active');
                }
            }

            populateFolderSelect() {
                const select = document.getElementById('newNoteFolder');
                select.innerHTML = this.data.folders.map(f =>
                    `<option value="${f.id}">${this.escapeHtml(f.name)}</option>`
                ).join('');
                select.value = this.currentFolder;
            }

            // ==================== UTILITY FUNCTIONS ====================

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            stripHtml(html) {
                const tmp = document.createElement('div');
                tmp.innerHTML = html;
                return tmp.textContent || tmp.innerText || '';
            }

            htmlToMarkdown(html) {
                let md = html
                    .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n')
                    .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n')
                    .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n')
                    .replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n')
                    .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
                    .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
                    .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
                    .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
                    .replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`')
                    .replace(/<pre[^>]*>(.*?)<\/pre>/gis, '```\n$1\n```\n\n')
                    .replace(/<a[^>]*href=["']([^"']*)["'][^>]*>(.*?)<\/a>/gi, '[$2]($1)')
                    .replace(/<img[^>]*src=["']([^"']*)["'][^>]*>/gi, '![]($1)')
                    .replace(/<br\s*\/?>/gi, '\n')
                    .replace(/<[^>]+>/g, '');
                return md;
            }

            markdownToHtml(md) {
                let html = md
                    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/`(.+?)`/g, '<code>$1</code>')
                    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
                    .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img alt="$1" src="$2">')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');
                return '<p>' + html + '</p>';
            }

            // ==================== VERSION HISTORY ====================

            saveVersion(noteId) {
                const note = this.data.notes.find(n => n.id === noteId);
                if (!note) return;

                // Initialize versions array if not exists
                if (!note.versions) {
                    note.versions = [];
                }

                // Only save if content changed from last version
                const lastVersion = note.versions[note.versions.length - 1];
                if (lastVersion && lastVersion.content === note.content) {
                    return;
                }

                // Add new version
                note.versions.push({
                    id: 'version_' + Date.now(),
                    content: note.content,
                    title: note.title,
                    timestamp: Date.now()
                });

                // Keep only last 50 versions to prevent storage bloat
                if (note.versions.length > 50) {
                    note.versions = note.versions.slice(-50);
                }

                this.saveData();
            }

            openVersionHistory() {
                if (!this.currentNote) {
                    this.showToast('Open a note first', 'error');
                    return;
                }

                const panel = document.getElementById('versionHistoryPanel');
                const list = document.getElementById('versionHistoryList');
                const preview = document.getElementById('versionPreview');

                // Get versions
                const versions = this.currentNote.versions || [];

                if (versions.length === 0) {
                    list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No version history yet.<br>Versions are saved automatically when you edit.</div>';
                } else {
                    // Render versions (newest first)
                    list.innerHTML = [...versions].reverse().map((v, index) => {
                        const date = new Date(v.timestamp);
                        const isActive = false;
                        return `
                            <div class="version-item ${isActive ? 'active' : ''}" data-version-id="${v.id}" data-index="${versions.length - 1 - index}">
                                <div class="version-time">${date.toLocaleDateString()}  ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                                <div class="version-author">${v.title || 'Untitled'}</div>
                            </div>
                        `;
                    }).join('');

                    // Add click handlers
                    list.querySelectorAll('.version-item').forEach(item => {
                        item.addEventListener('click', () => {
                            // Remove active from all
                            list.querySelectorAll('.version-item').forEach(i => i.classList.remove('active'));
                            // Add active to clicked
                            item.classList.add('active');
                            // Show preview
                            const index = parseInt(item.dataset.index);
                            this.showVersionPreview(index);
                        });
                    });
                }

                preview.style.display = 'none';
                panel.classList.add('open');
            }

            showVersionPreview(index) {
                if (!this.currentNote || !this.currentNote.versions) return;

                const version = this.currentNote.versions[index];
                if (!version) return;

                const preview = document.getElementById('versionPreview');
                const content = document.getElementById('versionPreviewContent');

                // Render HTML content properly, or strip if plain text
                const previewContent = version.content.substring(0, 1000) + (version.content.length > 1000 ? '...' : '');
                content.innerHTML = previewContent;
                preview.style.display = 'block';

                // Store selected version index
                this.selectedVersionIndex = index;
            }

            restoreVersion() {
                if (!this.currentNote || !this.currentNote.versions || this.selectedVersionIndex === undefined) {
                    this.showToast('Select a version to restore', 'error');
                    return;
                }

                const version = this.currentNote.versions[this.selectedVersionIndex];
                if (!version) return;

                // Save current as version first (so we don't lose it)
                this.saveVersion(this.currentNote.id);

                // Restore the selected version
                this.currentNote.content = version.content;
                this.currentNote.title = version.title;
                this.currentNote.updatedAt = Date.now();

                this.saveData();

                // Reload the note
                this.loadNoteIntoEditor(this.currentNote);

                // Close panel
                document.getElementById('versionHistoryPanel').classList.remove('open');
                this.showToast('Version restored', 'success');
            }

            closeVersionHistory() {
                document.getElementById('versionHistoryPanel').classList.remove('open');
                this.selectedVersionIndex = undefined;
            }

            // ==================== IMPORT WIZARD ====================

            setupAiPanelListeners() {
                // Close panel
                document.getElementById('closeAiPanel')?.addEventListener('click', () => {
                    document.getElementById('aiPanelModal').classList.remove('active');
                });

                document.getElementById('closeAiPanelBtn')?.addEventListener('click', () => {
                    document.getElementById('aiPanelModal').classList.remove('active');
                });

                // Provider selection
                document.querySelectorAll('input[name="aiProvider"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        document.getElementById('webllmSection').style.display = e.target.value === 'webllm' ? 'block' : 'none';
                        document.getElementById('ollamaSection').style.display = e.target.value === 'ollama' ? 'block' : 'none';
                        document.getElementById('cloudSection').style.display = e.target.value === 'cloud' ? 'block' : 'none';
                    });
                });

                // Download WebLLM model
                document.getElementById('downloadWebllmModel')?.addEventListener('click', () => {
                    alert('In demo mode, AI features work with simulated responses. In production, this would download the 1.9GB model to your browser.');
                });

                // Test Ollama connection
                document.getElementById('testOllamaConnection')?.addEventListener('click', async () => {
                    const statusEl = document.getElementById('ollamaStatus');
                    statusEl.textContent = 'Testing connection...';
                    statusEl.style.color = 'var(--text-secondary)';
                    
                    const result = await this.testOllamaConnection();
                    
                    if (result.success) {
                        statusEl.textContent = ` Connected! ${result.models.length} models available.`;
                        statusEl.style.color = 'var(--success)';
                    } else {
                        statusEl.textContent = ' Not connected. Please install and start Ollama.';
                        statusEl.style.color = 'var(--danger)';
                    }
                });

                // Save settings
                document.getElementById('saveAiSettings')?.addEventListener('click', () => {
                    const provider = document.querySelector('input[name="aiProvider"]:checked')?.value || 'webllm';
                    this.data.settings.aiProvider = provider;
                    this.saveData();
                    document.getElementById('aiPanelModal').classList.remove('active');
                    alert('AI settings saved! AI features are ready to use in demo mode.');
                });
            }
            
            // ==================== AI METHODS ====================
            
            async testOllamaConnection() {
                try {
                    const response = await fetch(`${this.ollamaUrl}/api/tags`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.ollamaReady = true;
                        return { success: true, models: data.models || [] };
                    }
                    return { success: false, error: 'Could not connect to Ollama' };
                } catch (err) {
                    return { success: false, error: err.message };
                }
            }
            
            async generateWithOllama(prompt, systemPrompt = '') {
                if (!this.ollamaReady) {
                    const test = await this.testOllamaConnection();
                    if (!test.success) return { error: test.error };
                }
                
                const model = document.getElementById('ollamaModel')?.value || this.ollamaModel;
                
                try {
                    const response = await fetch(`${this.ollamaUrl}/api/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: model,
                            prompt: prompt,
                            system: systemPrompt,
                            stream: false
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return { success: true, text: data.response };
                    }
                    return { error: 'Generation failed' };
                } catch (err) {
                    return { error: err.message };
                }
            }
            
            async processAiSelection(action) {
                const loading = document.getElementById('aiLoadingState');
                const result = document.getElementById('aiSuggestionResult');
                const resultText = document.getElementById('aiSuggestionText');

                loading.style.display = 'block';
                result.style.display = 'none';

                const original = this.currentAiText;
                let suggestion = original;
                
                // Try Ollama first if connected
                if (this.ollamaReady) {
                    const prompts = {
                        improve: `Improve this text:\n\n${original}`,
                        grammar: `Fix grammar and spelling:\n\n${original}`,
                        shorter: `Make this shorter and more concise:\n\n${original}`,
                        longer: `Expand on this with more detail:\n\n${original}`,
                        simplify: `Simplify this for easier reading:\n\n${original}`,
                        professional: `Make this more professional:\n\n${original}`
                    };
                    
                    const aiResult = await this.generateWithOllama(prompts[action] || prompts.improve);
                    
                    if (aiResult.success) {
                        suggestion = aiResult.text;
                    } else {
                        // Fallback to simulation
                        suggestion = this.simulateAiAction(action, original);
                    }
                } else {
                    // Demo mode - use simulation
                    await new Promise(r => setTimeout(r, 800));
                    suggestion = this.simulateAiAction(action, original);
                }

                loading.style.display = 'none';
                result.style.display = 'block';
                resultText.textContent = suggestion;
                this.currentAiSuggestion = suggestion;
            }
            
            simulateAiAction(action, original) {
                switch(action) {
                    case 'improve': return this.simulateAiImprove(original);
                    case 'grammar': return this.simulateAiGrammar(original);
                    case 'shorter': return this.simulateAiShorter(original);
                    case 'longer': return this.simulateAiLonger(original);
                    case 'simplify': return this.simulateAiSimplify(original);
                    case 'professional': return this.simulateAiProfessional(original);
                    default: return original;
                }
            }
        }

        // ==================== INITIALIZE ====================

        const app = new KnowledgeBase();
    </script>
</body>
</html>